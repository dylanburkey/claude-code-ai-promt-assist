<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Semantic Prompt Workstation</title>

        <link rel="manifest" href="manifest.json" />
        <meta name="theme-color" content="#0a0a0f" />
        <link rel="icon" type="image/svg+xml" href="icon.svg" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap"
            rel="stylesheet"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <meta name="apple-mobile-web-app-title" content="PromptEngine" />
        <link rel="apple-touch-icon" href="icon.svg" />

        <style>
            :root {
                --bg-base: #0a0a0f;
                --bg-surface: #12121a;
                --bg-elevated: #1a1a24;
                --bg-hover: #22222e;
                --accent-primary: #6366f1;
                --accent-primary-hover: #818cf8;
                --accent-secondary: #22d3ee;
                --accent-success: #34d399;
                --accent-warning: #fbbf24;
                --accent-error: #ef4444;
                --text-primary: #f4f4f5;
                --text-secondary: #a1a1aa;
                --text-muted: #71717a;
                --border-subtle: #27272a;
                --border-default: #3f3f46;
                --font-display: "Space Grotesk", system-ui, sans-serif;
                --font-body: "IBM Plex Sans", system-ui, sans-serif;
                --font-mono: "IBM Plex Mono", "SF Mono", monospace;
                --header-height: 60px;
                --radius-sm: 6px;
                --radius-md: 8px;
                --radius-lg: 12px;
                --transition-fast: 150ms ease;
                --transition-normal: 200ms ease;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                -webkit-tap-highlight-color: transparent;
            }

            body {
                background: var(--bg-base);
                color: var(--text-primary);
                font-family: var(--font-body);
                font-size: 14px;
                line-height: 1.5;
                height: 100vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            header {
                background: var(--bg-surface);
                border-bottom: 1px solid var(--border-subtle);
                padding: 0 1.25rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                height: var(--header-height);
                flex-shrink: 0;
                z-index: 20;
            }

            .logo-section {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }
            h1 {
                font-family: var(--font-display);
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--text-primary);
                letter-spacing: -0.02em;
            }
            .version-badge {
                font-size: 0.65rem;
                font-weight: 600;
                color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.15);
                padding: 0.2rem 0.5rem;
                border-radius: var(--radius-sm);
            }
            .header-actions {
                display: flex;
                gap: 0.5rem;
            }

            .workspace {
                display: grid;
                grid-template-columns: 280px 1fr 1fr;
                height: calc(100vh - var(--header-height));
                overflow: hidden;
            }

            @media (max-width: 768px) {
                .workspace {
                    grid-template-columns: 1fr;
                    display: flex;
                    flex-direction: column;
                }
                #sidebar-panel {
                    display: none;
                    position: fixed;
                    top: var(--header-height);
                    left: 0;
                    width: 85%;
                    max-width: 320px;
                    height: calc(100% - var(--header-height));
                    z-index: 50;
                    background: var(--bg-base);
                    border-right: 1px solid var(--border-default);
                    box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
                }
                #sidebar-panel.mobile-open {
                    display: flex;
                }
                .mobile-tabs {
                    display: flex;
                    background: var(--bg-surface);
                    border-top: 1px solid var(--border-subtle);
                }
                .mobile-tab {
                    flex: 1;
                    text-align: center;
                    padding: 0.875rem;
                    color: var(--text-muted);
                    font-weight: 500;
                    font-size: 0.8rem;
                    cursor: pointer;
                    transition: var(--transition-fast);
                }
                .mobile-tab.active {
                    color: var(--accent-primary);
                    background: rgba(99, 102, 241, 0.08);
                }
                .panel {
                    display: none;
                }
                .panel.active-view {
                    display: flex;
                }
            }

            @media (min-width: 769px) {
                .panel {
                    display: flex;
                }
                .mobile-tabs,
                .menu-toggle {
                    display: none;
                }
            }

            .panel {
                padding: 1.5rem;
                overflow-y: auto;
                border-right: 1px solid var(--border-subtle);
                display: flex;
                flex-direction: column;
                gap: 1rem;
                background: var(--bg-base);
            }
            .panel:last-child {
                border-right: none;
            }

            /* Collapsible Section */
            .collapsible-section {
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-md);
                overflow: hidden;
            }
            .collapsible-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 1rem;
                background: var(--bg-surface);
                cursor: pointer;
                user-select: none;
                transition: var(--transition-fast);
            }
            .collapsible-header:hover {
                background: var(--bg-elevated);
            }
            .collapsible-title {
                font-family: var(--font-display);
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                color: var(--text-muted);
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .collapsible-title .count {
                background: var(--accent-primary);
                color: white;
                font-size: 0.65rem;
                padding: 0.1rem 0.4rem;
                border-radius: 10px;
            }
            .collapsible-actions {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .chevron {
                transition: transform var(--transition-fast);
                color: var(--text-muted);
            }
            .collapsible-section.collapsed .chevron {
                transform: rotate(-90deg);
            }
            .collapsible-content {
                max-height: 400px;
                overflow-y: auto;
                transition: max-height 0.3s ease;
            }
            .collapsible-section.collapsed .collapsible-content {
                max-height: 0;
                overflow: hidden;
            }
            .collapsible-list {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
                padding: 0.5rem;
            }

            /* Cards */
            .item-card {
                background: var(--bg-base);
                padding: 0.75rem;
                border-radius: var(--radius-sm);
                border: 1px solid transparent;
                cursor: pointer;
                transition: var(--transition-fast);
            }
            .item-card:hover {
                background: var(--bg-elevated);
                border-color: var(--border-default);
            }
            .item-card.active {
                background: rgba(99, 102, 241, 0.1);
                border-color: var(--accent-primary);
            }
            .item-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.25rem;
            }
            .item-name {
                font-family: var(--font-display);
                font-weight: 600;
                font-size: 0.85rem;
                color: var(--text-primary);
            }
            .item-preview {
                font-size: 0.75rem;
                color: var(--text-muted);
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                line-height: 1.4;
            }

            /* Selection Tag */
            .selection-tag {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                padding: 0.625rem 0.875rem;
                border-radius: var(--radius-md);
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.85rem;
            }
            .selection-tag.has-selection {
                background: rgba(99, 102, 241, 0.08);
                border-color: rgba(99, 102, 241, 0.3);
            }
            .selection-tag-name {
                font-family: var(--font-display);
                font-weight: 600;
            }
            .selection-tag-status {
                font-size: 0.65rem;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            .selection-tag-actions {
                display: flex;
                gap: 0.25rem;
            }

            /* Form Elements */
            label {
                font-size: 0.8rem;
                font-weight: 500;
                color: var(--text-secondary);
                margin-bottom: 0.5rem;
                display: block;
            }
            .input-group {
                display: flex;
                flex-direction: column;
            }
            input,
            textarea,
            select {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                color: var(--text-primary);
                padding: 0.75rem 1rem;
                border-radius: var(--radius-md);
                width: 100%;
                font-family: var(--font-body);
                font-size: 0.875rem;
                transition: var(--transition-fast);
            }
            input::placeholder,
            textarea::placeholder {
                color: var(--text-muted);
            }
            input:focus,
            textarea:focus {
                outline: none;
                border-color: var(--accent-primary);
                background: var(--bg-elevated);
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            }
            textarea {
                resize: vertical;
                min-height: 80px;
            }

            /* Buttons */
            button {
                cursor: pointer;
                border: none;
                border-radius: var(--radius-md);
                padding: 0.625rem 1rem;
                font-family: var(--font-body);
                font-size: 0.8rem;
                font-weight: 500;
                transition: var(--transition-fast);
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .btn-primary {
                background: var(--accent-primary);
                color: white;
            }
            .btn-primary:hover:not(:disabled) {
                background: var(--accent-primary-hover);
                transform: translateY(-1px);
            }
            .btn-secondary {
                background: transparent;
                color: var(--text-secondary);
                border: 1px solid var(--border-default);
            }
            .btn-secondary:hover:not(:disabled) {
                border-color: var(--text-muted);
                color: var(--text-primary);
                background: var(--bg-hover);
            }
            .btn-ghost {
                background: transparent;
                color: var(--text-muted);
                padding: 0.25rem;
            }
            .btn-ghost:hover {
                color: var(--text-primary);
                background: var(--bg-hover);
            }
            .btn-icon {
                padding: 0.5rem;
                width: 36px;
                height: 36px;
            }
            .btn-sm {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }
            .btn-xs {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }

            /* Output Area */
            .output-area {
                background: var(--bg-surface);
                padding: 1.25rem;
                font-family: var(--font-mono);
                font-size: 0.8rem;
                line-height: 1.7;
                color: var(--accent-success);
                white-space: pre-wrap;
                flex: 1;
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-md);
                overflow-y: auto;
            }
            .output-placeholder {
                color: var(--text-muted);
            }

            /* Install Banner */
            #install-prompt {
                display: none;
                background: linear-gradient(
                    90deg,
                    var(--accent-primary),
                    #8b5cf6
                );
                color: white;
                padding: 0.75rem 1rem;
                text-align: center;
                font-weight: 500;
                font-size: 0.85rem;
                cursor: pointer;
            }
            #install-prompt:hover {
                filter: brightness(1.1);
            }

            /* Modal */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(4px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 100;
                opacity: 0;
                pointer-events: none;
                transition: opacity var(--transition-normal);
                padding: 1rem;
            }
            .modal-overlay.open {
                opacity: 1;
                pointer-events: all;
            }
            .modal {
                background: var(--bg-surface);
                padding: 1.75rem;
                border-radius: var(--radius-lg);
                width: 100%;
                max-width: 500px;
                border: 1px solid var(--border-default);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                display: flex;
                flex-direction: column;
                gap: 1.25rem;
                max-height: 90vh;
                overflow-y: auto;
            }
            .modal h2 {
                font-family: var(--font-display);
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--text-primary);
            }
            .modal-actions {
                display: flex;
                gap: 0.75rem;
                margin-top: 0.5rem;
                justify-content: flex-end;
            }

            .hidden-input {
                display: none;
            }

            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            ::-webkit-scrollbar-track {
                background: transparent;
            }
            ::-webkit-scrollbar-thumb {
                background: var(--border-default);
                border-radius: 3px;
            }
            ::-webkit-scrollbar-thumb:hover {
                background: var(--text-muted);
            }

            .close-sidebar-btn {
                margin-top: auto;
            }

            /* Loading & Toast */
            .loading-spinner {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid var(--border-default);
                border-top-color: var(--accent-primary);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }
            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .toast {
                position: fixed;
                bottom: 2rem;
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                background: var(--bg-elevated);
                border: 1px solid var(--border-default);
                padding: 1rem 1.25rem;
                border-radius: var(--radius-md);
                font-size: 0.85rem;
                z-index: 200;
                opacity: 0;
                transition: all 0.3s ease;
                max-width: 400px;
                min-width: 300px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            }
            .toast.show {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            .toast.success {
                border-color: var(--accent-success);
                color: var(--accent-success);
            }
            .toast.error {
                border-color: var(--accent-error);
                color: var(--accent-error);
            }
            .toast.warning {
                border-color: var(--accent-warning);
                color: var(--accent-warning);
            }
            .toast.info {
                border-color: var(--accent-primary);
                color: var(--accent-primary);
            }

            .toast-message {
                margin-bottom: 0.5rem;
                font-weight: 500;
            }

            .toast-options {
                margin-top: 0.75rem;
                padding-top: 0.75rem;
                border-top: 1px solid var(--border-subtle);
            }

            .toast-options-title {
                font-size: 0.75rem;
                font-weight: 600;
                margin-bottom: 0.5rem;
                opacity: 0.8;
            }

            .toast-option {
                font-size: 0.75rem;
                margin: 0.25rem 0;
                opacity: 0.9;
                line-height: 1.4;
            }

            .toast-details-btn,
            .toast-dismiss-btn {
                background: transparent;
                border: 1px solid currentColor;
                color: inherit;
                padding: 0.25rem 0.5rem;
                border-radius: var(--radius-sm);
                font-size: 0.7rem;
                margin-top: 0.5rem;
                margin-right: 0.5rem;
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .toast-details-btn:hover,
            .toast-dismiss-btn:hover {
                background: currentColor;
                color: var(--bg-elevated);
            }

            .toast-dismiss-btn {
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;
                width: 24px;
                height: 24px;
                padding: 0;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1rem;
                line-height: 1;
                margin: 0;
            }

            .error-details {
                max-height: 400px;
                overflow-y: auto;
            }

            .error-field {
                margin-bottom: 1rem;
            }

            .error-field strong {
                display: block;
                margin-bottom: 0.25rem;
                color: var(--text-primary);
            }

            .error-field div,
            .error-field pre {
                background: var(--bg-surface);
                padding: 0.5rem;
                border-radius: var(--radius-sm);
                border: 1px solid var(--border-subtle);
                font-size: 0.8rem;
                color: var(--text-secondary);
            }

            .error-field pre {
                font-family: var(--font-mono);
                white-space: pre-wrap;
                word-break: break-word;
            }

            .empty-state {
                text-align: center;
                padding: 1.5rem;
                color: var(--text-muted);
                font-size: 0.8rem;
            }

            .sync-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: var(--accent-success);
                margin-left: 0.5rem;
            }
            .sync-indicator.syncing {
                background: var(--accent-warning);
                animation: pulse 1s infinite;
            }
            .sync-indicator.error {
                background: var(--accent-error);
            }
            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            /* Header Navigation */
            .header-nav {
                display: flex;
                gap: 0.25rem;
            }

            .nav-link {
                padding: 0.5rem 1rem;
                color: var(--text-muted);
                text-decoration: none;
                font-weight: 500;
                font-size: 0.875rem;
                border-radius: var(--radius-md);
                transition: var(--transition-fast);
            }

            .nav-link:hover {
                color: var(--text-primary);
                background: var(--bg-hover);
            }

            .nav-link.active {
                color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.1);
            }

            /* Project Selector */
            .project-selector {
                margin-right: 0.5rem;
            }

            .project-selector select {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                color: var(--text-primary);
                padding: 0.5rem 0.75rem;
                border-radius: var(--radius-md);
                font-family: var(--font-body);
                font-size: 0.8rem;
                min-width: 180px;
                cursor: pointer;
            }

            .project-selector select:focus {
                outline: none;
                border-color: var(--accent-primary);
            }

            /* Progress Indicators */
            .progress-container {
                background: var(--bg-surface);
                border-radius: var(--radius-md);
                padding: 1rem;
                margin: 1rem 0;
                border: 1px solid var(--border-subtle);
            }

            .progress-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
            }

            .progress-title {
                font-weight: 600;
                color: var(--text-primary);
            }

            .progress-status {
                font-size: 0.8rem;
                color: var(--text-muted);
            }

            .progress-bar {
                width: 100%;
                height: 8px;
                background: var(--bg-elevated);
                border-radius: 4px;
                overflow: hidden;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
                transition: width 0.3s ease;
                border-radius: 4px;
            }

            .progress-steps {
                display: flex;
                gap: 0.5rem;
                margin-top: 0.75rem;
                flex-wrap: wrap;
            }

            .progress-step {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
                border-radius: var(--radius-sm);
                background: var(--bg-elevated);
                color: var(--text-muted);
            }

            .progress-step.completed {
                background: rgba(52, 211, 153, 0.15);
                color: var(--accent-success);
            }

            .progress-step.active {
                background: rgba(99, 102, 241, 0.15);
                color: var(--accent-primary);
            }

            .panel-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid var(--border-subtle);
            }
            .panel-title {
                font-family: var(--font-display);
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                color: var(--text-muted);
            }

            /* Resource Assignment */
            .resource-assignment {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-md);
                padding: 1rem;
                margin: 0.5rem 0;
            }

            .resource-assignment-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.75rem;
            }

            .resource-type {
                font-size: 0.7rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
                color: var(--text-muted);
                background: var(--bg-elevated);
                padding: 0.2rem 0.5rem;
                border-radius: var(--radius-sm);
            }

            .resource-actions {
                display: flex;
                gap: 0.25rem;
            }

            /* AI Enhancement Indicators */
            .ai-enhanced {
                position: relative;
            }

            .ai-enhanced::after {
                content: "âœ¨";
                position: absolute;
                top: -2px;
                right: -2px;
                font-size: 0.7rem;
                opacity: 0.7;
            }

            .ai-suggestion {
                background: rgba(99, 102, 241, 0.05);
                border: 1px solid rgba(99, 102, 241, 0.2);
                border-radius: var(--radius-md);
                padding: 0.75rem;
                margin: 0.5rem 0;
                font-size: 0.85rem;
                color: var(--text-secondary);
            }

            .ai-suggestion-header {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                margin-bottom: 0.5rem;
                font-weight: 500;
                color: var(--accent-primary);
            }

            @media (max-width: 768px) {
                .header-nav {
                    display: none;
                }
                
                .project-selector {
                    margin-right: 0;
                }
                
                .project-selector select {
                    min-width: 120px;
                    font-size: 0.75rem;
                }
            }
        </style>
    </head>
    <body>
        <div id="install-prompt" onclick="installPWA()">
            Install Semantic Prompt Workstation
        </div>

        <header>
            <div class="logo-section">
                <button
                    class="btn-secondary btn-icon menu-toggle"
                    onclick="toggleSidebar()"
                    aria-label="Toggle menu"
                >
                    <svg
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M3 12h18M3 6h18M3 18h18" />
                    </svg>
                </button>
                <h1>Semantic Prompt Workstation</h1>
                <span class="version-badge">v3.0</span>
                <div
                    id="sync-indicator"
                    class="sync-indicator"
                    title="Synced with cloud"
                ></div>
            </div>
            <nav class="header-nav">
                <a href="/" class="nav-link active">Prompt Builder</a>
                <a href="/projects" class="nav-link">Projects</a>
                <a href="/rules" class="nav-link">Rules</a>
                <a href="/hooks" class="nav-link">Hooks</a>
                <a href="/agents" class="nav-link">Agents</a>
            </nav>
            <div class="header-actions">
                <div class="project-selector" id="project-selector">
                    <select id="current-project-select" onchange="switchProject(this.value)">
                        <option value="">No Project Selected</option>
                    </select>
                </div>
                <button
                    class="btn-secondary btn-icon"
                    onclick="document.getElementById('file-upload').click()"
                    title="Import"
                >
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                </button>
                <input
                    type="file"
                    id="file-upload"
                    class="hidden-input"
                    accept=".json"
                    onchange="importData(this)"
                />
                <button
                    class="btn-secondary btn-icon"
                    onclick="exportProject()"
                    title="Export Project"
                >
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="workspace">
            <!-- SIDEBAR -->
            <aside class="panel" id="sidebar-panel">
                <!-- Project Context Section -->
                <div class="collapsible-section" id="project-context-section">
                    <div
                        class="collapsible-header"
                        onclick="toggleSection('project-context-section')"
                    >
                        <span class="collapsible-title">
                            <svg
                                width="14"
                                height="14"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            </svg>
                            Project Context
                        </span>
                        <div class="collapsible-actions">
                            <button
                                class="btn-ghost btn-xs"
                                onclick="
                                    event.stopPropagation();
                                    openResourceImportModal();
                                "
                                title="Import Resources"
                            >
                                <svg
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="17 8 12 3 7 8" />
                                    <line x1="12" y1="3" x2="12" y2="15" />
                                </svg>
                            </button>
                            <svg
                                class="chevron"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <polyline points="6 9 12 15 18 9" />
                            </svg>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div id="project-context-display" class="collapsible-list">
                            <div class="empty-state">Select a project to see context</div>
                        </div>
                    </div>
                </div>

                <!-- Project Agents Section -->
                <div class="collapsible-section" id="project-agents-section">
                    <div
                        class="collapsible-header"
                        onclick="toggleSection('project-agents-section')"
                    >
                        <span class="collapsible-title">
                            <svg
                                width="14"
                                height="14"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
                                />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                            Project Agents
                            <span class="count" id="project-agents-count">0</span>
                        </span>
                        <div class="collapsible-actions">
                            <button
                                class="btn-ghost btn-xs"
                                onclick="
                                    event.stopPropagation();
                                    openAgentModal();
                                "
                                title="New Agent"
                            >
                                <svg
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <line x1="12" y1="5" x2="12" y2="19" />
                                    <line x1="5" y1="12" x2="19" y2="12" />
                                </svg>
                            </button>
                            <svg
                                class="chevron"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <polyline points="6 9 12 15 18 9" />
                            </svg>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div id="project-agent-list" class="collapsible-list">
                            <div class="empty-state">No agents assigned to project</div>
                        </div>
                    </div>
                </div>

                <!-- All Agents Section -->
                <div class="collapsible-section collapsed" id="agents-section">
                    <div
                        class="collapsible-header"
                        onclick="toggleSection('agents-section')"
                    >
                        <span class="collapsible-title">
                            <svg
                                width="14"
                                height="14"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"
                                />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                            All Agents
                            <span class="count" id="agents-count">0</span>
                        </span>
                        <div class="collapsible-actions">
                            <button
                                class="btn-ghost btn-xs"
                                onclick="
                                    event.stopPropagation();
                                    openAgentModal();
                                "
                                title="New Agent"
                            >
                                <svg
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <line x1="12" y1="5" x2="12" y2="19" />
                                    <line x1="5" y1="12" x2="19" y2="12" />
                                </svg>
                            </button>
                            <svg
                                class="chevron"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <polyline points="6 9 12 15 18 9" />
                            </svg>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div id="agent-list" class="collapsible-list">
                            <div class="empty-state">Loading agents...</div>
                        </div>
                    </div>
                </div>

                <!-- Output Requirements Section -->
                <div class="collapsible-section collapsed" id="requirements-section">
                    <div
                        class="collapsible-header"
                        onclick="toggleSection('requirements-section')"
                    >
                        <span class="collapsible-title">
                            <svg
                                width="14"
                                height="14"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path
                                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                                />
                                <polyline points="14 2 14 8 20 8" />
                                <line x1="16" y1="13" x2="8" y2="13" />
                                <line x1="16" y1="17" x2="8" y2="17" />
                            </svg>
                            Output Requirements
                            <span class="count" id="requirements-count">0</span>
                        </span>
                        <div class="collapsible-actions">
                            <button
                                class="btn-ghost btn-xs"
                                onclick="
                                    event.stopPropagation();
                                    openRequirementModal();
                                "
                                title="New Requirement"
                            >
                                <svg
                                    width="14"
                                    height="14"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <line x1="12" y1="5" x2="12" y2="19" />
                                    <line x1="5" y1="12" x2="19" y2="12" />
                                </svg>
                            </button>
                            <svg
                                class="chevron"
                                width="16"
                                height="16"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <polyline points="6 9 12 15 18 9" />
                            </svg>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div id="requirement-list" class="collapsible-list">
                            <div class="empty-state">
                                Loading requirements...
                            </div>
                        </div>
                    </div>
                </div>

                <button
                    class="btn-secondary close-sidebar-btn menu-toggle"
                    onclick="toggleSidebar()"
                >
                    Close Menu
                </button>
            </aside>

            <!-- BUILDER -->
            <section class="panel active-view" id="view-builder">
                <div class="panel-header">
                    <span class="panel-title">Prompt Builder</span>
                    <div class="header-actions">
                        <button
                            class="btn-ghost btn-xs ai-enhanced"
                            onclick="getAISuggestions()"
                            title="Get AI Suggestions"
                            id="ai-suggest-btn"
                        >
                            <svg
                                width="14"
                                height="14"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Project Context Display -->
                <div id="project-context-banner" class="progress-container" style="display: none;">
                    <div class="progress-header">
                        <span class="progress-title">Project Context Active</span>
                        <span class="progress-status" id="project-context-status">No project selected</span>
                    </div>
                    <div id="project-context-summary" class="ai-suggestion" style="margin: 0;">
                        <div class="ai-suggestion-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                            </svg>
                            Project Context
                        </div>
                        <div id="project-context-text">Select a project to see context information</div>
                    </div>
                </div>

                <!-- AI Suggestions Display -->
                <div id="ai-suggestions-container" style="display: none;">
                    <div class="ai-suggestion">
                        <div class="ai-suggestion-header">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
                            </svg>
                            AI Suggestions
                        </div>
                        <div id="ai-suggestions-content">Click the AI button to get contextual suggestions</div>
                    </div>
                </div>

                <div class="input-group">
                    <label>Selected Agent</label>
                    <div id="current-agent-display" class="selection-tag">
                        <span class="selection-tag-name"
                            >No agent selected</span
                        >
                        <span class="selection-tag-status"
                            >Select from sidebar</span
                        >
                    </div>
                </div>

                <div class="input-group">
                    <label for="task">Task Description</label>
                    <textarea
                        id="task"
                        rows="4"
                        placeholder="Describe what you want the AI to do. Be specific about the desired outcome..."
                    ></textarea>
                </div>

                <div class="input-group">
                    <label for="context">Context & Constraints</label>
                    <textarea
                        id="context"
                        rows="3"
                        placeholder="Add relevant background information, limitations, or specific requirements..."
                    ></textarea>
                </div>

                <div class="input-group">
                    <label for="format">Output Format</label>
                    <input
                        type="text"
                        id="format"
                        placeholder="e.g., Markdown, JSON, bullet points, executive summary..."
                    />
                </div>

                <div class="input-group">
                    <label>Output Requirements</label>
                    <div
                        id="current-requirement-display"
                        class="selection-tag"
                        style="margin-bottom: 0.5rem"
                    >
                        <span class="selection-tag-name"
                            >No template selected</span
                        >
                        <div class="selection-tag-actions">
                            <button
                                class="btn-ghost btn-xs"
                                id="clear-requirement-btn"
                                onclick="clearSelectedRequirement()"
                                title="Clear"
                                style="display: none"
                            >
                                <svg
                                    width="12"
                                    height="12"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                >
                                    <line x1="18" y1="6" x2="6" y2="18" />
                                    <line x1="6" y1="6" x2="18" y2="18" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <textarea
                        id="output-requirements"
                        rows="4"
                        placeholder="Specify detailed requirements for the output, or select a saved template from the sidebar..."
                    ></textarea>
                </div>

                <div class="input-group" style="flex-direction: row; gap: 0.75rem;">
                    <button
                        class="btn-primary"
                        style="flex: 1"
                        onclick="generatePrompt()"
                    >
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <polygon
                                points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                            />
                        </svg>
                        Generate Prompt
                    </button>
                    <button
                        class="btn-secondary"
                        onclick="savePromptToProject()"
                        id="save-prompt-btn"
                        style="display: none"
                    >
                        <svg
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17 21 17 13 7 13 7 21"/>
                            <polyline points="7 3 7 8 15 8"/>
                        </svg>
                        Save to Project
                    </button>
                </div>
            </section>

            <!-- OUTPUT -->
            <section class="panel" id="view-output">
                <div class="panel-header">
                    <span class="panel-title">Generated Output</span>
                    <div class="header-actions">
                        <button
                            class="btn-secondary btn-sm"
                            onclick="copyToClipboard()"
                        >
                            <svg
                                width="14"
                                height="14"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <rect
                                    x="9"
                                    y="9"
                                    width="13"
                                    height="13"
                                    rx="2"
                                    ry="2"
                                />
                                <path
                                    d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                                />
                            </svg>
                            Copy
                        </button>
                        <button
                            class="btn-secondary btn-sm"
                            onclick="openExportModal()"
                            id="export-btn"
                            style="display: none"
                        >
                            <svg
                                width="14"
                                height="14"
                                viewBox="0 0 24 24"
                                fill="none"
                                stroke="currentColor"
                                stroke-width="2"
                            >
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="7 10 12 15 17 10" />
                                <line x1="12" y1="15" x2="12" y2="3" />
                            </svg>
                            Export
                        </button>
                    </div>
                </div>
                <div id="output-display" class="output-area">
                    <span class="output-placeholder"
                        >Generated prompt will appear here...</span
                    >
                </div>
                
                <!-- Export Progress -->
                <div id="export-progress" class="progress-container" style="display: none;">
                    <div class="progress-header">
                        <span class="progress-title">Export Progress</span>
                        <span class="progress-status" id="export-status">Preparing...</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="export-progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="progress-steps" id="export-steps">
                        <span class="progress-step active">Validating</span>
                        <span class="progress-step">Generating Files</span>
                        <span class="progress-step">Packaging</span>
                        <span class="progress-step">Complete</span>
                    </div>
                </div>
            </section>
        </div>

        <div class="mobile-tabs">
            <div class="mobile-tab active" onclick="switchView('builder')">
                Builder
            </div>
            <div class="mobile-tab" onclick="switchView('output')">Output</div>
        </div>

        <!-- Agent Modal -->
        <div id="agent-modal" class="modal-overlay">
            <div class="modal">
                <h2 id="agent-modal-title">Create New Agent</h2>
                <input type="hidden" id="agent-id" />
                <div class="input-group">
                    <label for="agent-name">Agent Name</label>
                    <input
                        type="text"
                        id="agent-name"
                        placeholder="e.g., Senior Software Engineer"
                    />
                </div>
                <div class="input-group">
                    <label for="agent-role">System Persona</label>
                    <textarea
                        id="agent-role"
                        rows="4"
                        placeholder="Define the agent's expertise, background, and approach to tasks..."
                    ></textarea>
                </div>
                <div class="input-group">
                    <label for="agent-style">Response Style</label>
                    <input
                        type="text"
                        id="agent-style"
                        placeholder="e.g., Technical, concise, with code examples"
                    />
                </div>
                <div class="modal-actions">
                    <button
                        class="btn-secondary"
                        id="btn-delete-agent"
                        onclick="deleteAgent()"
                        style="
                            margin-right: auto;
                            color: #ef4444;
                            border-color: #ef4444;
                        "
                    >
                        Delete
                    </button>
                    <button class="btn-secondary" onclick="closeAgentModal()">
                        Cancel
                    </button>
                    <button
                        class="btn-primary"
                        id="btn-save-agent"
                        onclick="saveAgent()"
                    >
                        Save Agent
                    </button>
                </div>
            </div>
        </div>

        <!-- Output Requirement Modal -->
        <div id="requirement-modal" class="modal-overlay">
            <div class="modal">
                <h2 id="requirement-modal-title">Create Output Requirement</h2>
                <input type="hidden" id="requirement-id" />
                <div class="input-group">
                    <label for="requirement-name">Name</label>
                    <input
                        type="text"
                        id="requirement-name"
                        placeholder="e.g., Production-Ready Code"
                    />
                </div>
                <div class="input-group">
                    <label for="requirement-description"
                        >Description (optional)</label
                    >
                    <input
                        type="text"
                        id="requirement-description"
                        placeholder="Brief description of when to use this"
                    />
                </div>
                <div class="input-group">
                    <label for="requirement-content"
                        >Requirements Content</label
                    >
                    <textarea
                        id="requirement-content"
                        rows="6"
                        placeholder="Define the detailed output requirements..."
                    ></textarea>
                </div>
                <div class="modal-actions">
                    <button
                        class="btn-secondary"
                        id="btn-delete-requirement"
                        onclick="deleteRequirement()"
                        style="
                            margin-right: auto;
                            color: #ef4444;
                            border-color: #ef4444;
                        "
                    >
                        Delete
                    </button>
                    <button
                        class="btn-secondary"
                        onclick="closeRequirementModal()"
                    >
                        Cancel
                    </button>
                    <button
                        class="btn-primary"
                        id="btn-save-requirement"
                        onclick="saveRequirement()"
                    >
                        Save Requirement
                    </button>
                </div>
            </div>
        </div>

        <!-- Resource Import Modal -->
        <div id="resource-import-modal" class="modal-overlay">
            <div class="modal">
                <h2>Import Resources to Project</h2>
                <div class="input-group">
                    <label>Available Resources</label>
                    <div id="available-resources-list" style="max-height: 300px; overflow-y: auto;">
                        <div class="empty-state">Loading available resources...</div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeResourceImportModal()">
                        Cancel
                    </button>
                    <button
                        class="btn-primary"
                        id="btn-import-resources"
                        onclick="importSelectedResources()"
                    >
                        Import Selected
                    </button>
                </div>
            </div>
        </div>

        <!-- Export Configuration Modal -->
        <div id="export-modal" class="modal-overlay">
            <div class="modal">
                <h2>Export Project Configuration</h2>
                <div class="input-group">
                    <label>Export Format</label>
                    <select id="export-format">
                        <option value="claude-code">Claude Code Project</option>
                        <option value="json">JSON Configuration</option>
                        <option value="zip">Complete Package (ZIP)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Include Components</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                            <input type="checkbox" id="include-agents" checked>
                            <span>Agents</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                            <input type="checkbox" id="include-rules" checked>
                            <span>Rules</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                            <input type="checkbox" id="include-hooks" checked>
                            <span>Hooks</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                            <input type="checkbox" id="include-prompts" checked>
                            <span>Saved Prompts</span>
                        </label>
                    </div>
                </div>
                <div class="input-group">
                    <label for="export-filename">Filename</label>
                    <input
                        type="text"
                        id="export-filename"
                        placeholder="project-export"
                    />
                </div>
                <div class="modal-actions">
                    <button class="btn-secondary" onclick="closeExportModal()">
                        Cancel
                    </button>
                    <button
                        class="btn-primary"
                        id="btn-export-project"
                        onclick="executeExport()"
                    >
                        Export Project
                    </button>
                </div>
            </div>
        </div>

        <div id="toast" class="toast"></div>

        <script>
            const API_BASE = "/api";
            let agents = [];
            let outputRequirements = [];
            let projects = [];
            let projectResources = [];
            let availableResources = [];
            let selectedAgentId = null;
            let selectedRequirementId = null;
            let currentProjectId = null;
            let currentProjectContext = null;
            let lastGeneratedPrompt = null;

            // ============================================
            // API CLIENT
            // ============================================
            async function api(endpoint, options = {}) {
                const config = {
                    headers: { "Content-Type": "application/json" },
                    ...options,
                };
                if (options.body && typeof options.body === "object")
                    config.body = JSON.stringify(options.body);
                setSyncStatus("syncing");
                try {
                    const response = await fetch(
                        `${API_BASE}${endpoint}`,
                        config,
                    );
                    
                    let data;
                    try {
                        data = await response.json();
                    } catch (parseError) {
                        // Handle non-JSON responses
                        const text = await response.text();
                        throw new APIError(
                            response.ok ? "Invalid response format" : `Server error: ${response.status}`,
                            response.status,
                            'INVALID_RESPONSE',
                            { responseText: text }
                        );
                    }
                    
                    if (!response.ok) {
                        // Create enhanced error with better user messages
                        const errorMessage = data.error?.message || data.error || data.message || "Request failed";
                        const errorCode = data.error?.code || 'API_ERROR';
                        const errorDetails = data.error?.details || {};
                        
                        throw new APIError(errorMessage, response.status, errorCode, errorDetails);
                    }
                    
                    setSyncStatus("synced");
                    return data;
                } catch (error) {
                    setSyncStatus("error");
                    
                    // Handle network errors
                    if (error instanceof TypeError || error.message.includes('fetch')) {
                        throw new NetworkError("Unable to connect to server. Please check your internet connection.");
                    }
                    
                    // Re-throw API errors as-is
                    if (error instanceof APIError) {
                        throw error;
                    }
                    
                    // Handle other errors
                    throw new APIError(error.message || "An unexpected error occurred", 0, 'UNKNOWN_ERROR');
                }
            }

            // Enhanced Error Classes
            class APIError extends Error {
                constructor(message, status = 0, code = 'API_ERROR', details = {}) {
                    super(message);
                    this.name = 'APIError';
                    this.status = status;
                    this.code = code;
                    this.details = details;
                    this.userMessage = this.getUserFriendlyMessage();
                    this.recoveryOptions = this.getRecoveryOptions();
                }

                getUserFriendlyMessage() {
                    // Handle specific error codes with user-friendly messages
                    switch (this.code) {
                        case 'VALIDATION_ERROR':
                            return "Please check your input and try again.";
                        case 'RESOURCE_NOT_FOUND':
                            return "The requested item could not be found. It may have been deleted or moved.";
                        case 'DUPLICATE_RESOURCE':
                            return "An item with this name already exists. Please choose a different name.";
                        case 'MISSING_REQUIRED_FIELD':
                            return "Please fill in all required fields.";
                        case 'INVALID_REFERENCE':
                            return "The referenced item is no longer available.";
                        case 'CONFLICT_ERROR':
                            return "This action conflicts with existing data. Please review and try again.";
                        case 'TRANSACTION_ERROR':
                            return "The operation could not be completed. Please try again.";
                        default:
                            return this.getStatusBasedMessage();
                    }
                }

                getStatusBasedMessage() {
                    if (this.status >= 500) {
                        return "Server error. Please try again in a moment.";
                    } else if (this.status === 429) {
                        return "Too many requests. Please wait a moment before trying again.";
                    } else if (this.status === 404) {
                        return "The requested item could not be found. It may have been deleted or moved.";
                    } else if (this.status === 403) {
                        return "You don't have permission to perform this action.";
                    } else if (this.status === 401) {
                        return "Authentication required. Please refresh the page.";
                    } else if (this.status >= 400) {
                        return "Invalid request. Please check your input and try again.";
                    } else {
                        return this.message || "An unexpected error occurred.";
                    }
                }

                getRecoveryOptions() {
                    const options = [];
                    
                    switch (this.code) {
                        case 'DUPLICATE_RESOURCE':
                            options.push("Use a different name");
                            options.push("Update the existing item instead");
                            break;
                        case 'RESOURCE_NOT_FOUND':
                            options.push("Refresh the page to reload data");
                            options.push("Check if the item was deleted");
                            break;
                        case 'VALIDATION_ERROR':
                            options.push("Review the highlighted fields");
                            options.push("Check the format requirements");
                            break;
                        case 'INVALID_REFERENCE':
                            options.push("Select a different item");
                            options.push("Refresh the page to reload options");
                            break;
                        default:
                            if (this.status >= 500) {
                                options.push("Try again in a few moments");
                                options.push("Check system status");
                            } else if (this.status === 429) {
                                options.push("Wait a moment before retrying");
                            } else {
                                options.push("Try the action again");
                                options.push("Refresh the page if the problem persists");
                            }
                    }
                    
                    return options;
                }
            }

            class NetworkError extends APIError {
                constructor(message = "Network connection failed") {
                    super(message, 0, 'NETWORK_ERROR');
                    this.name = 'NetworkError';
                }

                getUserFriendlyMessage() {
                    return "Unable to connect to the server. Please check your internet connection and try again.";
                }

                getRecoveryOptions() {
                    return [
                        "Check your internet connection",
                        "Try refreshing the page",
                        "Wait a moment and try again"
                    ];
                }
            }

            // ============================================
            // UI HELPERS
            // ============================================
            function showToast(message, type = "success", options = {}) {
                const toast = document.getElementById("toast");
                const { 
                    duration = type === "error" ? 5000 : 3000,
                    recoveryOptions = [],
                    showDetails = false,
                    error = null
                } = options;
                
                // Clear any existing content
                toast.innerHTML = '';
                
                // Create message element
                const messageEl = document.createElement('div');
                messageEl.className = 'toast-message';
                messageEl.textContent = message;
                toast.appendChild(messageEl);
                
                // Add recovery options for errors
                if (type === "error" && recoveryOptions.length > 0) {
                    const optionsEl = document.createElement('div');
                    optionsEl.className = 'toast-options';
                    
                    const optionsTitle = document.createElement('div');
                    optionsTitle.className = 'toast-options-title';
                    optionsTitle.textContent = 'Try:';
                    optionsEl.appendChild(optionsTitle);
                    
                    recoveryOptions.slice(0, 2).forEach(option => {
                        const optionEl = document.createElement('div');
                        optionEl.className = 'toast-option';
                        optionEl.textContent = `â€¢ ${option}`;
                        optionsEl.appendChild(optionEl);
                    });
                    
                    toast.appendChild(optionsEl);
                }
                
                // Add details button for errors with technical details
                if (type === "error" && error && showDetails) {
                    const detailsBtn = document.createElement('button');
                    detailsBtn.className = 'toast-details-btn';
                    detailsBtn.textContent = 'Show Details';
                    detailsBtn.onclick = () => showErrorDetails(error);
                    toast.appendChild(detailsBtn);
                }
                
                // Add dismiss button for persistent errors
                if (duration === 0 || duration > 5000) {
                    const dismissBtn = document.createElement('button');
                    dismissBtn.className = 'toast-dismiss-btn';
                    dismissBtn.innerHTML = 'Ã—';
                    dismissBtn.onclick = () => toast.classList.remove("show");
                    toast.appendChild(dismissBtn);
                }
                
                toast.className = `toast ${type} show`;
                
                // Auto-dismiss if duration is set
                if (duration > 0) {
                    setTimeout(() => toast.classList.remove("show"), duration);
                }
            }

            function showErrorToast(error, context = "") {
                let message = "An error occurred";
                let recoveryOptions = [];
                
                if (error instanceof APIError) {
                    message = error.userMessage;
                    recoveryOptions = error.recoveryOptions;
                } else if (error instanceof NetworkError) {
                    message = error.userMessage;
                    recoveryOptions = error.recoveryOptions;
                } else {
                    message = error.message || message;
                }
                
                // Add context to message if provided
                if (context) {
                    message = `${context}: ${message}`;
                }
                
                showToast(message, "error", {
                    recoveryOptions,
                    showDetails: true,
                    error: error,
                    duration: error instanceof APIError && error.status >= 500 ? 7000 : 5000
                });
            }

            function showErrorDetails(error) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay open';
                modal.innerHTML = `
                    <div class="modal">
                        <h2>Error Details</h2>
                        <div class="error-details">
                            <div class="error-field">
                                <strong>Message:</strong>
                                <div>${escapeHtml(error.message)}</div>
                            </div>
                            ${error.status ? `
                                <div class="error-field">
                                    <strong>Status:</strong>
                                    <div>${error.status}</div>
                                </div>
                            ` : ''}
                            ${error.code ? `
                                <div class="error-field">
                                    <strong>Code:</strong>
                                    <div>${error.code}</div>
                                </div>
                            ` : ''}
                            ${error.details && Object.keys(error.details).length > 0 ? `
                                <div class="error-field">
                                    <strong>Details:</strong>
                                    <pre>${JSON.stringify(error.details, null, 2)}</pre>
                                </div>
                            ` : ''}
                            <div class="error-field">
                                <strong>Timestamp:</strong>
                                <div>${new Date().toLocaleString()}</div>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn-secondary" onclick="this.closest('.modal-overlay').remove()">Close</button>
                            <button class="btn-primary" onclick="copyErrorDetails(${JSON.stringify(error).replace(/"/g, '&quot;')})">Copy Details</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            function copyErrorDetails(error) {
                const details = {
                    message: error.message,
                    status: error.status,
                    code: error.code,
                    details: error.details,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                navigator.clipboard.writeText(JSON.stringify(details, null, 2))
                    .then(() => showToast("Error details copied to clipboard"))
                    .catch(() => showToast("Failed to copy details", "error"));
            }

            function setSyncStatus(status) {
                const indicator = document.getElementById("sync-indicator");
                indicator.className = "sync-indicator";
                if (status === "syncing") {
                    indicator.classList.add("syncing");
                    indicator.title = "Syncing...";
                } else if (status === "error") {
                    indicator.classList.add("error");
                    indicator.title = "Sync error";
                } else {
                    indicator.title = "Synced with cloud";
                }
            }

            function escapeHtml(text) {
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            function toggleSection(sectionId) {
                document
                    .getElementById(sectionId)
                    .classList.toggle("collapsed");
            }

            function toggleSidebar() {
                document
                    .getElementById("sidebar-panel")
                    .classList.toggle("mobile-open");
            }

            function switchView(viewName) {
                if (window.innerWidth >= 769) return;
                document
                    .querySelectorAll(".panel")
                    .forEach((el) => el.classList.remove("active-view"));
                document
                    .querySelectorAll(".mobile-tab")
                    .forEach((el) => el.classList.remove("active"));
                document
                    .getElementById(`view-${viewName}`)
                    .classList.add("active-view");
                document
                    .querySelectorAll(".mobile-tab")
                    [viewName === "builder" ? 0 : 1].classList.add("active");
            }

            // ============================================
            // AGENTS
            // ============================================
            async function loadAgents() {
                try {
                    agents = await api("/agents");
                    document.getElementById("agents-count").textContent =
                        agents.length;
                    renderAgentList();
                    if (agents.length > 0 && !selectedAgentId)
                        selectAgent(agents[0].id);
                } catch (error) {
                    console.error("Failed to load agents:", error);
                    document.getElementById("agent-list").innerHTML =
                        '<div class="empty-state">Failed to load agents</div>';
                    showErrorToast(error, "Failed to load agents");
                }
            }

            function renderAgentList() {
                const container = document.getElementById("agent-list");
                if (agents.length === 0) {
                    container.innerHTML =
                        '<div class="empty-state">No agents yet. Create one!</div>';
                    return;
                }
                container.innerHTML = agents
                    .map(
                        (agent) => `
                    <div class="item-card ${agent.id === selectedAgentId ? "active" : ""}" onclick="selectAgent('${agent.id}'); if(window.innerWidth < 769) toggleSidebar();">
                        <div class="item-card-header">
                            <span class="item-name">${escapeHtml(agent.name)}</span>
                            <div class="resource-actions">
                                <button class="btn-ghost btn-xs" onclick="event.stopPropagation(); editAgent('${agent.id}')" title="Edit">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                </button>
                                ${currentProjectId ? `
                                    <button class="btn-ghost btn-xs" onclick="event.stopPropagation(); assignAgentToProject('${agent.id}')" title="Add to project">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"/>
                                            <line x1="5" y1="12" x2="19" y2="12"/>
                                        </svg>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <span class="item-preview">${escapeHtml(agent.role)}</span>
                    </div>
                `,
                    )
                    .join("");
            }

            async function assignAgentToProject(agentId) {
                if (!currentProjectId) {
                    const error = new APIError("Please select a project before adding agents", 400, 'VALIDATION_ERROR', {
                        action: 'select_project'
                    });
                    showErrorToast(error, "No project selected");
                    return;
                }

                try {
                    await api(`/projects/${currentProjectId}/resources`, {
                        method: "POST",
                        body: {
                            resourceId: agentId,
                            resourceType: "agent"
                        }
                    });

                    await loadProjectResources();
                    showToast("Agent added to project");
                } catch (error) {
                    console.error("Failed to assign agent:", error);
                    showErrorToast(error, "Failed to add agent to project");
                }
            }

            function selectAgent(id) {
                selectedAgentId = id;
                const agent = agents.find((a) => a.id === id);
                const display = document.getElementById(
                    "current-agent-display",
                );
                if (agent) {
                    display.innerHTML = `<span class="selection-tag-name">${escapeHtml(agent.name)}</span><span class="selection-tag-status">Active</span>`;
                    display.classList.add("has-selection");
                }
                renderAgentList();
            }

            function openAgentModal() {
                document.getElementById("agent-modal-title").textContent =
                    "Create New Agent";
                document.getElementById("agent-id").value = "";
                document.getElementById("agent-name").value = "";
                document.getElementById("agent-role").value = "";
                document.getElementById("agent-style").value = "";
                document.getElementById("btn-delete-agent").style.display =
                    "none";
                document.getElementById("agent-modal").classList.add("open");
            }

            function editAgent(id) {
                const agent = agents.find((a) => a.id === id);
                if (!agent) return;
                document.getElementById("agent-modal-title").textContent =
                    "Edit Agent";
                document.getElementById("agent-id").value = agent.id;
                document.getElementById("agent-name").value = agent.name;
                document.getElementById("agent-role").value = agent.role;
                document.getElementById("agent-style").value =
                    agent.style || "";
                document.getElementById("btn-delete-agent").style.display =
                    "block";
                document.getElementById("agent-modal").classList.add("open");
            }

            function closeAgentModal() {
                document.getElementById("agent-modal").classList.remove("open");
            }

            async function saveAgent() {
                const id = document.getElementById("agent-id").value;
                const name = document.getElementById("agent-name").value.trim();
                const role = document.getElementById("agent-role").value.trim();
                const style = document
                    .getElementById("agent-style")
                    .value.trim();
                if (!name || !role) {
                    const error = new APIError("Please fill in both the agent name and persona fields", 400, 'VALIDATION_ERROR', {
                        missingFields: [!name ? 'name' : null, !role ? 'persona' : null].filter(Boolean)
                    });
                    showErrorToast(error, "Missing required information");
                    return;
                }

                const btn = document.getElementById("btn-save-agent");
                btn.disabled = true;
                btn.innerHTML =
                    '<span class="loading-spinner"></span> Saving...';

                try {
                    if (id) {
                        const updated = await api(`/agents/${id}`, {
                            method: "PUT",
                            body: { name, role, style },
                        });
                        const idx = agents.findIndex((a) => a.id === id);
                        if (idx !== -1) agents[idx] = updated;
                        showToast("Agent updated");
                    } else {
                        const created = await api("/agents", {
                            method: "POST",
                            body: { name, role, style },
                        });
                        agents.unshift(created);
                        selectAgent(created.id);
                        showToast("Agent created");
                    }
                    document.getElementById("agents-count").textContent =
                        agents.length;
                    renderAgentList();
                    closeAgentModal();
                } catch (error) {
                    showErrorToast(error, "Failed to save agent");
                } finally {
                    btn.disabled = false;
                    btn.textContent = "Save Agent";
                }
            }

            async function deleteAgent() {
                const id = document.getElementById("agent-id").value;
                if (!id || !confirm("Delete this agent?")) return;
                try {
                    await api(`/agents/${id}`, { method: "DELETE" });
                    agents = agents.filter((a) => a.id !== id);
                    if (selectedAgentId === id) {
                        selectedAgentId =
                            agents.length > 0 ? agents[0].id : null;
                        if (selectedAgentId) selectAgent(selectedAgentId);
                        else {
                            const display = document.getElementById(
                                "current-agent-display",
                            );
                            display.innerHTML =
                                '<span class="selection-tag-name">No agent selected</span><span class="selection-tag-status">Select from sidebar</span>';
                            display.classList.remove("has-selection");
                        }
                    }
                    document.getElementById("agents-count").textContent =
                        agents.length;
                    renderAgentList();
                    closeAgentModal();
                    showToast("Agent deleted");
                } catch (error) {
                    showErrorToast(error, "Failed to delete agent");
                }
            }

            // ============================================
            // OUTPUT REQUIREMENTS
            // ============================================
            async function loadOutputRequirements() {
                try {
                    outputRequirements = await api("/output-requirements");
                    document.getElementById("requirements-count").textContent =
                        outputRequirements.length;
                    renderRequirementList();
                } catch (error) {
                    console.error("Failed to load requirements:", error);
                    document.getElementById("requirement-list").innerHTML =
                        '<div class="empty-state">Failed to load requirements</div>';
                    showErrorToast(error, "Failed to load requirements");
                }
            }

            function renderRequirementList() {
                const container = document.getElementById("requirement-list");
                if (outputRequirements.length === 0) {
                    container.innerHTML =
                        '<div class="empty-state">No requirements yet. Create one!</div>';
                    return;
                }
                container.innerHTML = outputRequirements
                    .map(
                        (req) => `
                    <div class="item-card ${req.id === selectedRequirementId ? "active" : ""}" onclick="selectRequirement('${req.id}'); if(window.innerWidth < 769) toggleSidebar();">
                        <div class="item-card-header">
                            <span class="item-name">${escapeHtml(req.name)}</span>
                            <button class="btn-ghost btn-xs" onclick="event.stopPropagation(); editRequirement('${req.id}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                        </div>
                        <span class="item-preview">${escapeHtml(req.requirements_content)}</span>
                    </div>
                `,
                    )
                    .join("");
            }

            function selectRequirement(id) {
                selectedRequirementId = id;
                const req = outputRequirements.find((r) => r.id === id);
                const display = document.getElementById(
                    "current-requirement-display",
                );
                const textarea = document.getElementById("output-requirements");
                const clearBtn = document.getElementById(
                    "clear-requirement-btn",
                );

                if (req) {
                    display.querySelector(".selection-tag-name").textContent =
                        req.name;
                    display.classList.add("has-selection");
                    textarea.value = req.requirements_content;
                    clearBtn.style.display = "block";
                    // Track usage
                    api(`/output-requirements/${id}/use`, {
                        method: "POST",
                    }).catch(() => {});
                }
                renderRequirementList();
            }

            function clearSelectedRequirement() {
                selectedRequirementId = null;
                const display = document.getElementById(
                    "current-requirement-display",
                );
                display.querySelector(".selection-tag-name").textContent =
                    "No template selected";
                display.classList.remove("has-selection");
                document.getElementById("clear-requirement-btn").style.display =
                    "none";
                renderRequirementList();
            }

            function openRequirementModal() {
                document.getElementById("requirement-modal-title").textContent =
                    "Create Output Requirement";
                document.getElementById("requirement-id").value = "";
                document.getElementById("requirement-name").value = "";
                document.getElementById("requirement-description").value = "";
                document.getElementById("requirement-content").value = "";
                document.getElementById(
                    "btn-delete-requirement",
                ).style.display = "none";
                document
                    .getElementById("requirement-modal")
                    .classList.add("open");
            }

            function editRequirement(id) {
                const req = outputRequirements.find((r) => r.id === id);
                if (!req) return;
                document.getElementById("requirement-modal-title").textContent =
                    "Edit Output Requirement";
                document.getElementById("requirement-id").value = req.id;
                document.getElementById("requirement-name").value = req.name;
                document.getElementById("requirement-description").value =
                    req.description || "";
                document.getElementById("requirement-content").value =
                    req.requirements_content;
                document.getElementById(
                    "btn-delete-requirement",
                ).style.display = "block";
                document
                    .getElementById("requirement-modal")
                    .classList.add("open");
            }

            function closeRequirementModal() {
                document
                    .getElementById("requirement-modal")
                    .classList.remove("open");
            }

            async function saveRequirement() {
                const id = document.getElementById("requirement-id").value;
                const name = document
                    .getElementById("requirement-name")
                    .value.trim();
                const description = document
                    .getElementById("requirement-description")
                    .value.trim();
                const requirements_content = document
                    .getElementById("requirement-content")
                    .value.trim();
                if (!name || !requirements_content) {
                    const error = new APIError("Please fill in both the requirement name and content fields", 400, 'VALIDATION_ERROR', {
                        missingFields: [!name ? 'name' : null, !requirements_content ? 'content' : null].filter(Boolean)
                    });
                    showErrorToast(error, "Missing required information");
                    return;
                }

                const btn = document.getElementById("btn-save-requirement");
                btn.disabled = true;
                btn.innerHTML =
                    '<span class="loading-spinner"></span> Saving...';

                try {
                    if (id) {
                        const updated = await api(
                            `/output-requirements/${id}`,
                            {
                                method: "PUT",
                                body: {
                                    name,
                                    description,
                                    requirements_content,
                                },
                            },
                        );
                        const idx = outputRequirements.findIndex(
                            (r) => r.id === id,
                        );
                        if (idx !== -1) outputRequirements[idx] = updated;
                        showToast("Requirement updated");
                    } else {
                        const created = await api("/output-requirements", {
                            method: "POST",
                            body: { name, description, requirements_content },
                        });
                        outputRequirements.unshift(created);
                        showToast("Requirement created");
                    }
                    document.getElementById("requirements-count").textContent =
                        outputRequirements.length;
                    renderRequirementList();
                    closeRequirementModal();
                } catch (error) {
                    showErrorToast(error, "Failed to save requirement");
                } finally {
                    btn.disabled = false;
                    btn.textContent = "Save Requirement";
                }
            }

            async function deleteRequirement() {
                const id = document.getElementById("requirement-id").value;
                if (!id || !confirm("Delete this requirement?")) return;
                try {
                    await api(`/output-requirements/${id}`, {
                        method: "DELETE",
                    });
                    outputRequirements = outputRequirements.filter(
                        (r) => r.id !== id,
                    );
                    if (selectedRequirementId === id)
                        clearSelectedRequirement();
                    document.getElementById("requirements-count").textContent =
                        outputRequirements.length;
                    renderRequirementList();
                    closeRequirementModal();
                    showToast("Requirement deleted");
                } catch (error) {
                    showErrorToast(error, "Failed to delete requirement");
                }
            }



            // ============================================
            // IMPORT/EXPORT
            // ============================================
            function exportData() {
                if (currentProjectId) {
                    exportProject();
                } else {
                    const data = { agents, outputRequirements };
                    const blob = new Blob([JSON.stringify(data, null, 2)], {
                        type: "application/json",
                    });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "prompt_workstation_data.json";
                    a.click();
                    URL.revokeObjectURL(url);
                    showToast("Data exported");
                }
            }

            async function importData(input) {
                const file = input.files[0];
                if (!file) return;
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    let count = 0;
                    if (data.agents && Array.isArray(data.agents)) {
                        for (const agent of data.agents) {
                            if (agent.name && agent.role) {
                                await api("/agents", {
                                    method: "POST",
                                    body: {
                                        name: agent.name,
                                        role: agent.role,
                                        style: agent.style || "",
                                    },
                                });
                                count++;
                            }
                        }
                    }
                    if (
                        data.outputRequirements &&
                        Array.isArray(data.outputRequirements)
                    ) {
                        for (const req of data.outputRequirements) {
                            if (req.name && req.requirements_content) {
                                await api("/output-requirements", {
                                    method: "POST",
                                    body: {
                                        name: req.name,
                                        description: req.description || "",
                                        requirements_content:
                                            req.requirements_content,
                                    },
                                });
                                count++;
                            }
                        }
                    }
                    await loadAgents();
                    await loadOutputRequirements();
                    showToast(`Imported ${count} items`);
                } catch (error) {
                    showErrorToast(error, "Import failed");
                }
                input.value = "";
            }

            function copyToClipboard() {
                const text =
                    document.getElementById("output-display").textContent;
                if (text.includes("Generated prompt will appear here")) {
                    const error = new APIError("Please generate a prompt first before copying", 400, 'VALIDATION_ERROR', {
                        action: 'generate_prompt'
                    });
                    showErrorToast(error, "No prompt to copy");
                    return;
                }
                navigator.clipboard
                    .writeText(text)
                    .then(() => showToast("Copied!"))
                    .catch((error) => {
                        const copyError = new APIError("Unable to copy to clipboard. Please copy manually.", 0, 'CLIPBOARD_ERROR');
                        showErrorToast(copyError, "Copy failed");
                    });
            }

            // ============================================
            // PWA
            // ============================================
            let deferredPrompt;
            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("./sw.js")
                        .catch((err) =>
                            console.log("SW registration failed", err),
                        );
                });
            }
            window.addEventListener("beforeinstallprompt", (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById("install-prompt").style.display =
                    "block";
            });
            async function installPWA() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    document.getElementById("install-prompt").style.display =
                        "none";
                }
            }

            // ============================================
            // PROJECT MANAGEMENT
            // ============================================
            async function loadProjects() {
                try {
                    const response = await api("/projects");
                    // Handle both old array format and new object format
                    projects = Array.isArray(response) ? response : response.projects || [];
                    renderProjectSelector();
                } catch (error) {
                    console.error("Failed to load projects:", error);
                    showErrorToast(error, "Failed to load projects");
                }
            }

            function renderProjectSelector() {
                const select = document.getElementById("current-project-select");
                const currentValue = select.value;
                
                select.innerHTML = '<option value="">No Project Selected</option>';
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    option.textContent = project.name;
                    select.appendChild(option);
                });
                
                // Restore selection if it still exists
                if (currentValue && projects.find(p => p.id === currentValue)) {
                    select.value = currentValue;
                }
            }

            async function switchProject(projectId) {
                if (!projectId) {
                    currentProjectId = null;
                    currentProjectContext = null;
                    updateProjectContext();
                    loadProjectResources();
                    return;
                }

                try {
                    currentProjectId = projectId;
                    currentProjectContext = await api(`/projects/${projectId}`);
                    updateProjectContext();
                    await loadProjectResources();
                    showToast(`Switched to project: ${currentProjectContext.name}`);
                } catch (error) {
                    console.error("Failed to switch project:", error);
                    showErrorToast(error, "Failed to switch project");
                    currentProjectId = null;
                    currentProjectContext = null;
                }
            }

            function updateProjectContext() {
                const banner = document.getElementById("project-context-banner");
                const status = document.getElementById("project-context-status");
                const text = document.getElementById("project-context-text");
                const saveBtn = document.getElementById("save-prompt-btn");
                const exportBtn = document.getElementById("export-btn");

                if (currentProjectContext) {
                    banner.style.display = "block";
                    status.textContent = currentProjectContext.name;
                    text.textContent = currentProjectContext.ai_context_summary || 
                        currentProjectContext.description || 
                        "No context summary available";
                    saveBtn.style.display = "inline-flex";
                    exportBtn.style.display = "inline-flex";
                } else {
                    banner.style.display = "none";
                    saveBtn.style.display = "none";
                    exportBtn.style.display = "none";
                }
            }

            async function loadProjectResources() {
                if (!currentProjectId) {
                    document.getElementById("project-agent-list").innerHTML = 
                        '<div class="empty-state">No project selected</div>';
                    document.getElementById("project-context-display").innerHTML = 
                        '<div class="empty-state">Select a project to see context</div>';
                    document.getElementById("project-agents-count").textContent = "0";
                    return;
                }

                try {
                    projectResources = await api(`/projects/${currentProjectId}/resources`);
                    renderProjectResources();
                } catch (error) {
                    console.error("Failed to load project resources:", error);
                    showErrorToast(error, "Failed to load project resources");
                }
            }

            function renderProjectResources() {
                const projectAgents = projectResources.filter(r => r.resource_type === 'agent');
                const agentList = document.getElementById("project-agent-list");
                const contextDisplay = document.getElementById("project-context-display");
                
                document.getElementById("project-agents-count").textContent = projectAgents.length;

                if (projectAgents.length === 0) {
                    agentList.innerHTML = '<div class="empty-state">No agents assigned to project</div>';
                } else {
                    agentList.innerHTML = projectAgents.map(resource => {
                        const agent = agents.find(a => a.id === resource.resource_id);
                        if (!agent) return '';
                        
                        return `
                            <div class="item-card ${agent.id === selectedAgentId ? "active" : ""}" onclick="selectAgent('${agent.id}'); if(window.innerWidth < 769) toggleSidebar();">
                                <div class="item-card-header">
                                    <span class="item-name">${escapeHtml(agent.name)}</span>
                                    <div class="resource-actions">
                                        <button class="btn-ghost btn-xs" onclick="event.stopPropagation(); editAgent('${agent.id}')" title="Edit">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                            </svg>
                                        </button>
                                        <button class="btn-ghost btn-xs" onclick="event.stopPropagation(); unassignResource('${resource.id}')" title="Remove from project">
                                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <line x1="18" y1="6" x2="6" y2="18"/>
                                                <line x1="6" y1="6" x2="18" y2="18"/>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <span class="item-preview">${escapeHtml(agent.role)}</span>
                                <div class="resource-type">Project Agent</div>
                            </div>
                        `;
                    }).join('');
                }

                // Update context display
                if (currentProjectContext) {
                    contextDisplay.innerHTML = `
                        <div class="resource-assignment">
                            <div class="resource-assignment-header">
                                <span style="font-weight: 600;">${escapeHtml(currentProjectContext.name)}</span>
                                <span class="resource-type">${currentProjectContext.status}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                                ${escapeHtml(currentProjectContext.description || 'No description')}
                            </div>
                            <div style="font-size: 0.75rem; color: var(--text-muted);">
                                ${projectResources.length} resources assigned
                            </div>
                        </div>
                    `;
                }
            }

            async function unassignResource(assignmentId) {
                if (!confirm("Remove this resource from the project?")) return;
                
                try {
                    await api(`/projects/${currentProjectId}/resources/${assignmentId}`, {
                        method: "DELETE"
                    });
                    await loadProjectResources();
                    showToast("Resource removed from project");
                } catch (error) {
                    console.error("Failed to unassign resource:", error);
                    showErrorToast(error, "Failed to remove resource");
                }
            }

            // ============================================
            // AI ENHANCEMENT
            // ============================================
            async function getAISuggestions() {
                if (!currentProjectId) {
                    const error = new APIError("Please select a project to get AI suggestions", 400, 'VALIDATION_ERROR', {
                        action: 'select_project'
                    });
                    showErrorToast(error, "No project selected");
                    return;
                }

                const task = document.getElementById("task").value.trim();
                const context = document.getElementById("context").value.trim();
                
                const btn = document.getElementById("ai-suggest-btn");
                const container = document.getElementById("ai-suggestions-container");
                const content = document.getElementById("ai-suggestions-content");
                
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span>';
                container.style.display = "block";
                content.textContent = "Generating AI suggestions...";

                try {
                    const suggestions = await api(`/ai/enhance-resource`, {
                        method: "POST",
                        body: {
                            projectId: currentProjectId,
                            resourceType: "prompt",
                            context: {
                                task: task,
                                context: context,
                                agent: selectedAgentId ? agents.find(a => a.id === selectedAgentId) : null
                            }
                        }
                    });

                    content.innerHTML = `
                        <div style="margin-bottom: 0.75rem;">
                            <strong>Suggested Improvements:</strong>
                        </div>
                        <ul style="margin-left: 1rem; color: var(--text-secondary);">
                            ${suggestions.suggestions.map(s => `<li style="margin-bottom: 0.25rem;">${escapeHtml(s)}</li>`).join('')}
                        </ul>
                        ${suggestions.contextualTips ? `
                            <div style="margin-top: 0.75rem;">
                                <strong>Project-Specific Tips:</strong>
                                <div style="color: var(--text-secondary); margin-top: 0.25rem;">${escapeHtml(suggestions.contextualTips)}</div>
                            </div>
                        ` : ''}
                    `;
                } catch (error) {
                    console.error("Failed to get AI suggestions:", error);
                    content.textContent = "Failed to get AI suggestions. Try again later.";
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
                        </svg>
                    `;
                }
            }

            // ============================================
            // RESOURCE IMPORT
            // ============================================
            async function openResourceImportModal() {
                if (!currentProjectId) {
                    const error = new APIError("Please select a project before importing resources", 400, 'VALIDATION_ERROR', {
                        action: 'select_project'
                    });
                    showErrorToast(error, "No project selected");
                    return;
                }

                try {
                    availableResources = await api(`/projects/${currentProjectId}/available-resources`);
                    renderAvailableResources();
                    document.getElementById("resource-import-modal").classList.add("open");
                } catch (error) {
                    console.error("Failed to load available resources:", error);
                    showErrorToast(error, "Failed to load available resources");
                }
            }

            function renderAvailableResources() {
                const container = document.getElementById("available-resources-list");
                
                if (availableResources.length === 0) {
                    container.innerHTML = '<div class="empty-state">No resources available for import</div>';
                    return;
                }

                container.innerHTML = availableResources.map(resource => `
                    <div class="resource-assignment">
                        <div class="resource-assignment-header">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" value="${resource.id}" data-type="${resource.type}">
                                <span style="font-weight: 600;">${escapeHtml(resource.name)}</span>
                            </label>
                            <span class="resource-type">${resource.type}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            ${escapeHtml(resource.description || resource.role || 'No description')}
                        </div>
                    </div>
                `).join('');
            }

            function closeResourceImportModal() {
                document.getElementById("resource-import-modal").classList.remove("open");
            }

            async function importSelectedResources() {
                const checkboxes = document.querySelectorAll('#available-resources-list input[type="checkbox"]:checked');
                
                if (checkboxes.length === 0) {
                    const error = new APIError("Please select at least one resource to import", 400, 'VALIDATION_ERROR', {
                        action: 'select_resources'
                    });
                    showErrorToast(error, "No resources selected");
                    return;
                }

                const btn = document.getElementById("btn-import-resources");
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> Importing...';

                try {
                    const resourceIds = Array.from(checkboxes).map(cb => ({
                        resourceId: cb.value,
                        resourceType: cb.dataset.type
                    }));

                    await api(`/projects/${currentProjectId}/import`, {
                        method: "POST",
                        body: { resources: resourceIds }
                    });

                    await loadProjectResources();
                    closeResourceImportModal();
                    showToast(`Imported ${resourceIds.length} resources`);
                } catch (error) {
                    console.error("Failed to import resources:", error);
                    showErrorToast(error, "Failed to import resources");
                } finally {
                    btn.disabled = false;
                    btn.textContent = "Import Selected";
                }
            }

            // ============================================
            // EXPORT FUNCTIONALITY
            // ============================================
            async function exportProject() {
                if (!currentProjectId) {
                    const error = new APIError("Please select a project to export", 400, 'VALIDATION_ERROR', {
                        action: 'select_project'
                    });
                    showErrorToast(error, "No project selected");
                    return;
                }
                openExportModal();
            }

            function openExportModal() {
                document.getElementById("export-filename").value = 
                    currentProjectContext ? currentProjectContext.slug : "project-export";
                document.getElementById("export-modal").classList.add("open");
            }

            function closeExportModal() {
                document.getElementById("export-modal").classList.remove("open");
            }

            async function executeExport() {
                const format = document.getElementById("export-format").value;
                const filename = document.getElementById("export-filename").value.trim();
                const includeAgents = document.getElementById("include-agents").checked;
                const includeRules = document.getElementById("include-rules").checked;
                const includeHooks = document.getElementById("include-hooks").checked;
                const includePrompts = document.getElementById("include-prompts").checked;

                if (!filename) {
                    showToast("Filename is required", "error");
                    return;
                }

                const btn = document.getElementById("btn-export-project");
                const progressContainer = document.getElementById("export-progress");
                const progressFill = document.getElementById("export-progress-fill");
                const progressStatus = document.getElementById("export-status");
                const steps = document.querySelectorAll("#export-steps .progress-step");

                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner"></span> Exporting...';
                closeExportModal();
                progressContainer.style.display = "block";

                try {
                    // Step 1: Validation
                    progressStatus.textContent = "Validating project...";
                    progressFill.style.width = "25%";
                    steps[0].classList.add("completed");
                    steps[1].classList.add("active");

                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Step 2: Generate files
                    progressStatus.textContent = "Generating files...";
                    progressFill.style.width = "50%";
                    steps[1].classList.add("completed");
                    steps[2].classList.add("active");

                    const exportData = await api(`/export/claude-code/${currentProjectId}`, {
                        method: "POST",
                        body: {
                            format,
                            filename,
                            include: {
                                agents: includeAgents,
                                rules: includeRules,
                                hooks: includeHooks,
                                prompts: includePrompts
                            }
                        }
                    });

                    // Step 3: Packaging
                    progressStatus.textContent = "Packaging export...";
                    progressFill.style.width = "75%";
                    steps[2].classList.add("completed");
                    steps[3].classList.add("active");

                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Step 4: Complete
                    progressStatus.textContent = "Export complete!";
                    progressFill.style.width = "100%";
                    steps[3].classList.add("completed");

                    // Download the file
                    if (exportData.downloadUrl) {
                        const a = document.createElement('a');
                        a.href = exportData.downloadUrl;
                        a.download = `${filename}.${format === 'claude-code' ? 'zip' : format}`;
                        a.click();
                    }

                    showToast("Project exported successfully!");
                    
                    setTimeout(() => {
                        progressContainer.style.display = "none";
                        progressFill.style.width = "0%";
                        steps.forEach(step => {
                            step.classList.remove("completed", "active");
                        });
                        steps[0].classList.add("active");
                    }, 2000);

                } catch (error) {
                    console.error("Failed to export project:", error);
                    showErrorToast(error, "Failed to export project");
                    progressContainer.style.display = "none";
                } finally {
                    btn.disabled = false;
                    btn.textContent = "Export Project";
                }
            }

            async function savePromptToProject() {
                if (!currentProjectId || !lastGeneratedPrompt) {
                    showToast("Generate a prompt first", "error");
                    return;
                }

                try {
                    await api(`/projects/${currentProjectId}/prompts`, {
                        method: "POST",
                        body: {
                            content: lastGeneratedPrompt,
                            agentId: selectedAgentId,
                            context: {
                                task: document.getElementById("task").value,
                                context: document.getElementById("context").value,
                                format: document.getElementById("format").value,
                                requirements: document.getElementById("output-requirements").value
                            }
                        }
                    });

                    showToast("Prompt saved to project");
                } catch (error) {
                    console.error("Failed to save prompt:", error);
                    showErrorToast(error, "Failed to save prompt");
                }
            }

            // ============================================
            // ENHANCED PROMPT GENERATION
            // ============================================
            async function generatePrompt() {
                const task = document.getElementById("task").value.trim();
                const context = document.getElementById("context").value.trim();
                const format = document.getElementById("format").value.trim();
                const outputReqs = document
                    .getElementById("output-requirements")
                    .value.trim();
                const agent = agents.find((a) => a.id === selectedAgentId);

                if (!task) {
                    showToast("Please enter a task description", "error");
                    return;
                }

                if (!agent) {
                    showToast("Please select an agent first", "error");
                    return;
                }

                try {
                    let prompt;
                    
                    if (currentProjectId) {
                        // Use project-aware generation
                        const response = await api(`/projects/${currentProjectId}/generate-from-template`, {
                            method: "POST",
                            body: {
                                agentId: selectedAgentId,
                                task,
                                context,
                                format,
                                outputRequirements: outputReqs
                            }
                        });
                        prompt = response.prompt;
                    } else {
                        // Fallback to client-side generation
                        prompt = `${agent.role}

<agent_style>
${agent.style || "Professional and helpful."}
</agent_style>

<context>
${context || "No additional context provided."}
</context>

<task_instruction>
${task}
</task_instruction>

<output_format>
${format || "Best fit for the task."}
</output_format>

<output_requirements>
${outputReqs || "Best fit."}
</output_requirements>`;
                    }

                    lastGeneratedPrompt = prompt;
                    document.getElementById("output-display").textContent = prompt;
                    showToast("Prompt generated!");
                    
                } catch (error) {
                    console.error("Failed to generate prompt:", error);
                    showErrorToast(error, "Failed to generate prompt");
                }

                if (window.innerWidth < 769) switchView("output");
            }

            // ============================================
            // EVENT LISTENERS
            // ============================================
            
            // Close modals on outside click
            document.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.addEventListener("click", (e) => {
                        if (e.target.classList.contains("modal-overlay")) {
                            modal.classList.remove("open");
                        }
                    });
                });
            });

            // ============================================
            // INIT
            // ============================================
            window.addEventListener("DOMContentLoaded", () => {
                loadProjects();
                loadAgents();
                loadOutputRequirements();
                if (window.innerWidth < 769) switchView("builder");
            });
        </script>
    </body>
</html>
