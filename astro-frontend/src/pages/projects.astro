---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import Button from '../components/ui/Button.astro';
import Form from '../components/ui/Form.astro';
import Modal from '../components/ui/Modal.astro';
---

<Layout title="Projects - Semantic Prompt Workstation">
  <Navigation currentPath="/projects" />

  <div class="main-layout">
    <!-- PROJECT LIST -->
    <section class="panel" id="project-list-panel">
      <div class="panel-header">
        <span class="panel-title">Projects</span>
        <div class="header-actions">
          <Button variant="primary" size="sm" id="new-project-btn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19" />
              <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
            New Project
          </Button>
        </div>
      </div>

      <div class="search-section">
        <div class="search-box">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8" />
            <path d="M21 21l-4.35-4.35" />
          </svg>
          <input type="text" id="project-search" placeholder="Search projects..." />
        </div>
      </div>

      <div id="project-list" class="item-list">
        <div class="empty-state">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
          <h3>No projects yet</h3>
          <p>Create your first project to organize your work</p>
          <Button variant="primary" id="empty-new-project-btn">Create Project</Button>
        </div>
      </div>
    </section>

    <!-- PROJECT EDITOR -->
    <section class="panel" id="project-editor-panel">
      <div class="panel-header">
        <span class="panel-title">Project Details</span>
        <div class="header-actions">
          <Button variant="secondary" size="sm" id="export-project-btn" style="display: none;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="7 10 12 15 17 10" />
              <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
            Export
          </Button>
          <Button variant="secondary" size="sm" id="delete-project-btn" style="display: none; color: #ef4444; border-color: #ef4444;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6" />
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
            </svg>
            Delete
          </Button>
        </div>
      </div>

      <div id="project-editor-content" class="editor-content">
        <div class="empty-editor">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
          <h3>Select a project to edit</h3>
          <p>Choose a project from the list or create a new one</p>
        </div>
      </div>

      <div id="project-form" class="project-form" style="display: none;">
        <input type="hidden" id="project-id" />
        
        <Form>
          <label for="project-name">Project Name</label>
          <input type="text" id="project-name" placeholder="e.g., Website Redesign" required />
        </Form>

        <Form>
          <label for="project-description">Description</label>
          <textarea id="project-description" rows="3" placeholder="Brief description of the project..."></textarea>
        </Form>

        <Form>
          <label for="project-context">Project Context</label>
          <textarea id="project-context" rows="6" placeholder="Detailed context, requirements, constraints, and background information..."></textarea>
        </Form>

        <div class="form-actions">
          <Button variant="secondary" id="cancel-project-btn">Cancel</Button>
          <Button variant="primary" id="save-project-btn">Save Project</Button>
        </div>
      </div>
    </section>

    <!-- PROJECT RESOURCES -->
    <section class="panel preview-panel" id="project-resources-panel">
      <div class="panel-header">
        <span class="panel-title">Project Resources</span>
        <div class="header-actions">
          <Button variant="secondary" size="sm" id="manage-resources-btn" style="display: none;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3" />
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
            </svg>
            Manage
          </Button>
        </div>
      </div>

      <div id="project-resources-content" class="resources-content">
        <div class="empty-resources">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
          </svg>
          <h3>No Resources</h3>
          <p>Select a project to see its resources</p>
        </div>
      </div>
    </section>
  </div>

  <!-- Resource Management Modal -->
  <Modal id="resources-modal" title="Manage Project Resources">
    <div class="resources-tabs">
      <button class="resource-tab active" data-tab="agents">Agents</button>
      <button class="resource-tab" data-tab="templates">Templates</button>
      <button class="resource-tab" data-tab="requirements">Requirements</button>
    </div>

    <div class="resource-tab-content" id="agents-tab">
      <div class="resource-section">
        <h4>Available Agents</h4>
        <div id="available-agents" class="resource-list">
          <!-- Populated by JavaScript -->
        </div>
      </div>
      <div class="resource-section">
        <h4>Assigned Agents</h4>
        <div id="assigned-agents" class="resource-list">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>

    <div class="resource-tab-content" id="templates-tab" style="display: none;">
      <div class="resource-section">
        <h4>Available Templates</h4>
        <div id="available-templates" class="resource-list">
          <!-- Populated by JavaScript -->
        </div>
      </div>
      <div class="resource-section">
        <h4>Assigned Templates</h4>
        <div id="assigned-templates" class="resource-list">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>

    <div class="resource-tab-content" id="requirements-tab" style="display: none;">
      <div class="resource-section">
        <h4>Available Requirements</h4>
        <div id="available-requirements" class="resource-list">
          <!-- Populated by JavaScript -->
        </div>
      </div>
      <div class="resource-section">
        <h4>Assigned Requirements</h4>
        <div id="assigned-requirements" class="resource-list">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <Button variant="secondary" id="btn-cancel-resources">Cancel</Button>
      <Button variant="primary" id="btn-save-resources">Save Changes</Button>
    </div>
  </Modal>

  <div id="toast" class="toast"></div>
</Layout>

<style>
  .main-layout {
    display: grid;
    grid-template-columns: 320px 1fr 420px;
    height: calc(100vh - var(--header-height));
    overflow: hidden;
  }

  @media (max-width: 1200px) {
    .main-layout {
      grid-template-columns: 280px 1fr;
    }
    .preview-panel {
      display: none;
    }
  }

  @media (max-width: 768px) {
    .main-layout {
      grid-template-columns: 1fr;
      display: flex;
      flex-direction: column;
    }
    .preview-panel {
      display: none;
    }
  }

  .panel {
    padding: 1.5rem;
    overflow-y: auto;
    border-right: 1px solid var(--border-subtle);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background: var(--bg-base);
  }
  .panel:last-child {
    border-right: none;
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-subtle);
  }

  .panel-title {
    font-family: var(--font-display);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }

  .search-section {
    margin-bottom: 1rem;
  }

  .search-box {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-box svg {
    position: absolute;
    left: 0.75rem;
    color: var(--text-muted);
    z-index: 1;
  }

  .search-box input {
    width: 100%;
    padding: 0.75rem 0.75rem 0.75rem 2.5rem;
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.875rem;
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--accent-primary);
  }

  .item-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    flex: 1;
  }

  .item-card {
    background: var(--bg-surface);
    padding: 1rem;
    border-radius: var(--radius-md);
    border: 1px solid transparent;
    cursor: pointer;
    transition: var(--transition-fast);
  }

  .item-card:hover {
    background: var(--bg-elevated);
    border-color: var(--border-default);
  }

  .item-card.active {
    background: rgba(99, 102, 241, 0.1);
    border-color: var(--accent-primary);
  }

  .item-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .item-name {
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--text-primary);
  }

  .item-preview {
    font-size: 0.8rem;
    color: var(--text-muted);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
  }

  .item-meta {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 0.5rem;
    display: flex;
    gap: 1rem;
  }

  .empty-state, .empty-editor, .empty-resources {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 3rem 1rem;
    color: var(--text-muted);
    flex: 1;
  }

  .empty-state svg, .empty-editor svg, .empty-resources svg {
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .empty-state h3, .empty-editor h3, .empty-resources h3 {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
  }

  .empty-state p, .empty-editor p, .empty-resources p {
    font-size: 0.875rem;
    margin-bottom: 1.5rem;
  }

  .editor-content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .project-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    flex: 1;
  }

  .form-actions {
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
    margin-top: auto;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-subtle);
  }

  .resources-content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .resource-summary {
    background: var(--bg-surface);
    padding: 1.25rem;
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
    margin-bottom: 1rem;
  }

  .resource-summary h4 {
    font-family: var(--font-display);
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
  }

  .resource-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
  }

  .resource-stat {
    text-align: center;
  }

  .resource-stat-value {
    font-family: var(--font-display);
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--accent-primary);
  }

  .resource-stat-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Resource Modal Styles */
  .resources-tabs {
    display: flex;
    border-bottom: 1px solid var(--border-subtle);
    margin-bottom: 1.5rem;
  }

  .resource-tab {
    padding: 0.75rem 1rem;
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: var(--transition-fast);
  }

  .resource-tab:hover {
    color: var(--text-primary);
  }

  .resource-tab.active {
    color: var(--accent-primary);
    border-bottom-color: var(--accent-primary);
  }

  .resource-tab-content {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    max-height: 400px;
    overflow-y: auto;
  }

  .resource-section h4 {
    font-family: var(--font-display);
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
  }

  .resource-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .resource-item {
    background: var(--bg-surface);
    padding: 0.75rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-subtle);
    cursor: pointer;
    transition: var(--transition-fast);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .resource-item:hover {
    background: var(--bg-elevated);
    border-color: var(--border-default);
  }

  .resource-item.assigned {
    background: rgba(99, 102, 241, 0.1);
    border-color: var(--accent-primary);
  }

  .resource-item-name {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text-primary);
  }

  .resource-item-action {
    font-size: 0.7rem;
    color: var(--accent-primary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
</style>

<script>
  import { api } from '../scripts/api';
  import type { Project, Agent, OutputRequirement } from '../types';

  // Global state
  let projects: Project[] = [];
  let selectedProjectId: string | null = null;
  let isEditing = false;
  let availableAgents: Agent[] = [];
  let availableRequirements: OutputRequirement[] = [];

  // Initialize
  document.addEventListener('DOMContentLoaded', async () => {
    await Promise.all([
      loadProjects(),
      loadAvailableResources()
    ]);
    setupEventListeners();
  });

  // Data loading
  async function loadProjects() {
    try {
      const response = await api.projects.list();
      projects = response.projects || [];
      renderProjectList();
      
      if (projects.length > 0 && !selectedProjectId) {
        selectProject(projects[0].id);
      }
    } catch (error) {
      console.error('Failed to load projects:', error);
      showToast('Failed to load projects', 'error');
    }
  }

  async function loadAvailableResources() {
    try {
      availableAgents = await api.agents.list();
      availableRequirements = await api.requirements.list();
    } catch (error) {
      console.error('Failed to load resources:', error);
    }
  }

  // UI rendering
  function renderProjectList() {
    const container = document.getElementById('project-list');
    if (!container) return;

    if (projects.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
          <h3>No projects yet</h3>
          <p>Create your first project to organize your work</p>
          <button class="btn-primary" onclick="startNewProject()">Create Project</button>
        </div>
      `;
      return;
    }

    container.innerHTML = projects.map(project => `
      <div class="item-card ${project.id === selectedProjectId ? 'active' : ''}" onclick="selectProject('${project.id}')">
        <div class="item-card-header">
          <span class="item-name">${escapeHtml(project.name)}</span>
        </div>
        ${project.description ? `<span class="item-preview">${escapeHtml(project.description)}</span>` : ''}
        <div class="item-meta">
          <span>Created: ${project.created_at ? new Date(project.created_at).toLocaleDateString() : 'Unknown'}</span>
        </div>
      </div>
    `).join('');
  }

  function renderProjectEditor(project?: Project) {
    const content = document.getElementById('project-editor-content');
    const form = document.getElementById('project-form');
    
    if (!content || !form) return;

    if (!project) {
      content.style.display = 'flex';
      form.style.display = 'none';
      return;
    }

    content.style.display = 'none';
    form.style.display = 'flex';

    // Populate form
    const idInput = document.getElementById('project-id') as HTMLInputElement;
    const nameInput = document.getElementById('project-name') as HTMLInputElement;
    const descriptionInput = document.getElementById('project-description') as HTMLTextAreaElement;
    const contextInput = document.getElementById('project-context') as HTMLTextAreaElement;

    if (idInput) idInput.value = project.id || '';
    if (nameInput) nameInput.value = project.name || '';
    if (descriptionInput) descriptionInput.value = project.description || '';
    if (contextInput) contextInput.value = project.context || '';

    // Show/hide action buttons
    const exportBtn = document.getElementById('export-project-btn');
    const deleteBtn = document.getElementById('delete-project-btn');
    
    if (exportBtn && deleteBtn) {
      if (project.id) {
        exportBtn.style.display = 'flex';
        deleteBtn.style.display = 'flex';
      } else {
        exportBtn.style.display = 'none';
        deleteBtn.style.display = 'none';
      }
    }
  }

  function renderProjectResources(project?: Project) {
    const container = document.getElementById('project-resources-content');
    if (!container) return;

    if (!project) {
      container.innerHTML = `
        <div class="empty-resources">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
          </svg>
          <h3>No Resources</h3>
          <p>Select a project to see its resources</p>
        </div>
      `;
      return;
    }

    // For now, show a basic summary
    container.innerHTML = `
      <div class="resource-summary">
        <h4>Resource Summary</h4>
        <div class="resource-stats">
          <div class="resource-stat">
            <div class="resource-stat-value">0</div>
            <div class="resource-stat-label">Agents</div>
          </div>
          <div class="resource-stat">
            <div class="resource-stat-value">0</div>
            <div class="resource-stat-label">Templates</div>
          </div>
          <div class="resource-stat">
            <div class="resource-stat-value">0</div>
            <div class="resource-stat-label">Requirements</div>
          </div>
        </div>
      </div>
    `;

    const manageBtn = document.getElementById('manage-resources-btn');
    if (manageBtn) manageBtn.style.display = 'flex';
  }

  // Project management
  function selectProject(id: string) {
    selectedProjectId = id;
    const project = projects.find(p => p.id === id);
    
    renderProjectList();
    renderProjectEditor(project);
    renderProjectResources(project);
    
    isEditing = false;
  }

  function startNewProject() {
    selectedProjectId = null;
    isEditing = true;
    
    const newProject: Partial<Project> = {
      name: '',
      description: '',
      context: ''
    };
    
    renderProjectEditor(newProject as Project);
    renderProjectResources();
    
    const nameInput = document.getElementById('project-name') as HTMLInputElement;
    if (nameInput) nameInput.focus();
  }

  async function saveProject() {
    const idInput = document.getElementById('project-id') as HTMLInputElement;
    const nameInput = document.getElementById('project-name') as HTMLInputElement;
    const descriptionInput = document.getElementById('project-description') as HTMLTextAreaElement;
    const contextInput = document.getElementById('project-context') as HTMLTextAreaElement;

    if (!nameInput) return;

    const name = nameInput.value.trim();
    const description = descriptionInput?.value.trim() || '';
    const context = contextInput?.value.trim() || '';

    if (!name) {
      showToast('Project name is required', 'error');
      return;
    }

    try {
      const projectData = { name, description, context };
      const isUpdate = idInput && idInput.value;

      let savedProject: Project;
      if (isUpdate) {
        savedProject = await api.projects.update(idInput.value, projectData);
        showToast('Project updated!');
      } else {
        savedProject = await api.projects.create(projectData);
        showToast('Project created!');
      }

      await loadProjects();
      selectProject(savedProject.id);
      isEditing = false;
    } catch (error) {
      console.error('Failed to save project:', error);
      showToast('Failed to save project', 'error');
    }
  }

  async function deleteProject() {
    if (!selectedProjectId) return;

    const project = projects.find(p => p.id === selectedProjectId);
    if (!project) return;

    if (!confirm(`Delete project "${project.name}"? This cannot be undone.`)) {
      return;
    }

    try {
      await api.projects.delete(selectedProjectId);
      showToast('Project deleted');
      
      await loadProjects();
      
      if (projects.length > 0) {
        selectProject(projects[0].id);
      } else {
        selectedProjectId = null;
        renderProjectEditor();
        renderProjectResources();
      }
    } catch (error) {
      console.error('Failed to delete project:', error);
      showToast('Failed to delete project', 'error');
    }
  }

  function cancelEdit() {
    isEditing = false;
    
    if (selectedProjectId) {
      const project = projects.find(p => p.id === selectedProjectId);
      renderProjectEditor(project);
    } else {
      renderProjectEditor();
    }
  }

  // Utility functions
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function showToast(message: string, type: 'success' | 'error' = 'success') {
    const toast = document.getElementById('toast');
    if (toast) {
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  }

  // Event listeners
  function setupEventListeners() {
    // New project button
    document.getElementById('new-project-btn')?.addEventListener('click', startNewProject);
    document.getElementById('empty-new-project-btn')?.addEventListener('click', startNewProject);
    
    // Form actions
    document.getElementById('save-project-btn')?.addEventListener('click', saveProject);
    document.getElementById('cancel-project-btn')?.addEventListener('click', cancelEdit);
    document.getElementById('delete-project-btn')?.addEventListener('click', deleteProject);
    
    // Search
    document.getElementById('project-search')?.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      const query = target.value.toLowerCase();
      
      const cards = document.querySelectorAll('.item-card');
      cards.forEach(card => {
        const name = card.querySelector('.item-name')?.textContent?.toLowerCase() || '';
        const preview = card.querySelector('.item-preview')?.textContent?.toLowerCase() || '';
        
        if (name.includes(query) || preview.includes(query)) {
          (card as HTMLElement).style.display = 'block';
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });
    });

    // Resource management modal tabs
    document.querySelectorAll('.resource-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.getAttribute('data-tab');
        if (!tabName) return;

        // Update active tab
        document.querySelectorAll('.resource-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // Show corresponding content
        document.querySelectorAll('.resource-tab-content').forEach(content => {
          content.style.display = 'none';
        });
        const content = document.getElementById(`${tabName}-tab`) as HTMLElement;
        if (content) content.style.display = 'grid';
      });
    });
  }

  // Make functions available globally
  (window as any).selectProject = selectProject;
  (window as any).startNewProject = startNewProject;
</script>