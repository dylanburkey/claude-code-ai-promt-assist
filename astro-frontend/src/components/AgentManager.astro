---
// DEPRECATED: This component has been replaced by SimpleAgentManager.astro
// This file is kept for reference but should not be used in production
// Use SimpleAgentManager.astro instead for the simplified implementation

import type { Agent } from '../types';
import Button from './ui/Button.astro';
import Modal from './ui/Modal.astro';
import Form from './ui/Form.astro';

export interface Props {
  initialAgents?: Agent[];
  currentProjectId?: string | null;
  selectedAgentId?: string | null;
  onAgentChange?: (agents: Agent[]) => void;
}

const { 
  initialAgents = [], 
  currentProjectId = null, 
  selectedAgentId = null 
} = Astro.props;
---

<!-- Agent Management Section -->
<div class="collapsible-section collapsed" id="agents-section" data-agent-manager>
  <div class="collapsible-header">
    <span class="collapsible-title">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      All Agents
      <span class="count" id="agents-count">0</span>
    </span>
    <div class="collapsible-actions">
      <button class="btn-ghost btn-xs" id="new-agent-btn" title="Add new agent">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </button>
      <svg class="chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="6 9 12 15 18 9"/>
      </svg>
    </div>
  </div>
  <div class="collapsible-content">
    <div id="agent-list" class="collapsible-list">
      <div class="empty-state">Loading agents...</div>
    </div>
  </div>
</div>

<!-- Agent Modal -->
<div class="modal-overlay" id="agent-modal">
  <div class="modal">
    <h2 id="agent-modal-title">Create New Agent</h2>
    <form id="agent-form">
      <input type="hidden" id="agent-id" />
      
      <div class="input-group">
        <label for="agent-name">Agent Name</label>
        <input 
          type="text" 
          id="agent-name" 
          placeholder="e.g., Senior Developer, Code Reviewer" 
          required 
        />
      </div>
      
      <div class="input-group">
        <label for="agent-role">Agent Persona</label>
        <textarea 
          id="agent-role" 
          placeholder="Describe the agent's role, expertise, and personality..."
          rows="4"
          required
        ></textarea>
      </div>
      
      <div class="input-group">
        <label for="agent-style">Output Style (Optional)</label>
        <textarea 
          id="agent-style" 
          placeholder="Specify preferred output format, tone, or structure..."
          rows="3"
        ></textarea>
      </div>
      
      <div class="modal-actions">
        <button 
          type="button"
          id="btn-delete-agent" 
          class="btn-secondary" 
          style="margin-right: auto; display: none; color: #ef4444; border-color: #ef4444;"
        >
          Delete
        </button>
        <button type="button" class="btn-secondary" id="btn-cancel-agent">
          Cancel
        </button>
        <button 
          type="submit"
          id="btn-save-agent" 
          class="btn-primary"
        >
          Save Agent
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Current Agent Selection Display -->
<div class="selection-tag" id="current-agent-display">
  <span class="selection-tag-name">No agent selected</span>
  <span class="selection-tag-status">Select from sidebar</span>
  <div class="selection-tag-actions">
    <Button 
      variant="ghost" 
      size="xs" 
      onclick="clearAgentSelection()" 
      title="Clear selection"
      style="display: none;"
      id="clear-agent-btn"
    >
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </Button>
  </div>
</div>

<script>
  // Client-side agent management functionality
  class AgentManager {
    constructor() {
      this.agents = [];
      this.selectedAgentId = null;
      this.currentProjectId = null;
      this.init();
    }

    async init() {
      try {
        await this.loadAgents();
        this.setupEventListeners();
        this.setupStateSubscriptions();
      } catch (error) {
        console.error('Failed to initialize agent manager:', error);
        this.showToast('Failed to load agents', 'error');
      }
    }

    setupEventListeners() {
      // Collapsible header
      const header = document.querySelector('#agents-section .collapsible-header');
      if (header) {
        header.addEventListener('click', () => {
          const section = document.getElementById('agents-section');
          if (section) section.classList.toggle('collapsed');
        });
      }

      // New agent button
      const newAgentBtn = document.getElementById('new-agent-btn');
      if (newAgentBtn) {
        newAgentBtn.addEventListener('click', () => this.openAgentModal());
      }

      // Modal form
      const form = document.getElementById('agent-form');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          this.saveAgent();
        });
      }

      // Modal buttons
      const cancelBtn = document.getElementById('btn-cancel-agent');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => this.closeAgentModal());
      }

      const deleteBtn = document.getElementById('btn-delete-agent');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', () => this.deleteAgent());
      }

      // Modal overlay click to close
      const modal = document.getElementById('agent-modal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) this.closeAgentModal();
        });
      }
    }

    setupStateSubscriptions() {
      // Listen for state changes from the global app state
      if (window.appState) {
        window.appState.subscribe((newState, oldState) => {
          if (newState.agents !== oldState.agents) {
            this.agents = newState.agents;
            this.renderAgentList();
            this.updateAgentCount();
          }
          
          if (newState.ui.selectedAgentId !== oldState.ui.selectedAgentId) {
            this.selectedAgentId = newState.ui.selectedAgentId;
            this.updateAgentSelection();
          }
          
          if (newState.ui.currentProjectId !== oldState.ui.currentProjectId) {
            this.currentProjectId = newState.ui.currentProjectId;
            this.renderAgentList();
          }
        });
      }
    }

    async loadAgents() {
      try {
        // Use fetch directly since we can't import modules in script tags
        const response = await fetch('/api/agents');
        if (!response.ok) throw new Error('Failed to load agents');
        
        this.agents = await response.json();
        this.updateAgentCount();
        this.renderAgentList();
        
        // Auto-select first agent if none selected and agents exist
        if (this.agents.length > 0 && !this.selectedAgentId) {
          this.selectAgent(this.agents[0].id);
        }
      } catch (error) {
        console.error('Failed to load agents:', error);
        const container = document.getElementById('agent-list');
        if (container) {
          container.innerHTML = '<div class="empty-state">Failed to load agents</div>';
        }
      }
    }

    renderAgentList() {
      const container = document.getElementById('agent-list');
      if (!container) return;

      if (this.agents.length === 0) {
        container.innerHTML = '<div class="empty-state">No agents yet. Create one!</div>';
        return;
      }

      container.innerHTML = this.agents
        .map(agent => `
          <div class="item-card ${agent.id === this.selectedAgentId ? 'active' : ''}" 
               data-agent-id="${agent.id}">
            <div class="item-card-header">
              <span class="item-name">${this.escapeHtml(agent.name)}</span>
              <div class="resource-actions">
                <button class="btn-ghost btn-xs edit-agent-btn" 
                        data-agent-id="${agent.id}"
                        title="Edit">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                ${this.currentProjectId ? `
                  <button class="btn-ghost btn-xs assign-agent-btn" 
                          data-agent-id="${agent.id}"
                          title="Add to project">
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="12" y1="5" x2="12" y2="19"/>
                      <line x1="5" y1="12" x2="19" y2="12"/>
                    </svg>
                  </button>
                ` : ''}
              </div>
            </div>
            <span class="item-preview">${this.escapeHtml(agent.role)}</span>
          </div>
        `)
        .join('');

      // Add event listeners to the newly created elements
      container.querySelectorAll('.item-card').forEach(card => {
        card.addEventListener('click', () => {
          const agentId = card.getAttribute('data-agent-id');
          if (agentId) this.selectAgent(agentId);
        });
      });

      container.querySelectorAll('.edit-agent-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const agentId = btn.getAttribute('data-agent-id');
          if (agentId) this.editAgent(agentId);
        });
      });

      container.querySelectorAll('.assign-agent-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const agentId = btn.getAttribute('data-agent-id');
          if (agentId) this.assignAgentToProject(agentId);
        });
      });
    }

    updateAgentCount() {
      const countElement = document.getElementById('agents-count');
      if (countElement) {
        countElement.textContent = this.agents.length.toString();
      }
    }

    updateAgentSelection() {
      const display = document.getElementById('current-agent-display');
      const clearBtn = document.getElementById('clear-agent-btn');
      
      if (!display) return;

      if (this.selectedAgentId) {
        const agent = this.agents.find(a => a.id === this.selectedAgentId);
        if (agent) {
          display.innerHTML = `
            <span class="selection-tag-name">${this.escapeHtml(agent.name)}</span>
            <span class="selection-tag-status">Active</span>
          `;
          display.classList.add('has-selection');
          if (clearBtn) clearBtn.style.display = 'block';
        }
      } else {
        display.innerHTML = `
          <span class="selection-tag-name">No agent selected</span>
          <span class="selection-tag-status">Select from sidebar</span>
        `;
        display.classList.remove('has-selection');
        if (clearBtn) clearBtn.style.display = 'none';
      }
      
      this.renderAgentList(); // Re-render to update active states
    }

    selectAgent(id) {
      this.selectedAgentId = id;
      
      // Update global state if available
      if (window.actions) {
        window.actions.setSelectedAgent(id);
      }
      
      // Update local display
      this.updateAgentSelection();
      
      // Also update the main page display
      if (window.selectAgent) {
        window.selectAgent(id);
      }
    }

    clearAgentSelection() {
      this.selectAgent(null);
    }

    openAgentModal() {
      const modal = document.getElementById('agent-modal');
      const title = document.getElementById('agent-modal-title');
      const deleteBtn = document.getElementById('btn-delete-agent');
      
      if (title) title.textContent = 'Create New Agent';
      if (deleteBtn) deleteBtn.style.display = 'none';
      
      // Clear form
      const form = document.getElementById('agent-form');
      if (form) form.reset();
      
      const agentId = document.getElementById('agent-id');
      if (agentId) agentId.value = '';
      
      if (modal) modal.classList.add('open');
    }

    editAgent(id) {
      const agent = this.agents.find(a => a.id === id);
      if (!agent) return;

      const modal = document.getElementById('agent-modal');
      const title = document.getElementById('agent-modal-title');
      const deleteBtn = document.getElementById('btn-delete-agent');
      
      if (title) title.textContent = 'Edit Agent';
      if (deleteBtn) deleteBtn.style.display = 'block';
      
      // Populate form
      const agentId = document.getElementById('agent-id');
      const agentName = document.getElementById('agent-name');
      const agentRole = document.getElementById('agent-role');
      const agentStyle = document.getElementById('agent-style');
      
      if (agentId) agentId.value = agent.id;
      if (agentName) agentName.value = agent.name;
      if (agentRole) agentRole.value = agent.role;
      if (agentStyle) agentStyle.value = agent.style || '';
      
      if (modal) modal.classList.add('open');
    }

    closeAgentModal() {
      const modal = document.getElementById('agent-modal');
      if (modal) modal.classList.remove('open');
    }

    async saveAgent() {
      const agentId = document.getElementById('agent-id')?.value;
      const name = document.getElementById('agent-name')?.value.trim();
      const role = document.getElementById('agent-role')?.value.trim();
      const style = document.getElementById('agent-style')?.value.trim();

      if (!name || !role) {
        this.showToast('Name and persona are required', 'error');
        return;
      }

      const btn = document.getElementById('btn-save-agent');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span> Saving...';
      }

      try {
        const agentData = { name, role, style: style || undefined };
        let result;

        if (agentId) {
          // Update existing agent
          const response = await fetch(`/api/agents/${agentId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(agentData)
          });
          if (!response.ok) throw new Error('Failed to update agent');
          result = await response.json();
          
          // Update local state
          const index = this.agents.findIndex(a => a.id === agentId);
          if (index !== -1) {
            this.agents[index] = result;
          }
          
          this.showToast('Agent updated');
        } else {
          // Create new agent
          const response = await fetch('/api/agents', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(agentData)
          });
          if (!response.ok) throw new Error('Failed to create agent');
          result = await response.json();
          
          // Add to local state
          this.agents.unshift(result);
          this.selectAgent(result.id);
          
          this.showToast('Agent created');
        }
        
        this.renderAgentList();
        this.updateAgentCount();
        this.closeAgentModal();
      } catch (error) {
        console.error('Failed to save agent:', error);
        this.showToast(error.message || 'Failed to save agent', 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Save Agent';
        }
      }
    }

    async deleteAgent() {
      const agentId = document.getElementById('agent-id')?.value;
      if (!agentId || !confirm('Delete this agent?')) return;

      try {
        const response = await fetch(`/api/agents/${agentId}`, { method: 'DELETE' });
        if (!response.ok) throw new Error('Failed to delete agent');
        
        // Remove from local state
        this.agents = this.agents.filter(a => a.id !== agentId);
        
        // Clear selection if deleted agent was selected
        if (this.selectedAgentId === agentId) {
          this.selectedAgentId = this.agents.length > 0 ? this.agents[0].id : null;
          this.updateAgentSelection();
        }
        
        this.renderAgentList();
        this.updateAgentCount();
        this.closeAgentModal();
        this.showToast('Agent deleted');
      } catch (error) {
        console.error('Failed to delete agent:', error);
        this.showToast(error.message || 'Failed to delete agent', 'error');
      }
    }

    async assignAgentToProject(agentId) {
      if (!this.currentProjectId) {
        this.showToast('Select a project first', 'error');
        return;
      }

      try {
        const response = await fetch(`/api/projects/${this.currentProjectId}/resources`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ resourceId: agentId, resourceType: 'agent' })
        });
        if (!response.ok) throw new Error('Failed to assign agent');
        
        this.showToast('Agent added to project');
      } catch (error) {
        console.error('Failed to assign agent:', error);
        this.showToast('Failed to add agent to project', 'error');
      }
    }

    escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    showToast(message, type = 'success') {
      // Use global toast function if available
      if (window.showToast) {
        window.showToast(message, type);
        return;
      }
      
      // Fallback toast implementation
      const toast = document.getElementById('toast');
      if (toast) {
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        setTimeout(() => toast.classList.remove('show'), 3000);
      }
    }
  }

  // Initialize agent manager when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      window.agentManager = new AgentManager();
    });
  } else {
    window.agentManager = new AgentManager();
  }

  // Export functions for global access (maintaining compatibility with original)
  window.selectAgent = (id) => window.agentManager?.selectAgent(id);
  window.clearAgentSelection = () => window.agentManager?.clearAgentSelection();
  window.openAgentModal = () => window.agentManager?.openAgentModal();
  window.editAgent = (id) => window.agentManager?.editAgent(id);
  window.closeAgentModal = () => window.agentManager?.closeAgentModal();
  window.saveAgent = () => window.agentManager?.saveAgent();
  window.deleteAgent = () => window.agentManager?.deleteAgent();
  window.assignAgentToProject = (id) => window.agentManager?.assignAgentToProject(id);
</script>

<style>
  /* Collapsible Section Styles */
  .collapsible-section {
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .collapsible-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: var(--bg-surface);
    cursor: pointer;
    user-select: none;
    transition: var(--transition-fast);
  }

  .collapsible-header:hover {
    background: var(--bg-elevated);
  }

  .collapsible-title {
    font-family: var(--font-display);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .collapsible-title .count {
    background: var(--accent-primary);
    color: white;
    font-size: 0.65rem;
    padding: 0.1rem 0.4rem;
    border-radius: 10px;
  }

  .collapsible-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .chevron {
    transition: transform var(--transition-fast);
    color: var(--text-muted);
  }

  .collapsible-section.collapsed .chevron {
    transform: rotate(-90deg);
  }

  .collapsible-content {
    max-height: 400px;
    overflow-y: auto;
    transition: max-height 0.3s ease;
  }

  .collapsible-section.collapsed .collapsible-content {
    max-height: 0;
    overflow: hidden;
  }

  .collapsible-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.5rem;
  }

  /* Item Card Styles */
  .item-card {
    background: var(--bg-base);
    padding: 0.75rem;
    border-radius: var(--radius-sm);
    border: 1px solid transparent;
    cursor: pointer;
    transition: var(--transition-fast);
  }

  .item-card:hover {
    background: var(--bg-elevated);
    border-color: var(--border-default);
  }

  .item-card.active {
    background: rgba(99, 102, 241, 0.1);
    border-color: var(--accent-primary);
  }

  .item-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
  }

  .item-name {
    font-family: var(--font-display);
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-primary);
  }

  .item-preview {
    font-size: 0.75rem;
    color: var(--text-muted);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    line-height: 1.4;
  }

  .resource-actions {
    display: flex;
    gap: 0.25rem;
  }

  /* Selection Tag Styles */
  .selection-tag {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    padding: 0.625rem 0.875rem;
    border-radius: var(--radius-md);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.85rem;
  }

  .selection-tag.has-selection {
    background: rgba(99, 102, 241, 0.08);
    border-color: rgba(99, 102, 241, 0.3);
  }

  .selection-tag-name {
    font-family: var(--font-display);
    font-weight: 600;
  }

  .selection-tag-status {
    font-size: 0.65rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .selection-tag-actions {
    display: flex;
    gap: 0.25rem;
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--transition-normal);
    padding: 1rem;
  }

  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: var(--bg-surface);
    padding: 1.75rem;
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 500px;
    border: 1px solid var(--border-default);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal h2 {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }

  .modal-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
    justify-content: flex-end;
  }

  /* Form Styles */
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .input-group label {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .input-group input,
  .input-group textarea {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    color: var(--text-primary);
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    width: 100%;
    font-family: var(--font-body);
    font-size: 0.875rem;
    transition: var(--transition-fast);
  }

  .input-group input::placeholder,
  .input-group textarea::placeholder {
    color: var(--text-muted);
  }

  .input-group input:focus,
  .input-group textarea:focus {
    outline: none;
    border-color: var(--accent-primary);
    background: var(--bg-elevated);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .input-group textarea {
    resize: vertical;
    min-height: 80px;
  }

  /* Button Styles */
  .btn-primary,
  .btn-secondary,
  .btn-ghost {
    cursor: pointer;
    border: none;
    border-radius: var(--radius-md);
    padding: 0.625rem 1rem;
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 500;
    transition: var(--transition-fast);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-primary {
    background: var(--accent-primary);
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: var(--accent-primary-hover);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border-default);
  }

  .btn-secondary:hover:not(:disabled) {
    border-color: var(--text-muted);
    color: var(--text-primary);
    background: var(--bg-hover);
  }

  .btn-ghost {
    background: transparent;
    color: var(--text-muted);
    padding: 0.25rem;
  }

  .btn-ghost:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
  }

  .btn-xs {
    padding: 0.2rem 0.4rem;
    font-size: 0.7rem;
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>