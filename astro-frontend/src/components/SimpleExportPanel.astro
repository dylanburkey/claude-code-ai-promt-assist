---
import Button from './ui/Button.astro';
import Modal from './ui/Modal.astro';
import Form from './ui/Form.astro';
---

<!-- Export Panel Content -->
<div class="panel-header">
  <span class="panel-title">Export</span>
  <div class="header-actions">
    <Button variant="primary" size="sm" id="open-export-modal-btn">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" y1="15" x2="12" y2="3" />
      </svg>
      Export Project
    </Button>
  </div>
</div>

<div class="export-info">
  <div class="export-summary">
    <h3>Export Options</h3>
    <p>Export your project data in various formats for backup or sharing.</p>
  </div>

  <div class="export-formats">
    <div class="format-card">
      <div class="format-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14 2 14 8 20 8" />
          <line x1="16" y1="13" x2="8" y2="13" />
          <line x1="16" y1="17" x2="8" y2="17" />
        </svg>
      </div>
      <div class="format-info">
        <h4>Claude Code</h4>
        <p>Optimized XML format for Claude Code IDE integration</p>
      </div>
    </div>

    <div class="format-card">
      <div class="format-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14 2 14 8 20 8" />
          <line x1="16" y1="13" x2="8" y2="13" />
          <line x1="16" y1="17" x2="8" y2="17" />
        </svg>
      </div>
      <div class="format-info">
        <h4>JSON</h4>
        <p>Structured data format for programmatic use</p>
      </div>
    </div>

    <div class="format-card">
      <div class="format-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 22h2a2 2 0 0 0 2-2V7.5L14.5 2H6a2 2 0 0 0-2 2v3" />
          <polyline points="14 2 14 8 20 8" />
          <path d="M10 20v-1a2 2 0 1 1 4 0v1a2 2 0 1 1-4 0Z" />
          <path d="M10 7h4" />
          <path d="M10 11h4" />
        </svg>
      </div>
      <div class="format-info">
        <h4>ZIP Archive</h4>
        <p>Complete project backup with all resources</p>
      </div>
    </div>
  </div>
</div>

<!-- Export Modal -->
<Modal id="export-modal" title="Export Project">
  <Form>
    <label for="export-format">Export Format</label>
    <select id="export-format" required>
      <option value="claude-code">Claude Code XML</option>
      <option value="json">JSON Data</option>
      <option value="zip">ZIP Archive</option>
    </select>
  </Form>

  <Form>
    <label for="export-filename">Filename</label>
    <input type="text" id="export-filename" placeholder="project-export" required />
  </Form>

  <Form>
    <label>Include Components</label>
    <div class="checkbox-group">
      <label class="checkbox-label">
        <input type="checkbox" id="include-agents" checked />
        <span>Agents</span>
      </label>
      <label class="checkbox-label">
        <input type="checkbox" id="include-rules" checked />
        <span>Rules</span>
      </label>
      <label class="checkbox-label">
        <input type="checkbox" id="include-hooks" />
        <span>Hooks</span>
      </label>
      <label class="checkbox-label">
        <input type="checkbox" id="include-prompts" />
        <span>Generated Prompts</span>
      </label>
    </div>
  </Form>

  <div id="export-progress" class="export-progress" style="display: none;">
    <div class="progress-header">
      <span class="progress-title">Exporting...</span>
      <span class="progress-status" id="progress-status">Preparing export</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
    </div>
  </div>

  <div class="modal-actions">
    <Button variant="secondary" id="btn-cancel-export">Cancel</Button>
    <Button variant="primary" id="btn-start-export">Export</Button>
  </div>
</Modal>

<style>
  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-subtle);
    margin-bottom: 1.5rem;
  }

  .panel-title {
    font-family: var(--font-display);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }

  .export-info {
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .export-summary h3 {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .export-summary p {
    color: var(--text-secondary);
    line-height: 1.5;
  }

  .export-formats {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .format-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    transition: var(--transition-fast);
  }

  .format-card:hover {
    background: var(--bg-elevated);
    border-color: var(--border-default);
  }

  .format-icon {
    color: var(--accent-primary);
    flex-shrink: 0;
  }

  .format-info h4 {
    font-family: var(--font-display);
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
  }

  .format-info p {
    font-size: 0.8rem;
    color: var(--text-muted);
    line-height: 1.4;
  }

  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-primary);
    cursor: pointer;
  }

  .checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    accent-color: var(--accent-primary);
  }

  .export-progress {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    padding: 1rem;
    margin: 1rem 0;
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .progress-title {
    font-weight: 600;
    color: var(--text-primary);
  }

  .progress-status {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .progress-bar {
    width: 100%;
    height: 4px;
    background: var(--bg-elevated);
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--accent-primary);
    transition: width 0.3s ease;
  }

  select {
    width: 100%;
    padding: 0.75rem;
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 0.875rem;
    cursor: pointer;
  }

  select:focus {
    outline: none;
    border-color: var(--accent-primary);
  }
</style>

<script>
  import { api } from '../scripts/api';

  let currentProjectId: string | null = null;

  document.addEventListener('DOMContentLoaded', () => {
    setupEventListeners();
    
    // Listen for project changes
    document.addEventListener('project-changed', (event: CustomEvent) => {
      currentProjectId = event.detail.projectId;
    });
  });

  function setupEventListeners() {
    document.getElementById('open-export-modal-btn')?.addEventListener('click', openExportModal);
    document.getElementById('btn-start-export')?.addEventListener('click', startExport);
    document.getElementById('btn-cancel-export')?.addEventListener('click', closeExportModal);
    
    // Format change handler
    document.getElementById('export-format')?.addEventListener('change', handleFormatChange);
  }

  function openExportModal() {
    const modal = document.getElementById('export-modal');
    const filenameInput = document.getElementById('export-filename') as HTMLInputElement;
    
    // Set default filename
    if (filenameInput) {
      filenameInput.value = currentProjectId ? `project-${currentProjectId}` : 'project-export';
    }
    
    if (modal) modal.style.display = 'flex';
  }

  function closeExportModal() {
    const modal = document.getElementById('export-modal');
    const progress = document.getElementById('export-progress');
    
    if (progress) progress.style.display = 'none';
    if (modal) modal.style.display = 'none';
  }

  function handleFormatChange() {
    const formatSelect = document.getElementById('export-format') as HTMLSelectElement;
    const includePrompts = document.getElementById('include-prompts') as HTMLInputElement;
    
    if (!formatSelect || !includePrompts) return;
    
    // Disable prompts for Claude Code format
    if (formatSelect.value === 'claude-code') {
      includePrompts.checked = false;
      includePrompts.disabled = true;
    } else {
      includePrompts.disabled = false;
    }
  }

  async function startExport() {
    const formatSelect = document.getElementById('export-format') as HTMLSelectElement;
    const filenameInput = document.getElementById('export-filename') as HTMLInputElement;
    const includeAgents = document.getElementById('include-agents') as HTMLInputElement;
    const includeRules = document.getElementById('include-rules') as HTMLInputElement;
    const includeHooks = document.getElementById('include-hooks') as HTMLInputElement;
    const includePrompts = document.getElementById('include-prompts') as HTMLInputElement;

    if (!formatSelect || !filenameInput) return;

    const format = formatSelect.value;
    const filename = filenameInput.value.trim();

    if (!filename) {
      showToast('Please enter a filename', 'error');
      return;
    }

    if (!currentProjectId) {
      showToast('No project selected', 'error');
      return;
    }

    const include = {
      agents: includeAgents?.checked || false,
      rules: includeRules?.checked || false,
      hooks: includeHooks?.checked || false,
      prompts: includePrompts?.checked || false
    };

    try {
      showProgress('Preparing export...', 10);
      
      const exportConfig = {
        format,
        filename,
        include
      };

      showProgress('Generating export...', 50);
      
      const response = await api.export.project(currentProjectId, exportConfig);
      
      showProgress('Download ready!', 100);
      
      // Trigger download
      if (response.downloadUrl) {
        const link = document.createElement('a');
        link.href = response.downloadUrl;
        link.download = `${filename}.${format === 'claude-code' ? 'xml' : format}`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      showToast('Export completed successfully!');
      setTimeout(() => closeExportModal(), 1000);
      
    } catch (error) {
      console.error('Export failed:', error);
      showToast('Export failed', 'error');
      hideProgress();
    }
  }

  function showProgress(status: string, percentage: number) {
    const progress = document.getElementById('export-progress');
    const statusEl = document.getElementById('progress-status');
    const fillEl = document.getElementById('progress-fill');
    
    if (progress) progress.style.display = 'block';
    if (statusEl) statusEl.textContent = status;
    if (fillEl) fillEl.style.width = `${percentage}%`;
  }

  function hideProgress() {
    const progress = document.getElementById('export-progress');
    if (progress) progress.style.display = 'none';
  }

  function showToast(message: string, type: 'success' | 'error' = 'success') {
    const toast = document.getElementById('toast');
    if (toast) {
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  }

  // Make functions available globally
  (window as any).openExportModal = openExportModal;
  (window as any).closeExportModal = closeExportModal;
</script>