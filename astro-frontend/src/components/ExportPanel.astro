---
// DEPRECATED: This component has been replaced by SimpleExportPanel.astro
// This file is kept for reference but should not be used in production
// Use SimpleExportPanel.astro instead for the simplified implementation

import type { Project } from '../types';
import Button from './ui/Button.astro';
import Modal from './ui/Modal.astro';
import Form from './ui/Form.astro';

export interface Props {
  currentProjectId?: string | null;
  onExportComplete?: (result: any) => void;
}

const { 
  currentProjectId = null 
} = Astro.props;
---

<!-- Export Panel Component -->
<div class="export-panel" id="export-panel">
  <div class="panel-header">
    <span class="panel-title">Export</span>
    <div class="header-actions">
      <Button 
        variant="primary" 
        size="sm" 
        id="export-project-btn"
        style="display: none;"
      >
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="7 10 12 15 17 10" />
          <line x1="12" y1="15" x2="12" y2="3" />
        </svg>
        Export Project
      </Button>
    </div>
  </div>

  <!-- Export Progress Display -->
  <div id="export-progress-container" class="progress-container" style="display: none;">
    <div class="progress-header">
      <span class="progress-title">Exporting Project</span>
      <span class="progress-status" id="export-progress-status">Preparing...</span>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="export-progress-fill" style="width: 0%;"></div>
    </div>
    <div class="progress-steps" id="export-progress-steps">
      <span class="progress-step active">Prepare</span>
      <span class="progress-step">Generate</span>
      <span class="progress-step">Package</span>
      <span class="progress-step">Complete</span>
    </div>
  </div>

  <!-- Export Status Display -->
  <div class="export-status" id="export-status">
    <div class="empty-state">Select a project to enable export functionality</div>
  </div>
</div>

<!-- Export Configuration Modal -->
<div class="modal-overlay" id="export-modal">
  <div class="modal">
    <h2>Export Project Configuration</h2>
    <form id="export-form">
      <div class="input-group">
        <label for="export-format">Export Format</label>
        <select id="export-format">
          <option value="claude-code">Claude Code Project</option>
          <option value="json">JSON Configuration</option>
          <option value="zip">Complete Package (ZIP)</option>
        </select>
      </div>
      
      <div class="input-group">
        <label>Include Components</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="include-agents" checked>
            <span>Agents</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="include-rules" checked>
            <span>Rules</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="include-hooks" checked>
            <span>Hooks</span>
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="include-prompts" checked>
            <span>Saved Prompts</span>
          </label>
        </div>
      </div>
      
      <div class="input-group">
        <label for="export-filename">Filename</label>
        <input
          type="text"
          id="export-filename"
          placeholder="project-export"
          required
        />
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn-secondary" id="btn-cancel-export">
          Cancel
        </button>
        <button type="submit" class="btn-primary" id="btn-execute-export">
          Export Project
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // Client-side export functionality
  class ExportPanel {
    constructor() {
      this.currentProjectId = null;
      this.currentProjectContext = null;
      this.init();
    }

    async init() {
      try {
        this.setupEventListeners();
        this.setupStateSubscriptions();
        await this.updateExportStatus();
      } catch (error) {
        console.error('Failed to initialize export panel:', error);
        this.showToast('Failed to initialize export panel', 'error');
      }
    }

    setupEventListeners() {
      // Export project button
      const exportBtn = document.getElementById('export-project-btn');
      if (exportBtn) {
        exportBtn.addEventListener('click', () => this.openExportModal());
      }

      // Modal form
      const form = document.getElementById('export-form');
      if (form) {
        form.addEventListener('submit', (e) => {
          e.preventDefault();
          this.executeExport();
        });
      }

      // Modal buttons
      const cancelBtn = document.getElementById('btn-cancel-export');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', () => this.closeExportModal());
      }

      // Modal overlay click to close
      const modal = document.getElementById('export-modal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) this.closeExportModal();
        });
      }

      // Format change handler
      const formatSelect = document.getElementById('export-format');
      if (formatSelect) {
        formatSelect.addEventListener('change', () => this.updateExportOptions());
      }
    }

    setupStateSubscriptions() {
      // Listen for state changes from the global app state
      if (window.appState) {
        window.appState.subscribe((newState, oldState) => {
          if (newState.ui.currentProjectId !== oldState.ui.currentProjectId) {
            this.currentProjectId = newState.ui.currentProjectId;
            this.updateExportStatus();
          }
        });
      }
    }

    async updateExportStatus() {
      const statusEl = document.getElementById('export-status');
      const exportBtn = document.getElementById('export-project-btn');
      
      if (!statusEl || !exportBtn) return;

      if (!this.currentProjectId) {
        statusEl.innerHTML = '<div class="empty-state">Select a project to enable export functionality</div>';
        exportBtn.style.display = 'none';
        return;
      }

      try {
        // Load project context
        const response = await fetch(`/api/projects/${this.currentProjectId}`);
        if (!response.ok) throw new Error('Failed to load project');
        
        this.currentProjectContext = await response.json();
        
        statusEl.innerHTML = `
          <div class="export-ready">
            <div class="export-project-info">
              <h3>${this.escapeHtml(this.currentProjectContext.name)}</h3>
              <p class="project-description">${this.escapeHtml(this.currentProjectContext.description || 'No description')}</p>
            </div>
            <div class="export-stats">
              <div class="stat-item">
                <span class="stat-label">Resources</span>
                <span class="stat-value">${this.currentProjectContext.resourceCount || 0}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Last Modified</span>
                <span class="stat-value">${this.formatDate(this.currentProjectContext.updated_at)}</span>
              </div>
            </div>
          </div>
        `;
        
        exportBtn.style.display = 'flex';
      } catch (error) {
        console.error('Failed to load project context:', error);
        statusEl.innerHTML = '<div class="empty-state error">Failed to load project information</div>';
        exportBtn.style.display = 'none';
      }
    }

    openExportModal() {
      if (!this.currentProjectId) {
        this.showToast('Select a project to export', 'error');
        return;
      }

      const modal = document.getElementById('export-modal');
      const filenameInput = document.getElementById('export-filename');
      
      // Set default filename based on project
      if (filenameInput && this.currentProjectContext) {
        filenameInput.value = this.currentProjectContext.slug || 'project-export';
      }
      
      this.updateExportOptions();
      
      if (modal) modal.classList.add('open');
    }

    closeExportModal() {
      const modal = document.getElementById('export-modal');
      if (modal) modal.classList.remove('open');
    }

    updateExportOptions() {
      const format = document.getElementById('export-format')?.value;
      const includePrompts = document.getElementById('include-prompts');
      
      // Claude Code format doesn't typically include saved prompts
      if (includePrompts) {
        if (format === 'claude-code') {
          includePrompts.checked = false;
          includePrompts.disabled = true;
        } else {
          includePrompts.disabled = false;
        }
      }
    }

    async executeExport() {
      if (!this.currentProjectId) {
        this.showToast('No project selected', 'error');
        return;
      }

      const format = document.getElementById('export-format')?.value;
      const filename = document.getElementById('export-filename')?.value.trim();
      const includeAgents = document.getElementById('include-agents')?.checked;
      const includeRules = document.getElementById('include-rules')?.checked;
      const includeHooks = document.getElementById('include-hooks')?.checked;
      const includePrompts = document.getElementById('include-prompts')?.checked;

      if (!filename) {
        this.showToast('Filename is required', 'error');
        return;
      }

      const btn = document.getElementById('btn-execute-export');
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="loading-spinner"></span> Exporting...';
      }

      this.closeExportModal();
      this.showProgress();

      try {
        // Step 1: Preparing
        this.updateProgress('Preparing export...', 0, 0);
        await new Promise(resolve => setTimeout(resolve, 500));

        // Step 2: Generating
        this.updateProgress('Generating project structure...', 25, 1);
        
        const exportData = await this.callExportAPI(format, filename, {
          agents: includeAgents,
          rules: includeRules,
          hooks: includeHooks,
          prompts: includePrompts
        });

        // Step 3: Packaging
        this.updateProgress('Packaging export...', 75, 2);
        await new Promise(resolve => setTimeout(resolve, 500));

        // Step 4: Complete
        this.updateProgress('Export complete!', 100, 3);

        // Download the file
        if (exportData.downloadUrl) {
          const a = document.createElement('a');
          a.href = exportData.downloadUrl;
          a.download = `${filename}.${format === 'claude-code' ? 'zip' : format}`;
          a.click();
        }

        this.showToast('Project exported successfully!');
        
        setTimeout(() => {
          this.hideProgress();
        }, 2000);

      } catch (error) {
        console.error('Failed to export project:', error);
        this.showToast('Failed to export project', 'error');
        this.hideProgress();
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'Export Project';
        }
      }
    }

    async callExportAPI(format, filename, include) {
      const response = await fetch(`/api/export/claude-code/${this.currentProjectId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          format,
          filename,
          include
        })
      });

      if (!response.ok) {
        const error = await response.text();
        throw new Error(error || 'Export failed');
      }

      return response.json();
    }

    showProgress() {
      const container = document.getElementById('export-progress-container');
      if (container) container.style.display = 'block';
    }

    hideProgress() {
      const container = document.getElementById('export-progress-container');
      const fill = document.getElementById('export-progress-fill');
      const steps = document.querySelectorAll('#export-progress-steps .progress-step');
      
      if (container) container.style.display = 'none';
      if (fill) fill.style.width = '0%';
      
      steps.forEach((step, index) => {
        step.classList.remove('completed', 'active');
        if (index === 0) step.classList.add('active');
      });
    }

    updateProgress(status, percentage, stepIndex) {
      const statusEl = document.getElementById('export-progress-status');
      const fill = document.getElementById('export-progress-fill');
      const steps = document.querySelectorAll('#export-progress-steps .progress-step');

      if (statusEl) statusEl.textContent = status;
      if (fill) fill.style.width = `${percentage}%`;

      steps.forEach((step, index) => {
        step.classList.remove('completed', 'active');
        if (index < stepIndex) {
          step.classList.add('completed');
        } else if (index === stepIndex) {
          step.classList.add('active');
        }
      });
    }

    escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    formatDate(dateString) {
      if (!dateString) return 'Unknown';
      try {
        return new Date(dateString).toLocaleDateString();
      } catch {
        return 'Unknown';
      }
    }

    showToast(message, type = 'success') {
      // Use global toast function if available
      if (window.showToast) {
        window.showToast(message, type);
        return;
      }
      
      // Fallback toast implementation
      const toast = document.getElementById('toast');
      if (toast) {
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        setTimeout(() => toast.classList.remove('show'), 3000);
      }
    }
  }

  // Initialize export panel when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      window.exportPanel = new ExportPanel();
    });
  } else {
    window.exportPanel = new ExportPanel();
  }

  // Export functions for global access (maintaining compatibility with original)
  window.openExportModal = () => window.exportPanel?.openExportModal();
  window.closeExportModal = () => window.exportPanel?.closeExportModal();
  window.executeExport = () => window.exportPanel?.executeExport();
  window.exportProject = () => window.exportPanel?.openExportModal();
</script>

<style>
  .export-panel {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border-subtle);
  }

  .panel-title {
    font-family: var(--font-display);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }

  .header-actions {
    display: flex;
    gap: 0.5rem;
  }

  /* Export Status Styles */
  .export-status {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    min-height: 200px;
  }

  .empty-state {
    text-align: center;
    padding: 2rem 1rem;
    color: var(--text-muted);
    font-size: 0.85rem;
  }

  .empty-state.error {
    color: var(--accent-error);
  }

  .export-ready {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .export-project-info h3 {
    font-family: var(--font-display);
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 0.5rem 0;
  }

  .project-description {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin: 0;
    line-height: 1.4;
  }

  .export-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    padding: 1rem;
    background: var(--bg-surface);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-subtle);
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .stat-label {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    font-weight: 500;
  }

  .stat-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  /* Progress Styles */
  .progress-container {
    background: var(--bg-surface);
    border-radius: var(--radius-md);
    padding: 1rem;
    border: 1px solid var(--border-subtle);
  }

  .progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .progress-title {
    font-weight: 600;
    color: var(--text-primary);
  }

  .progress-status {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .progress-bar {
    width: 100%;
    height: 8px;
    background: var(--bg-elevated);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.75rem;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    transition: width 0.3s ease;
    border-radius: 4px;
  }

  .progress-steps {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .progress-step {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    background: var(--bg-elevated);
    color: var(--text-muted);
  }

  .progress-step.completed {
    background: rgba(52, 211, 153, 0.15);
    color: var(--accent-success);
  }

  .progress-step.active {
    background: rgba(99, 102, 241, 0.15);
    color: var(--accent-primary);
  }

  /* Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(4px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 100;
    opacity: 0;
    pointer-events: none;
    transition: opacity var(--transition-normal);
    padding: 1rem;
  }

  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: var(--bg-surface);
    padding: 1.75rem;
    border-radius: var(--radius-lg);
    width: 100%;
    max-width: 500px;
    border: 1px solid var(--border-default);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal h2 {
    font-family: var(--font-display);
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }

  .modal-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 0.5rem;
    justify-content: flex-end;
  }

  /* Form Styles */
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .input-group label {
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .input-group input,
  .input-group select,
  .input-group textarea {
    background: var(--bg-surface);
    border: 1px solid var(--border-subtle);
    color: var(--text-primary);
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    width: 100%;
    font-family: var(--font-body);
    font-size: 0.875rem;
    transition: var(--transition-fast);
  }

  .input-group input::placeholder,
  .input-group textarea::placeholder {
    color: var(--text-muted);
  }

  .input-group input:focus,
  .input-group select:focus,
  .input-group textarea:focus {
    outline: none;
    border-color: var(--accent-primary);
    background: var(--bg-elevated);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.85rem;
    cursor: pointer;
  }

  .checkbox-label input[type="checkbox"] {
    width: auto;
    margin: 0;
  }

  .checkbox-label input[type="checkbox"]:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .checkbox-label:has(input:disabled) {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Button Styles */
  .btn-primary,
  .btn-secondary {
    cursor: pointer;
    border: none;
    border-radius: var(--radius-md);
    padding: 0.625rem 1rem;
    font-family: var(--font-body);
    font-size: 0.8rem;
    font-weight: 500;
    transition: var(--transition-fast);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-primary {
    background: var(--accent-primary);
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: var(--accent-primary-hover);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: transparent;
    color: var(--text-secondary);
    border: 1px solid var(--border-default);
  }

  .btn-secondary:hover:not(:disabled) {
    border-color: var(--text-muted);
    color: var(--text-primary);
    background: var(--bg-hover);
  }

  button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
  }

  /* Loading Spinner */
  .loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid var(--border-default);
    border-top-color: var(--accent-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>