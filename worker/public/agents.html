<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Custom Agents - Semantic Prompt Workstation</title>

        <link rel="manifest" href="manifest.json" />
        <meta name="theme-color" content="#0a0a0f" />
        <link rel="icon" type="image/svg+xml" href="icon.svg" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap"
            rel="stylesheet"
        />

        <style>
            :root {
                --bg-base: #0a0a0f;
                --bg-surface: #12121a;
                --bg-elevated: #1a1a24;
                --bg-hover: #22222e;
                --accent-primary: #6366f1;
                --accent-primary-hover: #818cf8;
                --accent-secondary: #22d3ee;
                --accent-success: #34d399;
                --accent-warning: #fbbf24;
                --accent-error: #ef4444;
                --text-primary: #f4f4f5;
                --text-secondary: #a1a1aa;
                --text-muted: #71717a;
                --border-subtle: #27272a;
                --border-default: #3f3f46;
                --font-display: "Space Grotesk", system-ui, sans-serif;
                --font-body: "IBM Plex Sans", system-ui, sans-serif;
                --font-mono: "IBM Plex Mono", "SF Mono", monospace;
                --header-height: 60px;
                --radius-sm: 6px;
                --radius-md: 8px;
                --radius-lg: 12px;
                --transition-fast: 150ms ease;
                --transition-normal: 200ms ease;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                background: var(--bg-base);
                color: var(--text-primary);
                font-family: var(--font-body);
                font-size: 14px;
                line-height: 1.5;
                min-height: 100vh;
            }

            /* Header */
            header {
                background: var(--bg-surface);
                border-bottom: 1px solid var(--border-subtle);
                padding: 0 1.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                height: var(--header-height);
                position: sticky;
                top: 0;
                z-index: 20;
            }

            .logo-section {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            h1 {
                font-family: var(--font-display);
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--text-primary);
                letter-spacing: -0.02em;
            }

            .version-badge {
                font-size: 0.65rem;
                font-weight: 600;
                color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.15);
                padding: 0.2rem 0.5rem;
                border-radius: var(--radius-sm);
            }

            /* Navigation */
            nav {
                display: flex;
                gap: 0.25rem;
            }

            .nav-link {
                padding: 0.5rem 1rem;
                color: var(--text-muted);
                text-decoration: none;
                font-weight: 500;
                font-size: 0.875rem;
                border-radius: var(--radius-md);
                transition: var(--transition-fast);
            }

            .nav-link:hover {
                color: var(--text-primary);
                background: var(--bg-hover);
            }

            .nav-link.active {
                color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.1);
            }

            .header-actions {
                display: flex;
                gap: 0.5rem;
            }

            /* Main Layout */
            .main-layout {
                display: grid;
                grid-template-columns: 320px 1fr 420px;
                height: calc(100vh - var(--header-height));
                overflow: hidden;
            }

            @media (max-width: 1200px) {
                .main-layout {
                    grid-template-columns: 280px 1fr;
                }
                .preview-panel {
                    display: none;
                }
            }

            @media (max-width: 768px) {
                .main-layout {
                    grid-template-columns: 1fr;
                }
                .sidebar {
                    display: none;
                }
            }

            /* Sidebar */
            .sidebar {
                background: var(--bg-base);
                border-right: 1px solid var(--border-subtle);
                overflow-y: auto;
                padding: 1rem;
                display: flex;
                flex-direction: column;
                gap: 1rem;
            }

            .sidebar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid var(--border-subtle);
            }

            .sidebar-title {
                font-family: var(--font-display);
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                color: var(--text-muted);
            }

            /* Agent Cards */
            .agent-card {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-md);
                padding: 0.875rem;
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .agent-card:hover {
                border-color: var(--border-default);
                background: var(--bg-elevated);
            }

            .agent-card.selected {
                border-color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.08);
            }

            .agent-card-header {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .agent-icon {
                font-size: 1.25rem;
            }

            .agent-name {
                font-weight: 500;
                color: var(--text-primary);
                font-size: 0.9rem;
            }

            .agent-command {
                font-family: var(--font-mono);
                font-size: 0.7rem;
                color: var(--accent-secondary);
                margin-top: 0.25rem;
            }

            .agent-desc {
                font-size: 0.75rem;
                color: var(--text-muted);
                margin-top: 0.375rem;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .agent-card.disabled {
                opacity: 0.5;
            }

            /* Category Badge */
            .category-badge {
                font-size: 0.6rem;
                font-weight: 600;
                padding: 0.1rem 0.35rem;
                border-radius: var(--radius-sm);
                text-transform: uppercase;
                background: var(--bg-hover);
                color: var(--text-muted);
            }

            /* Editor Panel */
            .editor-panel {
                background: var(--bg-surface);
                overflow-y: auto;
                padding: 1.5rem;
                display: flex;
                flex-direction: column;
                gap: 1.25rem;
            }

            .editor-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-bottom: 1rem;
                border-bottom: 1px solid var(--border-subtle);
            }

            .editor-title {
                font-family: var(--font-display);
                font-size: 1.125rem;
                font-weight: 600;
            }

            /* Form Elements */
            .input-group {
                display: flex;
                flex-direction: column;
                gap: 0.375rem;
            }

            .input-group label {
                font-size: 0.8rem;
                font-weight: 500;
                color: var(--text-secondary);
            }

            .input-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            input[type="text"],
            input[type="number"],
            select,
            textarea {
                background: var(--bg-elevated);
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-md);
                padding: 0.625rem 0.875rem;
                color: var(--text-primary);
                font-family: var(--font-body);
                font-size: 0.875rem;
                transition: var(--transition-fast);
            }

            input[type="text"]:focus,
            input[type="number"]:focus,
            select:focus,
            textarea:focus {
                outline: none;
                border-color: var(--accent-primary);
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
            }

            textarea {
                font-family: var(--font-mono);
                resize: vertical;
                min-height: 200px;
                line-height: 1.6;
            }

            textarea.prompt-editor {
                min-height: 300px;
            }

            /* Buttons */
            .btn-primary {
                background: var(--accent-primary);
                color: white;
                border: none;
                padding: 0.625rem 1.25rem;
                border-radius: var(--radius-md);
                font-weight: 500;
                font-size: 0.875rem;
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .btn-primary:hover {
                background: var(--accent-primary-hover);
            }

            .btn-primary:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .btn-secondary {
                background: var(--bg-elevated);
                color: var(--text-primary);
                border: 1px solid var(--border-subtle);
                padding: 0.625rem 1.25rem;
                border-radius: var(--radius-md);
                font-weight: 500;
                font-size: 0.875rem;
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .btn-secondary:hover {
                background: var(--bg-hover);
                border-color: var(--border-default);
            }

            .btn-sm {
                padding: 0.375rem 0.75rem;
                font-size: 0.8rem;
            }

            .btn-danger {
                background: rgba(239, 68, 68, 0.15);
                color: var(--accent-error);
                border: 1px solid rgba(239, 68, 68, 0.3);
            }

            .btn-danger:hover {
                background: rgba(239, 68, 68, 0.25);
            }

            /* Preview Panel */
            .preview-panel {
                background: var(--bg-base);
                border-left: 1px solid var(--border-subtle);
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            }

            .preview-header {
                padding: 1rem;
                border-bottom: 1px solid var(--border-subtle);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .preview-tabs {
                display: flex;
                gap: 0.25rem;
            }

            .preview-tab {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
                font-weight: 500;
                color: var(--text-muted);
                background: transparent;
                border: none;
                border-radius: var(--radius-sm);
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .preview-tab:hover {
                color: var(--text-primary);
                background: var(--bg-hover);
            }

            .preview-tab.active {
                color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.1);
            }

            .preview-content {
                flex: 1;
                padding: 1rem;
                overflow-y: auto;
            }

            .code-preview {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-md);
                padding: 1rem;
                font-family: var(--font-mono);
                font-size: 0.8rem;
                line-height: 1.6;
                white-space: pre-wrap;
                color: var(--text-secondary);
            }

            /* Template Cards */
            .template-card {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-md);
                padding: 0.875rem;
                cursor: pointer;
                transition: var(--transition-fast);
                margin-bottom: 0.75rem;
            }

            .template-card:hover {
                border-color: var(--border-default);
                background: var(--bg-elevated);
            }

            .template-card-header {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .template-icon {
                font-size: 1.25rem;
            }

            .template-name {
                font-weight: 500;
                color: var(--text-primary);
                font-size: 0.85rem;
            }

            .template-desc {
                font-size: 0.75rem;
                color: var(--text-muted);
                margin-top: 0.375rem;
            }

            .template-category {
                margin-bottom: 1.25rem;
            }

            .template-category-title {
                font-size: 0.7rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                color: var(--text-muted);
                margin-bottom: 0.5rem;
            }

            /* Tool Selector (Checkboxes) */
            .tools-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 0.5rem;
            }

            .tool-checkbox {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.5rem;
                background: var(--bg-elevated);
                border-radius: var(--radius-sm);
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .tool-checkbox:hover {
                background: var(--bg-hover);
            }

            .tool-checkbox input {
                width: 14px;
                height: 14px;
            }

            .tool-checkbox label {
                font-size: 0.75rem;
                cursor: pointer;
            }

            /* Toggle Switch */
            .toggle-row {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem;
                background: var(--bg-elevated);
                border-radius: var(--radius-md);
            }

            .toggle-label {
                font-size: 0.875rem;
                color: var(--text-secondary);
            }

            .toggle-switch {
                position: relative;
                width: 44px;
                height: 24px;
                background: var(--bg-hover);
                border-radius: 12px;
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .toggle-switch.active {
                background: var(--accent-primary);
            }

            .toggle-switch::after {
                content: '';
                position: absolute;
                top: 2px;
                left: 2px;
                width: 20px;
                height: 20px;
                background: white;
                border-radius: 50%;
                transition: var(--transition-fast);
            }

            .toggle-switch.active::after {
                left: 22px;
            }

            /* Empty State */
            .empty-state {
                text-align: center;
                padding: 3rem 1.5rem;
                color: var(--text-muted);
            }

            .empty-state-icon {
                font-size: 3rem;
                margin-bottom: 1rem;
                opacity: 0.5;
            }

            .empty-state p {
                margin-bottom: 1rem;
            }

            /* Toast */
            .toast {
                position: fixed;
                bottom: 1.5rem;
                right: 1.5rem;
                background: var(--bg-elevated);
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-md);
                padding: 0.875rem 1.25rem;
                color: var(--text-primary);
                font-size: 0.875rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                transform: translateY(100px);
                opacity: 0;
                transition: var(--transition-normal);
                z-index: 100;
            }

            .toast.show {
                transform: translateY(0);
                opacity: 1;
            }

            .toast.error {
                border-color: var(--accent-error);
            }

            .toast.success {
                border-color: var(--accent-success);
            }

            /* No Selection State */
            #no-selection-state {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: var(--text-muted);
            }

            /* Icon Picker */
            .icon-picker {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
            }

            .icon-option {
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.25rem;
                background: var(--bg-elevated);
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-sm);
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .icon-option:hover {
                background: var(--bg-hover);
            }

            .icon-option.selected {
                border-color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.15);
            }

            /* Help Text */
            .help-text {
                font-size: 0.75rem;
                color: var(--text-muted);
                margin-top: 0.25rem;
            }

            /* Variable Tags */
            .variable-tags {
                display: flex;
                flex-wrap: wrap;
                gap: 0.375rem;
                margin-top: 0.5rem;
            }

            .variable-tag {
                font-family: var(--font-mono);
                font-size: 0.7rem;
                padding: 0.2rem 0.5rem;
                background: rgba(34, 211, 238, 0.15);
                color: var(--accent-secondary);
                border-radius: var(--radius-sm);
                cursor: pointer;
            }

            .variable-tag:hover {
                background: rgba(34, 211, 238, 0.25);
            }

            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: var(--border-subtle);
                border-radius: 3px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--text-muted);
            }

            /* Loading Spinner */
            .loading-spinner {
                width: 20px;
                height: 20px;
                border: 2px solid var(--border-subtle);
                border-top-color: var(--accent-primary);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
                display: inline-block;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        </style>
    </head>
    <body>
        <header>
            <div class="logo-section">
                <h1>Semantic Prompt Workstation</h1>
                <span class="version-badge">v1.0</span>
            </div>

            <nav>
                <a href="/" class="nav-link">Prompt Builder</a>
                <a href="/projects" class="nav-link">Projects</a>
                <a href="/rules" class="nav-link">Rules</a>
                <a href="/hooks" class="nav-link">Hooks</a>
                <a href="/agents" class="nav-link active">Agents</a>
            </nav>

            <div class="header-actions">
                <button class="btn-secondary btn-sm" onclick="exportAllAgents()">Export All</button>
            </div>
        </header>

        <div class="main-layout">
            <!-- Sidebar: Agent List -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title">Custom Agents</span>
                    <button class="btn-primary btn-sm" onclick="createNewAgent()">+ New Agent</button>
                </div>

                <div class="input-group">
                    <select id="project-filter" onchange="filterByProject()">
                        <option value="">All Projects</option>
                    </select>
                </div>

                <div id="agents-list">
                    <!-- Agents will be rendered here -->
                </div>
            </aside>

            <!-- Editor Panel -->
            <main class="editor-panel">
                <div id="no-selection-state">
                    <div class="empty-state">
                        <div class="empty-state-icon">&#x1F916;</div>
                        <h3>No Agent Selected</h3>
                        <p>Create custom slash commands that spawn specialized AI agents</p>
                        <button class="btn-primary" onclick="createNewAgent()">Create Agent</button>
                    </div>
                </div>

                <div id="editor-content" style="display: none;">
                    <div class="editor-header">
                        <h2 class="editor-title">Edit Agent</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-secondary btn-sm btn-danger" id="btn-delete-agent" onclick="deleteAgent()">Delete</button>
                            <button class="btn-primary btn-sm" id="btn-save-agent" onclick="saveAgent()">Save Agent</button>
                        </div>
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="agent-name">Command Name (slug)</label>
                            <input type="text" id="agent-name" placeholder="e.g., review-pr, write-tests">
                            <span class="help-text">Lowercase with hyphens. Used as: /<span id="command-preview">command</span></span>
                        </div>
                        <div class="input-group">
                            <label for="agent-display-name">Display Name</label>
                            <input type="text" id="agent-display-name" placeholder="e.g., PR Code Review">
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="agent-description">Description</label>
                        <input type="text" id="agent-description" placeholder="What does this agent do?">
                    </div>

                    <div class="input-row">
                        <div class="input-group">
                            <label for="agent-project">Project (optional)</label>
                            <select id="agent-project">
                                <option value="">No project (global agent)</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="agent-category">Category</label>
                            <select id="agent-category">
                                <option value="custom">Custom</option>
                                <option value="code-review">Code Review</option>
                                <option value="testing">Testing</option>
                                <option value="documentation">Documentation</option>
                                <option value="refactoring">Refactoring</option>
                                <option value="security">Security</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Icon</label>
                        <div class="icon-picker" id="icon-picker">
                            <!-- Icons rendered by JS -->
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="agent-prompt">Prompt Template</label>
                        <textarea id="agent-prompt" class="prompt-editor" placeholder="# Agent Title

Your prompt template here...

Use $ARGUMENTS to reference user input."></textarea>
                        <div class="variable-tags">
                            <span class="variable-tag" onclick="insertVariable('$ARGUMENTS')">$ARGUMENTS</span>
                            <span class="variable-tag" onclick="insertVariable('$FILE')">$FILE</span>
                            <span class="variable-tag" onclick="insertVariable('$SELECTION')">$SELECTION</span>
                            <span class="variable-tag" onclick="insertVariable('$WORKSPACE')">$WORKSPACE</span>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>Allowed Tools (optional)</label>
                        <div class="tools-grid" id="tools-grid">
                            <!-- Tool checkboxes rendered by JS -->
                        </div>
                        <span class="help-text">Leave all unchecked to allow all tools</span>
                    </div>

                    <div class="toggle-row">
                        <span class="toggle-label">Agent Enabled</span>
                        <div class="toggle-switch active" id="agent-enabled" onclick="toggleEnabled()"></div>
                    </div>
                </div>
            </main>

            <!-- Preview Panel: Templates -->
            <aside class="preview-panel">
                <div class="preview-header">
                    <span class="sidebar-title">Agent Templates</span>
                </div>

                <div class="preview-content" id="templates-list">
                    <!-- Templates will be rendered here -->
                </div>
            </aside>
        </div>

        <div id="toast" class="toast"></div>

        <script>
            /**
             * Agents Page - Semantic Prompt Workstation
             * Manages custom Claude Code slash commands (subagents)
             */

            // State
            let agents = [];
            let agentTemplates = [];
            let projects = [];
            let currentAgent = null;
            let hasUnsavedChanges = false;

            // Available tools
            const AVAILABLE_TOOLS = [
                'Read', 'Write', 'Edit', 'Bash', 'Glob', 'Grep',
                'WebFetch', 'WebSearch', 'Task', 'TodoWrite'
            ];

            // Available icons
            const AVAILABLE_ICONS = [
                'ðŸ¤–', 'ðŸ”', 'ðŸ§ª', 'ðŸ“', 'ðŸ”’', 'âš¡', 'â™»ï¸', 'ðŸ”„',
                'ðŸ’¡', 'ðŸ› ï¸', 'ðŸ“Š', 'ðŸŽ¯', 'ðŸš€', 'ðŸ”§', 'ðŸ“¦', 'ðŸŽ¨'
            ];

            // ============================================
            // ERROR HANDLER
            // ============================================

            const ErrorHandler = {
                showError(message, type = 'error') {
                    showToast(message, type);
                },

                handleApiError(error, context = '') {
                    const message = this.getApiErrorMessage(error);
                    console.error(`[${context}]`, error);
                    this.showError(message, 'error');
                    return { success: false, error: message };
                },

                getApiErrorMessage(error) {
                    if (error.message === 'Failed to fetch') return 'Network error. Check your connection.';
                    if (error.status === 400) return error.message || 'Invalid request.';
                    if (error.status === 404) return 'Resource not found.';
                    if (error.status === 500) return 'Server error. Please try again.';
                    return error.message || 'An unexpected error occurred.';
                },

                setupGlobalHandler() {
                    window.onerror = (msg, src, line, col, err) => {
                        console.error('[Global Error]', err);
                    };
                    window.onunhandledrejection = (e) => {
                        console.error('[Unhandled Promise]', e.reason);
                    };
                }
            };

            ErrorHandler.setupGlobalHandler();

            // ============================================
            // API HELPER
            // ============================================

            async function api(endpoint, options = {}) {
                const url = `/api${endpoint}`;
                const config = {
                    headers: { 'Content-Type': 'application/json' },
                    ...options,
                };

                if (options.body && typeof options.body === 'object') {
                    config.body = JSON.stringify(options.body);
                }

                const response = await fetch(url, config);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    const error = new Error(errorData.error || `HTTP ${response.status}`);
                    error.status = response.status;
                    throw error;
                }

                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                }
                return response.text();
            }

            // ============================================
            // TOAST NOTIFICATIONS
            // ============================================

            function showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} show`;

                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            // ============================================
            // DATA LOADING
            // ============================================

            async function loadProjects() {
                try {
                    const response = await api('/projects');
                    // Handle both old array format and new object format
                    projects = Array.isArray(response) ? response : response.projects || [];
                    renderProjectSelectors();
                } catch (error) {
                    console.error('Failed to load projects:', error);
                    projects = [];
                }
            }

            async function loadAgents() {
                try {
                    const projectId = document.getElementById('project-filter').value;
                    const endpoint = projectId ? `/agents?project_id=${projectId}` : '/agents';
                    agents = await api(endpoint);
                    renderAgentsList();
                } catch (error) {
                    ErrorHandler.handleApiError(error, 'loadAgents');
                    agents = [];
                }
            }

            async function loadTemplates() {
                try {
                    agentTemplates = await api('/agent-templates');
                    renderTemplates();
                } catch (error) {
                    console.error('Failed to load templates:', error);
                    agentTemplates = [];
                }
            }

            // ============================================
            // RENDERING
            // ============================================

            function renderProjectSelectors() {
                const filterSelect = document.getElementById('project-filter');
                const agentProjectSelect = document.getElementById('agent-project');

                const options = projects.map(p =>
                    `<option value="${p.id}">${escapeHtml(p.name)}</option>`
                ).join('');

                filterSelect.innerHTML = '<option value="">All Projects</option>' + options;
                agentProjectSelect.innerHTML = '<option value="">No project (global agent)</option>' + options;
            }

            function renderAgentsList() {
                const container = document.getElementById('agents-list');

                if (agents.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 2rem 1rem;">
                            <p>No custom agents yet</p>
                            <button class="btn-primary btn-sm" onclick="createNewAgent()">Create your first agent</button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = agents.map(agent => `
                    <div class="agent-card ${currentAgent?.id === agent.id ? 'selected' : ''} ${!agent.is_enabled ? 'disabled' : ''}"
                         onclick="selectAgent('${agent.id}')">
                        <div class="agent-card-header">
                            <span class="agent-icon">${agent.icon || 'ðŸ¤–'}</span>
                            <span class="agent-name">${escapeHtml(agent.display_name || agent.name)}</span>
                        </div>
                        <div class="agent-command">/${agent.name}</div>
                        ${agent.description ? `<div class="agent-desc">${escapeHtml(agent.description)}</div>` : ''}
                    </div>
                `).join('');
            }

            function renderTemplates() {
                const container = document.getElementById('templates-list');

                // Group by category
                const grouped = {};
                agentTemplates.forEach(t => {
                    const cat = t.category || 'custom';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push(t);
                });

                const categoryNames = {
                    'code-review': 'Code Review',
                    'testing': 'Testing',
                    'documentation': 'Documentation',
                    'refactoring': 'Refactoring',
                    'security': 'Security',
                    'custom': 'Custom'
                };

                let html = '';
                for (const [category, templates] of Object.entries(grouped)) {
                    html += `
                        <div class="template-category">
                            <div class="template-category-title">${categoryNames[category] || category}</div>
                            ${templates.map(t => `
                                <div class="template-card" onclick="applyTemplate('${t.id}')">
                                    <div class="template-card-header">
                                        <span class="template-icon">${t.icon || 'ðŸ¤–'}</span>
                                        <span class="template-name">${escapeHtml(t.display_name || t.name)}</span>
                                    </div>
                                    <div class="template-desc">${escapeHtml(t.description || '')}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                container.innerHTML = html || '<p style="color: var(--text-muted); padding: 1rem;">No templates available</p>';
            }

            function renderIconPicker() {
                const container = document.getElementById('icon-picker');
                const selectedIcon = currentAgent?.icon || 'ðŸ¤–';

                container.innerHTML = AVAILABLE_ICONS.map(icon => `
                    <div class="icon-option ${icon === selectedIcon ? 'selected' : ''}"
                         onclick="selectIcon('${icon}')">${icon}</div>
                `).join('');
            }

            function renderToolsGrid() {
                const container = document.getElementById('tools-grid');
                const allowedTools = currentAgent?.agent_config?.allowedTools || [];

                container.innerHTML = AVAILABLE_TOOLS.map(tool => `
                    <div class="tool-checkbox">
                        <input type="checkbox" id="tool-${tool}" value="${tool}"
                               ${allowedTools.includes(tool) ? 'checked' : ''}>
                        <label for="tool-${tool}">${tool}</label>
                    </div>
                `).join('');
            }

            // ============================================
            // AGENT CRUD
            // ============================================

            function createNewAgent() {
                if (hasUnsavedChanges && !confirm('Discard unsaved changes?')) return;

                currentAgent = {
                    id: null,
                    name: '',
                    display_name: '',
                    description: '',
                    project_id: null,
                    prompt_content: '',
                    agent_config: { allowedTools: [] },
                    icon: 'ðŸ¤–',
                    category: 'custom',
                    is_enabled: true
                };

                populateEditor();
                document.getElementById('no-selection-state').style.display = 'none';
                document.getElementById('editor-content').style.display = 'block';
                document.getElementById('btn-delete-agent').style.display = 'none';
                hasUnsavedChanges = false;
            }

            async function selectAgent(id) {
                if (hasUnsavedChanges && !confirm('Discard unsaved changes?')) return;

                try {
                    currentAgent = await api(`/agents/${id}`);
                    populateEditor();
                    document.getElementById('no-selection-state').style.display = 'none';
                    document.getElementById('editor-content').style.display = 'block';
                    document.getElementById('btn-delete-agent').style.display = 'inline-flex';
                    hasUnsavedChanges = false;
                    renderAgentsList();
                } catch (error) {
                    ErrorHandler.handleApiError(error, 'selectAgent');
                }
            }

            function populateEditor() {
                document.getElementById('agent-name').value = currentAgent.name || '';
                document.getElementById('agent-display-name').value = currentAgent.display_name || '';
                document.getElementById('agent-description').value = currentAgent.description || '';
                document.getElementById('agent-project').value = currentAgent.project_id || '';
                document.getElementById('agent-category').value = currentAgent.category || 'custom';
                document.getElementById('agent-prompt').value = currentAgent.prompt_content || '';

                // Update command preview
                updateCommandPreview();

                // Render icon picker
                renderIconPicker();

                // Render tools grid
                renderToolsGrid();

                // Enabled toggle
                const toggleEl = document.getElementById('agent-enabled');
                if (currentAgent.is_enabled) {
                    toggleEl.classList.add('active');
                } else {
                    toggleEl.classList.remove('active');
                }
            }

            function updateCommandPreview() {
                const name = document.getElementById('agent-name').value || 'command';
                document.getElementById('command-preview').textContent = name;
            }

            function selectIcon(icon) {
                currentAgent.icon = icon;
                renderIconPicker();
                hasUnsavedChanges = true;
            }

            function toggleEnabled() {
                const toggleEl = document.getElementById('agent-enabled');
                toggleEl.classList.toggle('active');
                hasUnsavedChanges = true;
            }

            function insertVariable(variable) {
                const textarea = document.getElementById('agent-prompt');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;

                textarea.value = text.substring(0, start) + variable + text.substring(end);
                textarea.selectionStart = textarea.selectionEnd = start + variable.length;
                textarea.focus();
                hasUnsavedChanges = true;
            }

            async function saveAgent() {
                const name = document.getElementById('agent-name').value.trim();
                const prompt_content = document.getElementById('agent-prompt').value.trim();

                if (!name) {
                    showToast('Command name is required', 'error');
                    return;
                }

                // Validate name format
                const slugRegex = /^[a-z0-9]+(?:-[a-z0-9]+)*$/;
                if (!slugRegex.test(name)) {
                    showToast('Name must be lowercase with hyphens only (e.g., review-pr)', 'error');
                    return;
                }

                if (!prompt_content) {
                    showToast('Prompt template is required', 'error');
                    return;
                }

                // Get selected tools
                const allowedTools = [];
                AVAILABLE_TOOLS.forEach(tool => {
                    const checkbox = document.getElementById(`tool-${tool}`);
                    if (checkbox && checkbox.checked) {
                        allowedTools.push(tool);
                    }
                });

                const agentData = {
                    name,
                    display_name: document.getElementById('agent-display-name').value.trim() || name,
                    description: document.getElementById('agent-description').value.trim() || null,
                    project_id: document.getElementById('agent-project').value || null,
                    category: document.getElementById('agent-category').value,
                    prompt_content,
                    agent_config: allowedTools.length > 0 ? { allowedTools } : null,
                    icon: currentAgent.icon || 'ðŸ¤–',
                    is_enabled: document.getElementById('agent-enabled').classList.contains('active')
                };

                try {
                    if (currentAgent.id) {
                        await api(`/agents/${currentAgent.id}`, { method: 'PUT', body: agentData });
                        showToast('Agent updated');
                    } else {
                        const result = await api('/agents', { method: 'POST', body: agentData });
                        currentAgent.id = result.id;
                        document.getElementById('btn-delete-agent').style.display = 'inline-flex';
                        showToast('Agent created');
                    }

                    hasUnsavedChanges = false;
                    await loadAgents();
                } catch (error) {
                    ErrorHandler.handleApiError(error, 'saveAgent');
                }
            }

            async function deleteAgent() {
                if (!currentAgent?.id) return;
                if (!confirm(`Delete agent "/${currentAgent.name}"?`)) return;

                try {
                    await api(`/agents/${currentAgent.id}`, { method: 'DELETE' });
                    showToast('Agent deleted');
                    currentAgent = null;
                    hasUnsavedChanges = false;
                    document.getElementById('no-selection-state').style.display = 'flex';
                    document.getElementById('editor-content').style.display = 'none';
                    await loadAgents();
                } catch (error) {
                    ErrorHandler.handleApiError(error, 'deleteAgent');
                }
            }

            // ============================================
            // TEMPLATES
            // ============================================

            function applyTemplate(templateId) {
                const template = agentTemplates.find(t => t.id === templateId);
                if (!template) return;

                if (hasUnsavedChanges && !confirm('Apply template? This will replace current values.')) return;

                currentAgent = {
                    id: null,
                    name: template.name,
                    display_name: template.display_name,
                    description: template.description,
                    project_id: null,
                    prompt_content: template.prompt_content,
                    agent_config: template.agent_config,
                    icon: template.icon || 'ðŸ¤–',
                    category: template.category || 'custom',
                    is_enabled: true
                };

                populateEditor();
                document.getElementById('no-selection-state').style.display = 'none';
                document.getElementById('editor-content').style.display = 'block';
                document.getElementById('btn-delete-agent').style.display = 'none';
                hasUnsavedChanges = true;

                showToast(`Applied "${template.display_name || template.name}" template`);
            }

            // ============================================
            // EXPORT
            // ============================================

            function exportAllAgents() {
                if (agents.length === 0) {
                    showToast('No agents to export', 'error');
                    return;
                }

                // Create a zip-like structure (actually just show instructions + download individual files)
                const enabledAgents = agents.filter(a => a.is_enabled);

                if (enabledAgents.length === 0) {
                    showToast('No enabled agents to export', 'error');
                    return;
                }

                // Export each agent as a separate .md file download
                enabledAgents.forEach(agent => {
                    const blob = new Blob([agent.prompt_content], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${agent.name}.md`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });

                showToast(`Exported ${enabledAgents.length} agent(s) to .claude/commands/`);
            }

            // ============================================
            // UTILITIES
            // ============================================

            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function filterByProject() {
                loadAgents();
            }

            // Track changes
            document.addEventListener('input', (e) => {
                if (e.target.closest('#editor-content')) {
                    hasUnsavedChanges = true;

                    // Update command preview if name changed
                    if (e.target.id === 'agent-name') {
                        updateCommandPreview();
                    }
                }
            });

            // Warn on navigation with unsaved changes
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // ============================================
            // INITIALIZATION
            // ============================================

            async function init() {
                await loadProjects();
                await loadAgents();
                await loadTemplates();
            }

            init();
        </script>
    </body>
</html>
