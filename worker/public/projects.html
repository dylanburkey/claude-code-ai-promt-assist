<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Projects - Semantic Prompt Workstation</title>

        <link rel="manifest" href="manifest.json" />
        <meta name="theme-color" content="#0a0a0f" />
        <link rel="icon" type="image/svg+xml" href="icon.svg" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap"
            rel="stylesheet"
        />

        <style>
            :root {
                --bg-base: #0a0a0f;
                --bg-surface: #12121a;
                --bg-elevated: #1a1a24;
                --bg-hover: #22222e;
                --accent-primary: #6366f1;
                --accent-primary-hover: #818cf8;
                --accent-secondary: #22d3ee;
                --accent-success: #34d399;
                --accent-warning: #fbbf24;
                --accent-error: #ef4444;
                --text-primary: #f4f4f5;
                --text-secondary: #a1a1aa;
                --text-muted: #71717a;
                --border-subtle: #27272a;
                --border-default: #3f3f46;
                --font-display: "Space Grotesk", system-ui, sans-serif;
                --font-body: "IBM Plex Sans", system-ui, sans-serif;
                --font-mono: "IBM Plex Mono", "SF Mono", monospace;
                --header-height: 60px;
                --radius-sm: 6px;
                --radius-md: 8px;
                --radius-lg: 12px;
                --transition-fast: 150ms ease;
                --transition-normal: 200ms ease;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                background: var(--bg-base);
                color: var(--text-primary);
                font-family: var(--font-body);
                font-size: 14px;
                line-height: 1.5;
                min-height: 100vh;
            }

            /* Header */
            header {
                background: var(--bg-surface);
                border-bottom: 1px solid var(--border-subtle);
                padding: 0 1.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                height: var(--header-height);
                position: sticky;
                top: 0;
                z-index: 20;
            }

            .logo-section {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            h1 {
                font-family: var(--font-display);
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--text-primary);
                letter-spacing: -0.02em;
            }

            .version-badge {
                font-size: 0.65rem;
                font-weight: 600;
                color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.15);
                padding: 0.2rem 0.5rem;
                border-radius: var(--radius-sm);
            }

            /* Navigation */
            nav {
                display: flex;
                gap: 0.25rem;
            }

            .nav-link {
                padding: 0.5rem 1rem;
                color: var(--text-muted);
                text-decoration: none;
                font-weight: 500;
                font-size: 0.875rem;
                border-radius: var(--radius-md);
                transition: var(--transition-fast);
            }

            .nav-link:hover {
                color: var(--text-primary);
                background: var(--bg-hover);
            }

            .nav-link.active {
                color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.1);
            }

            .header-actions {
                display: flex;
                gap: 0.5rem;
            }

            /* Main Content */
            main {
                max-width: 1400px;
                margin: 0 auto;
                padding: 2rem 1.5rem;
            }

            .page-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem;
            }

            .page-title {
                font-family: var(--font-display);
                font-size: 1.75rem;
                font-weight: 700;
            }

            .page-subtitle {
                color: var(--text-muted);
                margin-top: 0.25rem;
            }

            /* Filters */
            .filters-bar {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
            }

            .filter-group {
                display: flex;
                gap: 0.5rem;
            }

            .filter-btn {
                padding: 0.5rem 1rem;
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                color: var(--text-secondary);
                font-size: 0.8rem;
                border-radius: var(--radius-md);
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .filter-btn:hover {
                border-color: var(--border-default);
                color: var(--text-primary);
            }

            .filter-btn.active {
                background: rgba(99, 102, 241, 0.1);
                border-color: var(--accent-primary);
                color: var(--accent-primary);
            }

            .search-input {
                flex: 1;
                min-width: 200px;
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                color: var(--text-primary);
                padding: 0.5rem 1rem;
                border-radius: var(--radius-md);
                font-family: var(--font-body);
                font-size: 0.875rem;
            }

            .search-input:focus {
                outline: none;
                border-color: var(--accent-primary);
            }

            /* Project Cards Grid */
            .projects-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
                gap: 1.5rem;
            }

            .project-card {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-lg);
                overflow: hidden;
                cursor: pointer;
                transition: var(--transition-normal);
            }

            .project-card:hover {
                border-color: var(--accent-primary);
                transform: translateY(-2px);
                box-shadow: 0 8px 32px rgba(99, 102, 241, 0.15);
            }

            .project-cover {
                width: 100%;
                height: 160px;
                background: linear-gradient(
                    135deg,
                    var(--bg-elevated) 0%,
                    var(--bg-surface) 100%
                );
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: hidden;
            }

            .project-cover img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }

            .project-cover-placeholder {
                color: var(--text-muted);
                font-size: 3rem;
                opacity: 0.5;
            }

            .project-content {
                padding: 1.25rem;
            }

            .project-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 0.75rem;
            }

            .project-name {
                font-family: var(--font-display);
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--text-primary);
            }

            .project-status {
                font-size: 0.65rem;
                font-weight: 600;
                text-transform: uppercase;
                padding: 0.2rem 0.5rem;
                border-radius: var(--radius-sm);
            }

            .status-active {
                background: rgba(52, 211, 153, 0.15);
                color: var(--accent-success);
            }

            .status-draft {
                background: rgba(113, 113, 122, 0.15);
                color: var(--text-muted);
            }

            .status-completed {
                background: rgba(99, 102, 241, 0.15);
                color: var(--accent-primary);
            }

            .status-on_hold {
                background: rgba(251, 191, 36, 0.15);
                color: var(--accent-warning);
            }

            .status-archived {
                background: rgba(239, 68, 68, 0.15);
                color: var(--accent-error);
            }

            .project-description {
                color: var(--text-secondary);
                font-size: 0.85rem;
                line-height: 1.5;
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                margin-bottom: 1rem;
            }

            .project-meta {
                display: flex;
                gap: 1rem;
                color: var(--text-muted);
                font-size: 0.75rem;
            }

            .project-meta-item {
                display: flex;
                align-items: center;
                gap: 0.25rem;
            }

            .project-tags {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
                margin-top: 0.75rem;
            }

            .project-tag {
                font-size: 0.7rem;
                padding: 0.2rem 0.5rem;
                background: var(--bg-elevated);
                border-radius: var(--radius-sm);
                color: var(--text-muted);
            }

            /* New Project Card */
            .project-card.new-project {
                border-style: dashed;
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 280px;
            }

            .new-project-content {
                text-align: center;
                color: var(--text-muted);
            }

            .new-project-icon {
                font-size: 3rem;
                margin-bottom: 1rem;
                opacity: 0.5;
            }

            .new-project-text {
                font-weight: 500;
            }

            /* Buttons */
            button {
                cursor: pointer;
                border: none;
                border-radius: var(--radius-md);
                padding: 0.625rem 1rem;
                font-family: var(--font-body);
                font-size: 0.8rem;
                font-weight: 500;
                transition: var(--transition-fast);
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }

            .btn-primary {
                background: var(--accent-primary);
                color: white;
            }

            .btn-primary:hover {
                background: var(--accent-primary-hover);
                transform: translateY(-1px);
            }

            .btn-secondary {
                background: transparent;
                color: var(--text-secondary);
                border: 1px solid var(--border-default);
            }

            .btn-secondary:hover {
                border-color: var(--text-muted);
                color: var(--text-primary);
                background: var(--bg-hover);
            }

            .btn-ghost {
                background: transparent;
                color: var(--text-muted);
                padding: 0.5rem;
            }

            .btn-ghost:hover {
                color: var(--text-primary);
                background: var(--bg-hover);
            }

            /* Modal */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(4px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 100;
                opacity: 0;
                pointer-events: none;
                transition: opacity var(--transition-normal);
                padding: 1rem;
            }

            .modal-overlay.open {
                opacity: 1;
                pointer-events: all;
            }

            .modal {
                background: var(--bg-surface);
                padding: 1.75rem;
                border-radius: var(--radius-lg);
                width: 100%;
                max-width: 600px;
                border: 1px solid var(--border-default);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                display: flex;
                flex-direction: column;
                gap: 1.25rem;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal h2 {
                font-family: var(--font-display);
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--text-primary);
            }

            .modal-actions {
                display: flex;
                gap: 0.75rem;
                margin-top: 0.5rem;
                justify-content: flex-end;
            }

            /* Form Elements */
            label {
                font-size: 0.8rem;
                font-weight: 500;
                color: var(--text-secondary);
                margin-bottom: 0.5rem;
                display: block;
            }

            .input-group {
                display: flex;
                flex-direction: column;
            }

            input,
            textarea,
            select {
                background: var(--bg-elevated);
                border: 1px solid var(--border-subtle);
                color: var(--text-primary);
                padding: 0.75rem 1rem;
                border-radius: var(--radius-md);
                width: 100%;
                font-family: var(--font-body);
                font-size: 0.875rem;
                transition: var(--transition-fast);
            }

            input::placeholder,
            textarea::placeholder {
                color: var(--text-muted);
            }

            input:focus,
            textarea:focus,
            select:focus {
                outline: none;
                border-color: var(--accent-primary);
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            }

            textarea {
                resize: vertical;
                min-height: 100px;
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            /* Cover Image Upload */
            .cover-upload {
                border: 2px dashed var(--border-default);
                border-radius: var(--radius-md);
                padding: 2rem;
                text-align: center;
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .cover-upload:hover {
                border-color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.05);
            }

            .cover-upload-text {
                color: var(--text-muted);
                font-size: 0.85rem;
            }

            .cover-preview {
                width: 100%;
                max-height: 200px;
                object-fit: cover;
                border-radius: var(--radius-md);
            }

            /* Toast */
            .toast {
                position: fixed;
                bottom: 2rem;
                left: 50%;
                transform: translateX(-50%) translateY(100px);
                background: var(--bg-elevated);
                border: 1px solid var(--border-default);
                padding: 0.75rem 1.25rem;
                border-radius: var(--radius-md);
                font-size: 0.85rem;
                z-index: 200;
                opacity: 0;
                transition: all 0.3s ease;
            }

            .toast.show {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }

            .toast.success {
                border-color: var(--accent-success);
                color: var(--accent-success);
            }

            .toast.error {
                border-color: var(--accent-error);
                color: var(--accent-error);
            }

            /* Empty State */
            .empty-state {
                text-align: center;
                padding: 4rem 2rem;
                color: var(--text-muted);
            }

            .empty-state-icon {
                font-size: 4rem;
                margin-bottom: 1rem;
                opacity: 0.5;
            }

            .empty-state-title {
                font-family: var(--font-display);
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--text-secondary);
                margin-bottom: 0.5rem;
            }

            /* Loading */
            .loading-spinner {
                display: inline-block;
                width: 16px;
                height: 16px;
                border: 2px solid var(--border-default);
                border-top-color: var(--accent-primary);
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            /* Scrollbar */
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: var(--border-default);
                border-radius: 3px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--text-muted);
            }

            /* Responsive */
            @media (max-width: 768px) {
                .page-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 1rem;
                }

                .filters-bar {
                    flex-direction: column;
                }

                .form-row {
                    grid-template-columns: 1fr;
                }

                nav {
                    display: none;
                }
            }
        </style>
    </head>
    <body>
        <header>
            <div class="logo-section">
                <h1>Semantic Prompt Workstation</h1>
                <span class="version-badge">v3.0</span>
            </div>
            <nav>
                <a href="/" class="nav-link">Prompt Builder</a>
                <a href="/projects" class="nav-link active">Projects</a>
                <a href="/rules" class="nav-link">Rules</a>
                <a href="/hooks" class="nav-link">Hooks</a>
                <a href="/agents" class="nav-link">Agents</a>
            </nav>
            <div class="header-actions">
                <button class="btn-primary" onclick="openProjectModal()">
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <line x1="12" y1="5" x2="12" y2="19" />
                        <line x1="5" y1="12" x2="19" y2="12" />
                    </svg>
                    New Project
                </button>
            </div>
        </header>

        <main>
            <div class="page-header">
                <div>
                    <h2 class="page-title">Projects</h2>
                    <p class="page-subtitle">
                        Manage your AI-assisted projects and track progress
                    </p>
                </div>
            </div>

            <div class="filters-bar">
                <div class="filter-group">
                    <button
                        class="filter-btn active"
                        data-status="all"
                        onclick="filterByStatus('all')"
                    >
                        All
                    </button>
                    <button
                        class="filter-btn"
                        data-status="active"
                        onclick="filterByStatus('active')"
                    >
                        Active
                    </button>
                    <button
                        class="filter-btn"
                        data-status="draft"
                        onclick="filterByStatus('draft')"
                    >
                        Draft
                    </button>
                    <button
                        class="filter-btn"
                        data-status="completed"
                        onclick="filterByStatus('completed')"
                    >
                        Completed
                    </button>
                    <button
                        class="filter-btn"
                        data-status="archived"
                        onclick="filterByStatus('archived')"
                    >
                        Archived
                    </button>
                </div>
                <input
                    type="text"
                    class="search-input"
                    placeholder="Search projects..."
                    id="search-input"
                    oninput="searchProjects(this.value)"
                />
            </div>

            <div id="projects-container" class="projects-grid">
                <!-- Projects will be rendered here -->
                <div
                    class="project-card new-project"
                    onclick="openProjectModal()"
                >
                    <div class="new-project-content">
                        <div class="new-project-icon">+</div>
                        <div class="new-project-text">Create New Project</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Project Modal -->
        <div id="project-modal" class="modal-overlay">
            <div class="modal">
                <h2 id="project-modal-title">Create New Project</h2>
                <input type="hidden" id="project-id" />

                <div class="input-group">
                    <label for="project-name">Project Name *</label>
                    <input
                        type="text"
                        id="project-name"
                        placeholder="e.g., E-commerce Redesign"
                    />
                    <small
                        style="color: var(--text-muted); margin-top: 0.25rem"
                    >
                        URL will be: /projects/<span id="slug-preview"
                            >project-name</span
                        >
                    </small>
                </div>

                <div class="input-group">
                    <label for="project-description">Short Description</label>
                    <input
                        type="text"
                        id="project-description"
                        placeholder="Brief overview of the project"
                    />
                </div>

                <div class="input-group">
                    <label>Cover Image (optional)</label>
                    <div
                        class="cover-upload"
                        onclick="document.getElementById('cover-input').click()"
                    >
                        <div id="cover-preview-container">
                            <div class="cover-upload-text">
                                <svg
                                    width="24"
                                    height="24"
                                    viewBox="0 0 24 24"
                                    fill="none"
                                    stroke="currentColor"
                                    stroke-width="2"
                                    style="margin-bottom: 0.5rem"
                                >
                                    <rect
                                        x="3"
                                        y="3"
                                        width="18"
                                        height="18"
                                        rx="2"
                                        ry="2"
                                    />
                                    <circle cx="8.5" cy="8.5" r="1.5" />
                                    <polyline points="21 15 16 10 5 21" />
                                </svg>
                                <div>Click to upload cover image</div>
                            </div>
                        </div>
                    </div>
                    <input
                        type="file"
                        id="cover-input"
                        accept="image/*"
                        style="display: none"
                        onchange="handleCoverUpload(this)"
                    />
                </div>

                <div class="input-group">
                    <label for="project-info">Project Information</label>
                    <textarea
                        id="project-info"
                        rows="6"
                        placeholder="Describe your project here. Include:
- Project goals and objectives
- Target audience or users
- Key features and requirements
- Technical constraints or preferences
- Related technologies or frameworks"
                    ></textarea>
                </div>

                <div class="form-row">
                    <div class="input-group">
                        <label for="project-status">Status</label>
                        <select id="project-status">
                            <option value="draft">Draft</option>
                            <option value="active" selected>Active</option>
                            <option value="on_hold">On Hold</option>
                            <option value="completed">Completed</option>
                            <option value="archived">Archived</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="project-priority">Priority</label>
                        <select id="project-priority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label for="project-category">Category</label>
                    <input
                        type="text"
                        id="project-category"
                        placeholder="e.g., Web Development, Mobile App, API"
                    />
                </div>

                <div class="input-group">
                    <label for="project-tags">Tags (comma-separated)</label>
                    <input
                        type="text"
                        id="project-tags"
                        placeholder="e.g., react, typescript, ai"
                    />
                </div>

                <div class="input-group">
                    <label for="project-ai-context">AI Context Summary</label>
                    <textarea
                        id="project-ai-context"
                        rows="3"
                        placeholder="Brief summary for AI to understand this project's context when providing assistance..."
                    ></textarea>
                    <small
                        style="color: var(--text-muted); margin-top: 0.25rem"
                    >
                        This summary will be included when AI works on related
                        projects.
                    </small>
                </div>

                <div class="modal-actions">
                    <button
                        class="btn-secondary"
                        id="btn-delete-project"
                        onclick="deleteProject()"
                        style="
                            margin-right: auto;
                            color: #ef4444;
                            border-color: #ef4444;
                            display: none;
                        "
                    >
                        Delete
                    </button>
                    <button class="btn-secondary" onclick="closeProjectModal()">
                        Cancel
                    </button>
                    <button
                        class="btn-primary"
                        id="btn-save-project"
                        onclick="saveProject()"
                    >
                        Create Project
                    </button>
                </div>
            </div>
        </div>

        <div id="toast" class="toast"></div>

        <script>
            const API_BASE = "/api";
            let projects = [];
            let currentFilter = "all";
            let searchQuery = "";
            let coverImageData = null;

            // ============================================
            // ERROR HANDLER
            // ============================================
            const ErrorHandler = {
                showError(message, type = 'error') {
                    showToast(message, type);
                },

                handleApiError(error, context = '') {
                    const message = this.getApiErrorMessage(error);
                    console.error(`[${context}]`, error);
                    this.showError(message, 'error');
                    return { success: false, error: message };
                },

                getApiErrorMessage(error) {
                    if (error.message === 'Failed to fetch') {
                        return 'Network error. Please check your connection.';
                    }
                    if (error.status === 400) {
                        return error.message || 'Invalid request. Please check your input.';
                    }
                    if (error.status === 404) {
                        return 'The requested resource was not found.';
                    }
                    if (error.status === 500) {
                        return 'Server error. Please try again later.';
                    }
                    return error.message || 'An unexpected error occurred.';
                },

                validateForm(formData, rules) {
                    const errors = [];
                    for (const [field, r] of Object.entries(rules)) {
                        const v = formData[field];
                        if (r.required && (!v || (typeof v === 'string' && v.trim() === ''))) {
                            errors.push({ field, message: `${r.label || field} is required` });
                        }
                    }
                    return errors;
                },

                showFieldError(fieldId, message) {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.style.borderColor = 'var(--accent-error)';
                        const existingError = field.parentNode.querySelector('.field-error');
                        if (existingError) existingError.remove();
                        const errorEl = document.createElement('span');
                        errorEl.className = 'field-error';
                        errorEl.textContent = message;
                        errorEl.style.cssText = 'color: var(--accent-error); font-size: 0.75rem; margin-top: 0.25rem; display: block;';
                        field.parentNode.appendChild(errorEl);
                    }
                },

                clearFieldErrors() {
                    document.querySelectorAll('.field-error').forEach(el => el.remove());
                    document.querySelectorAll('input, textarea, select').forEach(el => {
                        el.style.borderColor = '';
                    });
                },

                setupGlobalHandler() {
                    window.onerror = (message, source, lineno, colno, error) => {
                        console.error('[GlobalError]', { message, source, lineno, colno, error });
                        return false;
                    };
                    window.onunhandledrejection = (event) => {
                        console.error('[UnhandledPromiseRejection]', event.reason);
                    };
                }
            };
            ErrorHandler.setupGlobalHandler();

            // ============================================
            // API CLIENT
            // ============================================
            async function api(endpoint, options = {}) {
                const config = {
                    headers: { "Content-Type": "application/json" },
                    ...options,
                };
                if (options.body && typeof options.body === "object") {
                    config.body = JSON.stringify(options.body);
                }
                try {
                    const response = await fetch(
                        `${API_BASE}${endpoint}`,
                        config,
                    );

                    let data;
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        data = await response.json();
                    } else {
                        data = await response.text();
                    }

                    if (!response.ok) {
                        const error = new Error(data.error || data || "API request failed");
                        error.status = response.status;
                        error.data = data;
                        throw error;
                    }
                    return data;
                } catch (error) {
                    if (error.name === 'TypeError' && error.message === 'Failed to fetch') {
                        error.message = 'Network error. Please check your connection.';
                    }
                    throw error;
                }
            }

            // ============================================
            // UI HELPERS
            // ============================================
            function showToast(message, type = "success") {
                const toast = document.getElementById("toast");
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                setTimeout(() => toast.classList.remove("show"), 3000);
            }

            function escapeHtml(text) {
                if (!text) return "";
                const div = document.createElement("div");
                div.textContent = text;
                return div.innerHTML;
            }

            function generateSlugPreview(name) {
                return (
                    name
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, "-")
                        .replace(/^-+|-+$/g, "")
                        .substring(0, 50) || "project-name"
                );
            }

            function formatDate(dateStr) {
                if (!dateStr) return "N/A";
                return new Date(dateStr).toLocaleDateString("en-US", {
                    month: "short",
                    day: "numeric",
                    year: "numeric",
                });
            }

            // ============================================
            // PROJECTS
            // ============================================
            async function loadProjects() {
                try {
                    const response = await api("/projects");
                    console.log("API response:", response);
                    
                    // Handle the response structure from the API
                    if (response && response.projects && Array.isArray(response.projects)) {
                        projects = response.projects;
                    } else {
                        console.error("Invalid API response structure:", response);
                        projects = [];
                    }
                    
                    renderProjects();
                } catch (error) {
                    console.error("Failed to load projects:", error);
                    projects = [];
                    showToast("Failed to load projects", "error");
                    renderProjects(); // Still render with empty array
                }
            }

            function renderProjects() {
                const container = document.getElementById("projects-container");

                // Ensure projects is an array
                if (!Array.isArray(projects)) {
                    console.error("Projects is not an array:", projects);
                    projects = [];
                }

                // Filter projects
                let filtered = projects;
                if (currentFilter !== "all") {
                    filtered = projects.filter(
                        (p) => p.status === currentFilter,
                    );
                }
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    filtered = filtered.filter(
                        (p) =>
                            p.name.toLowerCase().includes(query) ||
                            (p.description &&
                                p.description.toLowerCase().includes(query)) ||
                            (p.category &&
                                p.category.toLowerCase().includes(query)),
                    );
                }

                // Ensure filtered is an array before mapping
                if (!Array.isArray(filtered)) {
                    console.error("Filtered is not an array:", filtered);
                    filtered = [];
                }

                // Render cards
                const cards = filtered
                    .map((project) => {
                        const tags = project.tags
                            ? JSON.parse(project.tags)
                            : [];
                        return `
                        <div class="project-card" onclick="navigateToProject('${project.slug}')">
                            <div class="project-cover">
                                ${
                                    project.cover_image
                                        ? `<img src="${escapeHtml(project.cover_image)}" alt="${escapeHtml(project.cover_image_alt || project.name)}" />`
                                        : `<div class="project-cover-placeholder">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                                        </svg>
                                    </div>`
                                }
                            </div>
                            <div class="project-content">
                                <div class="project-header">
                                    <div class="project-name">${escapeHtml(project.name)}</div>
                                    <span class="project-status status-${project.status}">${project.status}</span>
                                </div>
                                <div class="project-description">${escapeHtml(project.description) || "No description"}</div>
                                <div class="project-meta">
                                    ${
                                        project.category
                                            ? `<span class="project-meta-item">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                                        </svg>
                                        ${escapeHtml(project.category)}
                                    </span>`
                                            : ""
                                    }
                                    <span class="project-meta-item">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                            <line x1="16" y1="2" x2="16" y2="6"/>
                                            <line x1="8" y1="2" x2="8" y2="6"/>
                                            <line x1="3" y1="10" x2="21" y2="10"/>
                                        </svg>
                                        ${formatDate(project.created_at)}
                                    </span>
                                </div>
                                ${
                                    tags.length > 0
                                        ? `
                                    <div class="project-tags">
                                        ${tags
                                            .slice(0, 3)
                                            .map(
                                                (tag) =>
                                                    `<span class="project-tag">${escapeHtml(tag)}</span>`,
                                            )
                                            .join("")}
                                        ${tags.length > 3 ? `<span class="project-tag">+${tags.length - 3}</span>` : ""}
                                    </div>
                                `
                                        : ""
                                }
                            </div>
                        </div>
                    `;
                    })
                    .join("");

                // Add new project card at the end
                container.innerHTML =
                    cards +
                    `
                    <div class="project-card new-project" onclick="openProjectModal()">
                        <div class="new-project-content">
                            <div class="new-project-icon">+</div>
                            <div class="new-project-text">Create New Project</div>
                        </div>
                    </div>
                `;
            }

            function navigateToProject(slug) {
                window.location.href = `/project/${slug}`;
            }

            // Handle edit parameter from URL (for redirects from project page)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has("edit")) {
                const editId = urlParams.get("edit");
                window.addEventListener("DOMContentLoaded", () => {
                    loadProjects().then(() => {
                        openProjectModal(editId);
                    });
                });
            }

            function filterByStatus(status) {
                currentFilter = status;
                document.querySelectorAll(".filter-btn").forEach((btn) => {
                    btn.classList.toggle(
                        "active",
                        btn.dataset.status === status,
                    );
                });
                renderProjects();
            }

            function searchProjects(query) {
                searchQuery = query;
                renderProjects();
            }

            // ============================================
            // PROJECT MODAL
            // ============================================
            function openProjectModal(projectId = null) {
                const modal = document.getElementById("project-modal");
                const title = document.getElementById("project-modal-title");
                const saveBtn = document.getElementById("btn-save-project");
                const deleteBtn = document.getElementById("btn-delete-project");

                // Reset form
                document.getElementById("project-id").value = "";
                document.getElementById("project-name").value = "";
                document.getElementById("project-description").value = "";
                document.getElementById("project-info").value = "";
                document.getElementById("project-status").value = "active";
                document.getElementById("project-priority").value = "medium";
                document.getElementById("project-category").value = "";
                document.getElementById("project-tags").value = "";
                document.getElementById("project-ai-context").value = "";
                document.getElementById("slug-preview").textContent =
                    "project-name";
                coverImageData = null;
                resetCoverPreview();

                if (projectId) {
                    const project = projects.find((p) => p.id === projectId);
                    if (project) {
                        title.textContent = "Edit Project";
                        saveBtn.textContent = "Save Changes";
                        deleteBtn.style.display = "block";

                        document.getElementById("project-id").value =
                            project.id;
                        document.getElementById("project-name").value =
                            project.name;
                        document.getElementById("project-description").value =
                            project.description || "";
                        document.getElementById("project-info").value =
                            project.project_info || "";
                        document.getElementById("project-status").value =
                            project.status;
                        document.getElementById("project-priority").value =
                            project.priority;
                        document.getElementById("project-category").value =
                            project.category || "";
                        document.getElementById("project-tags").value =
                            project.tags
                                ? JSON.parse(project.tags).join(", ")
                                : "";
                        document.getElementById("project-ai-context").value =
                            project.ai_context_summary || "";
                        document.getElementById("slug-preview").textContent =
                            project.slug;

                        if (project.cover_image) {
                            coverImageData = project.cover_image;
                            showCoverPreview(project.cover_image);
                        }
                    }
                } else {
                    title.textContent = "Create New Project";
                    saveBtn.textContent = "Create Project";
                    deleteBtn.style.display = "none";
                }

                modal.classList.add("open");
            }

            function closeProjectModal() {
                document
                    .getElementById("project-modal")
                    .classList.remove("open");
            }

            function handleCoverUpload(input) {
                const file = input.files[0];
                if (!file) return;

                if (file.size > 5 * 1024 * 1024) {
                    showToast("Image must be under 5MB", "error");
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    coverImageData = e.target.result;
                    showCoverPreview(coverImageData);
                };
                reader.readAsDataURL(file);
            }

            function showCoverPreview(src) {
                document.getElementById("cover-preview-container").innerHTML = `
                    <img src="${src}" class="cover-preview" />
                    <button class="btn-ghost" onclick="event.stopPropagation(); removeCoverImage()" style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--bg-surface);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/>
                            <line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                `;
                document.querySelector(".cover-upload").style.position =
                    "relative";
            }

            function resetCoverPreview() {
                document.getElementById("cover-preview-container").innerHTML = `
                    <div class="cover-upload-text">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom: 0.5rem;">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                        <div>Click to upload cover image</div>
                    </div>
                `;
            }

            function removeCoverImage() {
                coverImageData = null;
                resetCoverPreview();
                document.getElementById("cover-input").value = "";
            }

            async function saveProject() {
                const id = document.getElementById("project-id").value;
                const name = document
                    .getElementById("project-name")
                    .value.trim();
                const description = document
                    .getElementById("project-description")
                    .value.trim();
                const project_info = document
                    .getElementById("project-info")
                    .value.trim();
                const status = document.getElementById("project-status").value;
                const priority =
                    document.getElementById("project-priority").value;
                const category = document
                    .getElementById("project-category")
                    .value.trim();
                const tagsStr = document
                    .getElementById("project-tags")
                    .value.trim();
                const ai_context_summary = document
                    .getElementById("project-ai-context")
                    .value.trim();

                if (!name) {
                    showToast("Project name is required", "error");
                    return;
                }

                const tags = tagsStr
                    ? tagsStr
                          .split(",")
                          .map((t) => t.trim())
                          .filter((t) => t)
                    : [];

                const btn = document.getElementById("btn-save-project");
                btn.disabled = true;
                btn.innerHTML =
                    '<span class="loading-spinner"></span> Saving...';

                const payload = {
                    name,
                    description,
                    project_info,
                    status,
                    priority,
                    category: category || null,
                    tags,
                    ai_context_summary: ai_context_summary || null,
                    cover_image: coverImageData,
                };

                try {
                    if (id) {
                        const updated = await api(`/projects/${id}`, {
                            method: "PUT",
                            body: payload,
                        });
                        const idx = projects.findIndex((p) => p.id === id);
                        if (idx !== -1) projects[idx] = updated;
                        showToast("Project updated");
                    } else {
                        const created = await api("/projects", {
                            method: "POST",
                            body: payload,
                        });
                        projects.unshift(created);
                        showToast("Project created");
                    }
                    renderProjects();
                    closeProjectModal();
                } catch (error) {
                    showToast(
                        error.message || "Failed to save project",
                        "error",
                    );
                } finally {
                    btn.disabled = false;
                    btn.textContent = id ? "Save Changes" : "Create Project";
                }
            }

            async function deleteProject() {
                const id = document.getElementById("project-id").value;
                if (
                    !id ||
                    !confirm(
                        "Delete this project? This action cannot be undone.",
                    )
                )
                    return;

                try {
                    await api(`/projects/${id}`, { method: "DELETE" });
                    projects = projects.filter((p) => p.id !== id);
                    renderProjects();
                    closeProjectModal();
                    showToast("Project deleted");
                } catch (error) {
                    showToast(
                        error.message || "Failed to delete project",
                        "error",
                    );
                }
            }

            // ============================================
            // EVENT LISTENERS
            // ============================================
            document
                .getElementById("project-name")
                .addEventListener("input", (e) => {
                    document.getElementById("slug-preview").textContent =
                        generateSlugPreview(e.target.value);
                });

            // Close modal on outside click
            document
                .getElementById("project-modal")
                .addEventListener("click", (e) => {
                    if (e.target.classList.contains("modal-overlay")) {
                        closeProjectModal();
                    }
                });

            // ============================================
            // INIT
            // ============================================
            window.addEventListener("DOMContentLoaded", () => {
                loadProjects();
            });
        </script>
    </body>
</html>
