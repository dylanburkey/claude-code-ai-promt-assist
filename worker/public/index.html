<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />
        <title>Semantic Prompt Workstation</title>

        <!-- PWA Settings -->
        <link rel="manifest" href="manifest.json" />
        <meta name="theme-color" content="#0a0a0f" />
        <link rel="icon" type="image/svg+xml" href="icon.svg" />

        <!-- Fonts: Space Grotesk (Modern Display) & IBM Plex Sans (Professional Body) -->
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600;700&display=swap"
            rel="stylesheet"
        />

        <!-- iOS Support -->
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta
            name="apple-mobile-web-app-status-bar-style"
            content="black-translucent"
        />
        <meta name="apple-mobile-web-app-title" content="PromptEngine" />
        <link rel="apple-touch-icon" href="icon.svg" />

        <style>
            :root {
                /* Refined Dark Palette */
                --bg-base: #0a0a0f;
                --bg-surface: #12121a;
                --bg-elevated: #1a1a24;
                --bg-hover: #22222e;

                /* Accent Colors */
                --accent-primary: #6366f1;
                --accent-primary-hover: #818cf8;
                --accent-secondary: #22d3ee;
                --accent-success: #34d399;
                --accent-warning: #fbbf24;

                /* Text Colors */
                --text-primary: #f4f4f5;
                --text-secondary: #a1a1aa;
                --text-muted: #71717a;

                /* Border Colors */
                --border-subtle: #27272a;
                --border-default: #3f3f46;

                /* Typography */
                --font-display: "Space Grotesk", system-ui, sans-serif;
                --font-body: "IBM Plex Sans", system-ui, sans-serif;
                --font-mono: "IBM Plex Mono", "SF Mono", monospace;

                /* Spacing */
                --header-height: 60px;
                --radius-sm: 6px;
                --radius-md: 8px;
                --radius-lg: 12px;

                /* Transitions */
                --transition-fast: 150ms ease;
                --transition-normal: 200ms ease;
            }

            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
                -webkit-tap-highlight-color: transparent;
            }

            body {
                background: var(--bg-base);
                color: var(--text-primary);
                font-family: var(--font-body);
                font-size: 14px;
                line-height: 1.5;
                height: 100vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }

            /* Header */
            header {
                background: var(--bg-surface);
                border-bottom: 1px solid var(--border-subtle);
                padding: 0 1.25rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                height: var(--header-height);
                flex-shrink: 0;
                z-index: 20;
            }

            .logo-section {
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            h1 {
                font-family: var(--font-display);
                font-size: 1.25rem;
                font-weight: 600;
                color: var(--text-primary);
                letter-spacing: -0.02em;
            }

            .version-badge {
                font-size: 0.65rem;
                font-weight: 600;
                color: var(--accent-primary);
                background: rgba(99, 102, 241, 0.15);
                padding: 0.2rem 0.5rem;
                border-radius: var(--radius-sm);
                letter-spacing: 0.02em;
            }

            .header-actions {
                display: flex;
                gap: 0.5rem;
            }

            /* Workspace Grid */
            .workspace {
                display: grid;
                grid-template-columns: 260px 1fr 1fr;
                height: calc(100vh - var(--header-height));
                overflow: hidden;
            }

            /* Mobile Layout */
            @media (max-width: 768px) {
                .workspace {
                    grid-template-columns: 1fr;
                    display: flex;
                    flex-direction: column;
                }
                #sidebar-panel {
                    display: none;
                    position: fixed;
                    top: var(--header-height);
                    left: 0;
                    width: 85%;
                    max-width: 320px;
                    height: calc(100% - var(--header-height));
                    z-index: 50;
                    background: var(--bg-base);
                    border-right: 1px solid var(--border-default);
                    box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
                }
                #sidebar-panel.mobile-open {
                    display: flex;
                }
                .mobile-tabs {
                    display: flex;
                    background: var(--bg-surface);
                    border-top: 1px solid var(--border-subtle);
                }
                .mobile-tab {
                    flex: 1;
                    text-align: center;
                    padding: 0.875rem;
                    color: var(--text-muted);
                    font-family: var(--font-body);
                    font-weight: 500;
                    font-size: 0.8rem;
                    transition: var(--transition-fast);
                }
                .mobile-tab.active {
                    color: var(--accent-primary);
                    background: rgba(99, 102, 241, 0.08);
                }
                .panel {
                    display: none;
                }
                .panel.active-view {
                    display: flex;
                }
            }

            @media (min-width: 769px) {
                .panel {
                    display: flex;
                }
                .mobile-tabs,
                .menu-toggle {
                    display: none;
                }
            }

            /* Panel Base */
            .panel {
                padding: 1.5rem;
                overflow-y: auto;
                border-right: 1px solid var(--border-subtle);
                display: flex;
                flex-direction: column;
                gap: 1.25rem;
                background: var(--bg-base);
            }

            .panel:last-child {
                border-right: none;
            }

            .panel-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding-bottom: 0.75rem;
                border-bottom: 1px solid var(--border-subtle);
            }

            .panel-title {
                font-family: var(--font-display);
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.08em;
                color: var(--text-muted);
            }

            /* Form Elements */
            label {
                font-family: var(--font-body);
                font-size: 0.8rem;
                font-weight: 500;
                color: var(--text-secondary);
                margin-bottom: 0.5rem;
                display: block;
            }

            .input-group {
                display: flex;
                flex-direction: column;
            }

            input,
            textarea,
            select {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                color: var(--text-primary);
                padding: 0.75rem 1rem;
                border-radius: var(--radius-md);
                width: 100%;
                font-family: var(--font-body);
                font-size: 0.875rem;
                transition: var(--transition-fast);
            }

            input::placeholder,
            textarea::placeholder {
                color: var(--text-muted);
            }

            input:focus,
            textarea:focus {
                outline: none;
                border-color: var(--accent-primary);
                background: var(--bg-elevated);
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            }

            textarea {
                resize: vertical;
                min-height: 80px;
            }

            /* Buttons */
            button {
                cursor: pointer;
                border: none;
                border-radius: var(--radius-md);
                padding: 0.625rem 1rem;
                font-family: var(--font-body);
                font-size: 0.8rem;
                font-weight: 500;
                transition: var(--transition-fast);
                display: inline-flex;
                align-items: center;
                justify-content: center;
                gap: 0.5rem;
            }

            .btn-primary {
                background: var(--accent-primary);
                color: white;
            }

            .btn-primary:hover {
                background: var(--accent-primary-hover);
                transform: translateY(-1px);
            }

            .btn-secondary {
                background: transparent;
                color: var(--text-secondary);
                border: 1px solid var(--border-default);
            }

            .btn-secondary:hover {
                border-color: var(--text-muted);
                color: var(--text-primary);
                background: var(--bg-hover);
            }

            .btn-icon {
                padding: 0.5rem;
                width: 36px;
                height: 36px;
            }

            .btn-sm {
                padding: 0.375rem 0.75rem;
                font-size: 0.75rem;
            }

            /* Agent List */
            .agent-list {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }

            .agent-card {
                background: var(--bg-surface);
                padding: 0.875rem 1rem;
                border-radius: var(--radius-md);
                border: 1px solid transparent;
                cursor: pointer;
                transition: var(--transition-fast);
            }

            .agent-card:hover {
                background: var(--bg-elevated);
                border-color: var(--border-default);
            }

            .agent-card.active {
                background: rgba(99, 102, 241, 0.1);
                border-color: var(--accent-primary);
            }

            .agent-card-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.375rem;
            }

            .agent-name {
                font-family: var(--font-display);
                font-weight: 600;
                font-size: 0.9rem;
                color: var(--text-primary);
            }

            .agent-role {
                font-size: 0.8rem;
                color: var(--text-muted);
                display: -webkit-box;
                -webkit-line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
                line-height: 1.4;
            }

            /* Current Agent Tag */
            .agent-tag {
                background: var(--bg-surface);
                border: 1px solid var(--border-subtle);
                padding: 0.875rem 1rem;
                border-radius: var(--radius-md);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .agent-tag.has-agent {
                background: rgba(99, 102, 241, 0.08);
                border-color: rgba(99, 102, 241, 0.3);
            }

            .agent-tag-name {
                font-family: var(--font-display);
                font-weight: 600;
                font-size: 0.9rem;
            }

            .agent-tag-status {
                font-size: 0.7rem;
                color: var(--text-muted);
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            /* Output Area */
            .output-area {
                background: var(--bg-surface);
                padding: 1.25rem;
                font-family: var(--font-mono);
                font-size: 0.8rem;
                line-height: 1.7;
                color: var(--accent-success);
                white-space: pre-wrap;
                flex: 1;
                border: 1px solid var(--border-subtle);
                border-radius: var(--radius-md);
                overflow-y: auto;
            }

            .output-placeholder {
                color: var(--text-muted);
            }

            /* Install Banner */
            #install-prompt {
                display: none;
                background: linear-gradient(
                    90deg,
                    var(--accent-primary),
                    #8b5cf6
                );
                color: white;
                padding: 0.75rem 1rem;
                text-align: center;
                font-family: var(--font-body);
                font-weight: 500;
                font-size: 0.85rem;
                cursor: pointer;
                transition: var(--transition-fast);
            }

            #install-prompt:hover {
                filter: brightness(1.1);
            }

            /* Modal */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(4px);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 100;
                opacity: 0;
                pointer-events: none;
                transition: opacity var(--transition-normal);
                padding: 1rem;
            }

            .modal-overlay.open {
                opacity: 1;
                pointer-events: all;
            }

            .modal {
                background: var(--bg-surface);
                padding: 1.75rem;
                border-radius: var(--radius-lg);
                width: 100%;
                max-width: 480px;
                border: 1px solid var(--border-default);
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
                display: flex;
                flex-direction: column;
                gap: 1.25rem;
                max-height: 90vh;
                overflow-y: auto;
            }

            .modal h2 {
                font-family: var(--font-display);
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--text-primary);
            }

            .modal-actions {
                display: flex;
                gap: 0.75rem;
                margin-top: 0.5rem;
                justify-content: flex-end;
            }

            .hidden-input {
                display: none;
            }

            /* Scrollbar Styling */
            ::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }

            ::-webkit-scrollbar-track {
                background: transparent;
            }

            ::-webkit-scrollbar-thumb {
                background: var(--border-default);
                border-radius: 3px;
            }

            ::-webkit-scrollbar-thumb:hover {
                background: var(--text-muted);
            }

            /* Close Sidebar Button (Mobile) */
            .close-sidebar-btn {
                margin-top: auto;
            }
        </style>
    </head>
    <body>
        <!-- Install Banner -->
        <div id="install-prompt" onclick="installPWA()">
            Install Semantic Prompt Workstation
        </div>

        <header>
            <div class="logo-section">
                <button
                    class="btn-secondary btn-icon menu-toggle"
                    onclick="toggleSidebar()"
                    aria-label="Toggle menu"
                >
                    <svg
                        width="18"
                        height="18"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M3 12h18M3 6h18M3 18h18" />
                    </svg>
                </button>
                <h1>Semantic Prompt Workstation</h1>
                <span class="version-badge">v2.1</span>
            </div>
            <div class="header-actions">
                <button
                    class="btn-secondary btn-icon"
                    onclick="document.getElementById('file-upload').click()"
                    title="Import agents"
                >
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="17 8 12 3 7 8" />
                        <line x1="12" y1="3" x2="12" y2="15" />
                    </svg>
                </button>
                <input
                    type="file"
                    id="file-upload"
                    class="hidden-input"
                    accept=".json"
                    onchange="importAgents(this)"
                />
                <button
                    class="btn-secondary btn-icon"
                    onclick="exportAgents()"
                    title="Export agents"
                >
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                </button>
            </div>
        </header>

        <div class="workspace">
            <!-- COLUMN 1: AGENTS -->
            <aside class="panel" id="sidebar-panel">
                <div class="panel-header">
                    <span class="panel-title">Agent Library</span>
                    <button
                        class="btn-secondary btn-sm"
                        onclick="openAgentModal()"
                    >
                        <svg
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                        New
                    </button>
                </div>
                <div id="agent-list" class="agent-list">
                    <!-- Agents injected here -->
                </div>
                <button
                    class="btn-secondary close-sidebar-btn menu-toggle"
                    onclick="toggleSidebar()"
                >
                    Close Menu
                </button>
            </aside>

            <!-- COLUMN 2: BUILDER -->
            <section class="panel active-view" id="view-builder">
                <div class="panel-header">
                    <span class="panel-title">Prompt Builder</span>
                </div>

                <div class="input-group">
                    <div id="current-agent-display" class="agent-tag">
                        <span class="agent-tag-name">No agent selected</span>
                        <span class="agent-tag-status">Select from left</span>
                    </div>
                </div>

                <div class="input-group">
                    <label for="task">Task Description</label>
                    <textarea
                        id="task"
                        rows="5"
                        placeholder="Describe what you want the AI to do. Be specific about the desired outcome..."
                    ></textarea>
                </div>

                <div class="input-group">
                    <label for="context">Context & Constraints</label>
                    <textarea
                        id="context"
                        rows="3"
                        placeholder="Add relevant background information, limitations, or specific requirements..."
                    ></textarea>
                </div>

                <div class="input-group">
                    <label for="format">Output Format</label>
                    <input
                        type="text"
                        id="format"
                        placeholder="e.g., Markdown, JSON, bullet points, executive summary..."
                    />
                </div>

                <button
                    class="btn-primary"
                    style="margin-top: auto"
                    onclick="generatePrompt()"
                >
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <polygon
                            points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"
                        />
                    </svg>
                    Generate Prompt
                </button>
            </section>

            <!-- COLUMN 3: OUTPUT -->
            <section class="panel" id="view-output">
                <div class="panel-header">
                    <span class="panel-title">Generated Output</span>
                    <button
                        class="btn-secondary btn-sm"
                        onclick="copyToClipboard()"
                    >
                        <svg
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <rect
                                x="9"
                                y="9"
                                width="13"
                                height="13"
                                rx="2"
                                ry="2"
                            />
                            <path
                                d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"
                            />
                        </svg>
                        Copy
                    </button>
                </div>
                <div id="output-display" class="output-area">
                    <span class="output-placeholder"
                        >Generated prompt will appear here...</span
                    >
                </div>
            </section>
        </div>

        <!-- Mobile Tabs -->
        <div class="mobile-tabs">
            <div class="mobile-tab active" onclick="switchView('builder')">
                Builder
            </div>
            <div class="mobile-tab" onclick="switchView('output')">Output</div>
        </div>

        <!-- MODAL -->
        <div id="agent-modal" class="modal-overlay">
            <div class="modal">
                <h2 id="modal-title">Create New Agent</h2>
                <input type="hidden" id="agent-id" />

                <div class="input-group">
                    <label for="agent-name">Agent Name</label>
                    <input
                        type="text"
                        id="agent-name"
                        placeholder="e.g., Senior Software Engineer"
                    />
                </div>

                <div class="input-group">
                    <label for="agent-role">System Persona</label>
                    <textarea
                        id="agent-role"
                        rows="4"
                        placeholder="Define the agent's expertise, background, and approach to tasks..."
                    ></textarea>
                </div>

                <div class="input-group">
                    <label for="agent-style">Response Style</label>
                    <input
                        type="text"
                        id="agent-style"
                        placeholder="e.g., Technical, concise, with code examples"
                    />
                </div>

                <div class="modal-actions">
                    <button
                        class="btn-secondary"
                        id="btn-delete"
                        onclick="deleteAgent()"
                        style="
                            margin-right: auto;
                            color: #ef4444;
                            border-color: #ef4444;
                        "
                    >
                        Delete
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">
                        Cancel
                    </button>
                    <button class="btn-primary" onclick="saveAgent()">
                        Save Agent
                    </button>
                </div>
            </div>
        </div>

        <script>
            // --- PWA LOGIC ---
            let deferredPrompt;

            if ("serviceWorker" in navigator) {
                window.addEventListener("load", () => {
                    navigator.serviceWorker
                        .register("./sw.js")
                        .then((reg) => console.log("Service Worker registered"))
                        .catch((err) =>
                            console.log(
                                "Service Worker registration failed",
                                err,
                            ),
                        );
                });
            }

            window.addEventListener("beforeinstallprompt", (e) => {
                e.preventDefault();
                deferredPrompt = e;
                document.getElementById("install-prompt").style.display =
                    "block";
            });

            async function installPWA() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    document.getElementById("install-prompt").style.display =
                        "none";
                }
            }

            // --- APP LOGIC ---
            let agents = [];
            let selectedAgentId = null;

            window.addEventListener("DOMContentLoaded", () => {
                loadAgents();
                if (window.innerWidth < 769) {
                    switchView("builder");
                }
            });

            function loadAgents() {
                const stored = localStorage.getItem("prompt_engine_agents");
                if (stored) {
                    agents = JSON.parse(stored);
                } else {
                    agents = [
                        {
                            id: "1",
                            name: "Senior Systems Architect",
                            role: "You are a Principal Software Architect. You design scalable, fault-tolerant distributed systems. You prioritize reliability and maintainability over clever hacks.",
                            style: "Technical, authoritative, uses diagrams and clear explanations.",
                        },
                        {
                            id: "2",
                            name: "Business Strategist",
                            role: "You are a Fortune 500 Business Strategist. You analyze market trends and internal data to provide actionable high-level advice.",
                            style: "Professional, executive summary format, ROI-focused.",
                        },
                        {
                            id: "3",
                            name: "Code Reviewer",
                            role: "You are a strict Code Reviewer. You look for bugs, security flaws, and performance bottlenecks. You follow clean code principles.",
                            style: "Bullet points, critical, direct with code corrections.",
                        },
                    ];
                    saveToStorage();
                }
                renderAgentList();
                if (agents.length > 0) selectAgent(agents[0].id);
            }

            function saveToStorage() {
                localStorage.setItem(
                    "prompt_engine_agents",
                    JSON.stringify(agents),
                );
                renderAgentList();
            }

            function renderAgentList() {
                const container = document.getElementById("agent-list");
                container.innerHTML = "";
                agents.forEach((agent) => {
                    const div = document.createElement("div");
                    div.className = `agent-card ${agent.id === selectedAgentId ? "active" : ""}`;
                    div.onclick = () => {
                        selectAgent(agent.id);
                        if (window.innerWidth < 769) toggleSidebar();
                    };
                    div.innerHTML = `
                        <div class="agent-card-header">
                            <span class="agent-name">${agent.name}</span>
                            <button class="btn-secondary btn-sm" style="padding: 4px 8px;" onclick="event.stopPropagation(); editAgent('${agent.id}')">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                        </div>
                        <span class="agent-role">${agent.role}</span>
                    `;
                    container.appendChild(div);
                });
            }

            function selectAgent(id) {
                selectedAgentId = id;
                const agent = agents.find((a) => a.id === id);
                const display = document.getElementById(
                    "current-agent-display",
                );
                if (agent) {
                    display.innerHTML = `<span class="agent-tag-name">${agent.name}</span><span class="agent-tag-status">Active</span>`;
                    display.classList.add("has-agent");
                }
                renderAgentList();
            }

            function generatePrompt() {
                const task = document.getElementById("task").value;
                const context = document.getElementById("context").value;
                const format = document.getElementById("format").value;
                const agent = agents.find((a) => a.id === selectedAgentId);

                if (!agent) {
                    alert("Please select an agent first.");
                    return;
                }
                if (!task) {
                    alert("Please enter a task description.");
                    return;
                }

                const prompt = `${agent.role}

<agent_style>
${agent.style}
</agent_style>

<context>
${context || "No additional context provided."}
</context>

<task_instruction>
${task}
</task_instruction>

<output_requirements>
${format || "Best fit."}
</output_requirements>`;

                document.getElementById("output-display").innerText = prompt;

                if (window.innerWidth < 769) {
                    switchView("output");
                }
            }

            // --- MOBILE & UTILS ---
            function toggleSidebar() {
                document
                    .getElementById("sidebar-panel")
                    .classList.toggle("mobile-open");
            }

            function switchView(viewName) {
                if (window.innerWidth >= 769) return;
                document
                    .querySelectorAll(".panel")
                    .forEach((el) => el.classList.remove("active-view"));
                document
                    .querySelectorAll(".mobile-tab")
                    .forEach((el) => el.classList.remove("active"));
                document
                    .getElementById(`view-${viewName}`)
                    .classList.add("active-view");
                const tabIndex = viewName === "builder" ? 0 : 1;
                document
                    .querySelectorAll(".mobile-tab")
                    [tabIndex].classList.add("active");
            }

            function copyToClipboard() {
                const text =
                    document.getElementById("output-display").innerText;
                if (text.includes("Generated prompt will appear here")) {
                    alert("No prompt to copy yet.");
                    return;
                }
                navigator.clipboard.writeText(text).then(() => {
                    alert("Prompt copied to clipboard!");
                });
            }

            function exportAgents() {
                const dataStr =
                    "data:text/json;charset=utf-8," +
                    encodeURIComponent(JSON.stringify(agents, null, 2));
                const downloadAnchorNode = document.createElement("a");
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute(
                    "download",
                    "prompt_agents.json",
                );
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            }

            function importAgents(input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        agents = JSON.parse(e.target.result);
                        saveToStorage();
                        alert("Agents imported successfully!");
                    } catch (err) {
                        alert("Import failed: Invalid JSON file.");
                    }
                };
                reader.readAsText(file);
            }

            // --- MODAL UTILS ---
            function openAgentModal() {
                document.getElementById("modal-title").innerText =
                    "Create New Agent";
                document.getElementById("agent-id").value = "";
                document.getElementById("agent-name").value = "";
                document.getElementById("agent-role").value = "";
                document.getElementById("agent-style").value = "";
                document.getElementById("btn-delete").style.display = "none";
                document.getElementById("agent-modal").classList.add("open");
                if (window.innerWidth < 769) toggleSidebar();
            }

            function editAgent(id) {
                const agent = agents.find((a) => a.id === id);
                if (!agent) return;
                document.getElementById("modal-title").innerText = "Edit Agent";
                document.getElementById("agent-id").value = agent.id;
                document.getElementById("agent-name").value = agent.name;
                document.getElementById("agent-role").value = agent.role;
                document.getElementById("agent-style").value = agent.style;
                document.getElementById("btn-delete").style.display = "block";
                document.getElementById("agent-modal").classList.add("open");
                if (window.innerWidth < 769) toggleSidebar();
            }

            function closeModal() {
                document.getElementById("agent-modal").classList.remove("open");
            }

            function saveAgent() {
                const id = document.getElementById("agent-id").value;
                const name = document.getElementById("agent-name").value;
                const role = document.getElementById("agent-role").value;
                const style = document.getElementById("agent-style").value;

                if (!name) {
                    alert("Please enter an agent name.");
                    return;
                }

                if (id) {
                    const idx = agents.findIndex((a) => a.id === id);
                    agents[idx] = { id, name, role, style };
                } else {
                    agents.push({
                        id: Date.now().toString(),
                        name,
                        role,
                        style,
                    });
                }
                saveToStorage();
                closeModal();
            }

            function deleteAgent() {
                const id = document.getElementById("agent-id").value;
                if (confirm("Are you sure you want to delete this agent?")) {
                    agents = agents.filter((a) => a.id !== id);
                    if (selectedAgentId === id) selectedAgentId = null;
                    saveToStorage();
                    closeModal();
                }
            }
        </script>
    </body>
</html>
